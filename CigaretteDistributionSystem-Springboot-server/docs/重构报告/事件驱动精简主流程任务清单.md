## 📋 文档目的

本文档提供在**不引入 MQ，仅使用 Spring Event** 的前提下，  
通过“事件驱动”方式**精简主流程（导入 & 一键分配）代码**的**具体任务清单**。

目标：让 `ExcelImportServiceImpl`、`DistributionCalculateServiceImpl` 等主流程类更瘦，只保留**业务用例本身**，  
把“日志、监控、统计、后置处理”等杂项统一交给事件监听器完成。

---

## 🧭 总体分阶段规划

1. **阶段一：梳理与准备**  
   - 明确哪些逻辑应留在主流程，哪些可以事件化。  
2. **阶段二：日志与监控迁移到事件监听器**  
   - 精简主流程中的“过程型日志”，统一由监听器输出。  
3. **阶段三：统计与汇总逻辑下沉**  
   - 将只用于监控/报表的统计，从主流程挪到事件监听器。  
4. **阶段四：后置处理逻辑事件化**  
   - 缓存刷新、报表/审计、补充清理等逻辑，改由批次级事件驱动。  
5. **阶段五：测试与回归**  
   - 补充集成测试，确保事件链路与主流程行为稳定。  

各阶段可以分批实施，不要求一次性完成。

---

## ✅ 阶段一：梳理与准备

- **任务 1.1：标记主流程中“应该保留”的核心逻辑**
  - **范围**
    - `DistributionCalculateServiceImpl.generateDistributionPlan(...)`
    - `ExcelImportServiceImpl.importData(...)`
  - **检查内容**
    - 哪些代码是“真正的业务决策/算法/写回”（必须保留在主流程）。  
    - 哪些代码仅是“打印日志”“记录耗时”“统计结果供报表/监控使用”。  
  - **完成标准**
    - 在代码或评论中，用 TODO / 注释标出“候选可事件化逻辑”，不做行为更改。

- **任务 1.2：确认事件模型是否满足精简需求**
  - **检查事件类**
    - `DistributionPlanGenerationStartedEvent`
    - `DistributionPlanGenerationCompletedEvent`
    - `ExistingDataDeletedEvent`
    - `DataImportStartedEvent`
    - `DataImportCompletedEvent`
    - `DataImportFailedEvent`
  - **确认点**
    - 是否都包含 `year` / `month` / `weekSeq` / `batchId`。  
    - 是否预留了足够字段承载后续需要的统计信息（如总条数、成功条数、错误信息等）。  
  - **完成标准**
    - 如有缺失字段，先在事件类中补齐（不改动业务逻辑，仅增加字段与构造赋值）。  

---

## ✅ 阶段二：日志与监控迁移到事件监听器

### 2.1 导入流程日志精简

- **任务 2.1.1：分析 `ExcelImportServiceImpl.importData` 中的日志**
  - 分类：
    - **必须保留**：入参概要日志、异常 `log.error`。  
    - **可迁移**：开始导入、导入成功/失败、耗时相关日志。  
  - 完成标准：
    - 标记所有可迁移日志位置。

- **任务 2.1.2：在 `DataImportEventHandler` 中补充结构化日志**
  - 文件：`application/event/handler/DataImportEventHandler.java`
  - 操作：
    - 在 `handleImportStarted`、`handleImportCompleted`、`handleImportFailed` 中：
      - 日志中统一输出：`batchId`、`year`、`month`、`weekSeq`、成功标记、错误信息等。  
      - 尽量使用统一格式（例如 key=value 或 JSON 风格字符串）。
  - 完成标准：
    - 监听器中已覆盖导入流程所有关键节点日志。  

- **任务 2.1.3：删除/精简导入主流程中的“过程型日志”**
  - 删除/收缩以下类型日志：
    - “开始导入…”、“导入完成…”、“导入失败：xxx” 等流程描述性日志。  
  - 保留：
    - 必要的输入参数日志（尤其是批次、文件名）  
    - 异常 catch 中的 `log.error("导入失败", e)`。  
  - 完成标准：
    - `ExcelImportServiceImpl.importData` 的日志行数明显减少，但关键异常信息依然完备。

### 2.2 分配流程日志精简

- **任务 2.2.1：分析 `DistributionCalculateServiceImpl.generateDistributionPlan` 中的日志**
  - 分类：
    - 必须保留：  
      - 入参概要（批次、部分关键参数）。  
      - 异常 `log.error`（包括统计已生成记录数失败时的告警）。  
    - 可迁移：
      - “开始生成一键分配方案…”  
      - “已删除旧数据…”  
      - “生成完成，成功/失败统计…” 等流程与统计日志。

- **任务 2.2.2：在 `DistributionPlanMonitorHandler` 中补充结构化日志**
  - 文件：`application/event/handler/DistributionPlanMonitorHandler.java`
  - 操作：
    - 在 `handlePlanStarted` / `handleDataDeleted` / `handlePlanCompleted` 中：
      - 日志中统一输出：`batchId`、`year`、`month`、`weekSeq`、删除数量、总数/成功数/失败数、耗时。  
  - 完成标准：
    - 监听器中能完整覆盖“一键分配”的监控、统计日志。

- **任务 2.2.3：删除/精简分配主流程中的“过程型日志”**
  - 删除/合并：
    - 仅用于说明“当前走到哪一步”的 info 日志。  
    - 为了监控而单独打印的统计信息（改由事件监听器承担）。  
  - 保留：
    - 抛异常前的重要 error 日志。  
  - 完成标准：
    - `generateDistributionPlan` 方法的日志代码行数下降，逻辑更清晰，以业务分支为主。  

---

## ✅ 阶段三：统计与汇总逻辑下沉

### 3.1 导入统计下沉

- **任务 3.1.1：梳理导入统计项**
  - 在 `importData` 及其私有方法中，梳理：
    - 用于接口返回的必要统计（如插入条数、处理条数）。  
    - 仅用于日志/监控的统计（如某些中间步骤计数）。  

- **任务 3.1.2：为导入事件对象补充统计字段（如有需要）**
  - 根据上一步梳理结果，为 `DataImportCompletedEvent` 增加必要字段（已存在的可复用）。  
  - 保证不会改变现有对外响应结构。  

- **任务 3.1.3：在 `DataImportEventHandler` 中使用这些统计字段**
  - 将仅用于监控的统计信息通过事件在监听器中记录。  
  - 如果未来需要入库或上报监控系统，可在此预留调用位。  

### 3.2 分配统计下沉

- **任务 3.2.1：梳理分配统计项**
  - 在 `generateDistributionPlan` 中梳理：
    - 对响应 DTO 必须存在的字段（成功卷烟种类数、总种类数、生成记录数等）。  
    - 仅用于监控/分析的统计字段。  

- **任务 3.2.2：扩充分配完成事件字段（如有必要）**
  - 确保 `DistributionPlanGenerationCompletedEvent` 已能承载：  
    - 总卷烟数、成功卷烟数、失败卷烟数、处理条数、耗时等。  

- **任务 3.2.3：在监听器中统一输出这些统计**
  - 将监控相关统计统一放到 `handlePlanCompleted` 中输出。  
  - 必要时预留 metrics 采集调用。  

---

## ✅ 阶段四：后置处理逻辑事件化（保持同步写回策略不变）

> 注意：不再拆分“单支卷烟写回”的异步逻辑，避免重新引入死锁风险。  
> 仅对**批次级后置处理**进行事件化。

- **任务 4.1：梳理导入后的后置处理**
  - 例如：缓存刷新、映射表刷新、审计记录等。  
  - 判断哪些可以延后执行且不影响主链路事务结果。  

- **任务 4.2：在导入完成监听器中承接这些后置处理**
  - 在 `DataImportEventHandler.handleImportCompleted` 中：  
    - 对不要求与主事务强一致的操作，放到监听器里处理。  
    - 如需要独立事务，可在方法上加 `@Transactional(propagation = REQUIRES_NEW)`。  

- **任务 4.3：梳理分配完成后的后置处理**
  - 例如：生成报表快照、记录审计、通知其他系统的“预留钩子”（当前先仅日志）。  

- **任务 4.4：在分配完成监听器中承接后置处理**
  - 在 `DistributionPlanMonitorHandler` 或单独新增处理器中：  
    - 利用 `DistributionPlanGenerationCompletedEvent`，做批次级的后置动作。  

---

## ✅ 阶段五：测试与回归

- **任务 5.1：为导入流程增加事件链路集成测试**
  - 测试点：
    - 调用导入接口/服务时，是否按预期发布 `DataImportStartedEvent`、`DataImportCompletedEvent` / `DataImportFailedEvent`。  
  - 实现方式：
    - 使用 Spring 测试上下文注入一个测试专用的 `ApplicationListener` 或使用 `@RecordApplicationEvents`（如可用）。  

- **任务 5.2：为分配流程增加事件链路集成测试**
  - 测试点：
    - 调用“一键生成分配方案”时，是否发布开始/删除旧数据/完成事件，字段是否正确（year/month/weekSeq/batchId/统计数据）。  

- **任务 5.3：并发与死锁回归用例**
  - 重现关键场景（多批次并发分配、导入与分配交错执行）。  
  - 确认：  
    - 主流程保持同步写回，不再通过异步事件写库。  
    - 未出现新的 `DeadlockLoserDataAccessException`。  

---

## 📌 小结与实施建议

- 建议实施顺序：
  1. **阶段一 + 阶段二**：先迁移日志与监控，立刻瘦身主流程，可见度最高。  
  2. **阶段三**：逐步下沉统计逻辑，在不影响响应返回的前提下减少主流程负担。  
  3. **阶段四**：对后置处理进行事件化，进一步减少主流程“拖尾”代码。  
  4. **阶段五**：补齐测试与并发回归，确保重构安全。  
- 全程保持：  
  - 仅使用 Spring Event，不引入 MQ；  
  - 核心写回逻辑保持同步；  
  - 优先删除/迁移“过程型日志”和“监控统计”，从而最大化主流程代码的精简效果。  


