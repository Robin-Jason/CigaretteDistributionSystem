# 动态标签导入处理逻辑说明

## 一、当前实现逻辑

### 1. 导入模式：覆盖模式
- **每次导入都会重建表**（`dropTable()` + `createTable()`）
- **会清空所有之前的数据**
- 然后插入新导入的数据

### 2. Excel格式要求
- **Excel中不应包含 `DYNAMIC_TAGS` 列**
- 动态标签应通过**中文列名**提供（如"优质客户"、"重点区域"等）
- 如果Excel中包含 `DYNAMIC_TAGS` 列，系统会自动忽略并记录警告日志

### 2. 动态标签处理逻辑

#### 场景1：Excel中有"优质客户"和"重点区域"列

**处理流程**：
1. 重建表时：不会创建"优质客户"和"重点区域"这两个数据库列
2. 插入数据时：
   - 读取Excel中每行的"优质客户"和"重点区域"值
   - 将这些值写入 `DYNAMIC_TAGS` JSON字段
   - 最终结果：`{"优质客户": "是", "重点区域": "重点区域A"}`

#### 场景2：Excel中有"优质客户"列，且Excel中还有DYNAMIC_TAGS列（不推荐）

**处理流程**：
1. **系统会自动忽略Excel中的 `DYNAMIC_TAGS` 列**，并记录警告日志
2. 只处理Excel中的中文列名（如"优质客户"）
3. 将中文列名的值写入 `DYNAMIC_TAGS` JSON字段

**示例**：
- Excel中 `DYNAMIC_TAGS` = `{"重点区域": "重点区域A"}` （会被忽略）
- Excel中 `优质客户` = `"是"`
- 最终结果：`{"优质客户": "是"}`
- ⚠️ 注意：如果Excel中只有 `DYNAMIC_TAGS` 列而没有中文列名，`重点区域` 标签会丢失

#### 场景3：Excel中只有"优质客户"列，没有"重点区域"列

**处理流程**：
1. 由于是覆盖模式（重建表），之前导入的"重点区域"标签会丢失
2. 只会保留Excel中本次导入的"优质客户"标签
3. 最终结果：`{"优质客户": "是"}`

## 二、重要说明

### ⚠️ 当前实现的限制

1. **覆盖模式**：每次导入都会重建表，**不会保留之前导入的数据**
2. **不会合并历史数据**：如果上一次导入有"优质客户"，这次导入有"优质客户"和"重点区域"，**不会自动合并**
3. **Excel必须包含所有需要的标签**：如果希望保留某个标签，必须在Excel中包含该列

### ✅ 当前实现的优势

1. **简单直接**：每次导入都是完整的数据快照
2. **数据一致性**：不会出现新旧数据混合的问题
3. **易于理解**：导入什么数据，数据库就是什么数据

## 三、处理逻辑详解

### `enrichDynamicTags` 方法逻辑

```java
// 1. 忽略Excel中的DYNAMIC_TAGS列（如果存在）
if (row中有DYNAMIC_TAGS字段) {
    记录警告日志，移除该字段
}

// 2. 创建新的动态标签Map（不从Excel读取）
Map<String, Object> dynamicTags = new HashMap<>();

// 3. 遍历Excel中的所有列
for (Excel中的每一列) {
    if (列名是中文 && 不是固定字段 && 不是DYNAMIC_TAGS && 值不为空) {
        // 将列的值写入dynamicTags
        dynamicTags.put(列名, 列值);
    }
}

// 4. 将dynamicTags序列化为JSON字符串，写回row
row.put("DYNAMIC_TAGS", JSON.stringify(dynamicTags));
```

### 关键点

1. **Excel格式要求**：Excel中**不应包含 `DYNAMIC_TAGS` 列**，如果存在会被自动忽略
2. **动态标签来源**：动态标签只能通过**中文列名**提供（如"优质客户"、"重点区域"等）
3. **空值处理**：空值和空字符串不会写入JSON字段
4. **覆盖模式**：每次导入都会重建表，不会保留之前的数据

## 四、示例场景

### 场景：上一次导入有"优质客户"，这次导入有"优质客户"和"重点区域"

**情况1：Excel中只有"优质客户"和"重点区域"列**
- 结果：`{"优质客户": "是", "重点区域": "重点区域A"}`
- 说明：两个标签都会写入JSON字段

**情况2：Excel中有"优质客户"和"重点区域"列，且Excel中还有DYNAMIC_TAGS列（不推荐）**
- Excel中 `DYNAMIC_TAGS` = `{"其他标签": "值"}` （会被忽略）
- Excel中 `优质客户` = `"是"`
- Excel中 `重点区域` = `"重点区域A"`
- 结果：`{"优质客户": "是", "重点区域": "重点区域A"}`
- 说明：Excel中的 `DYNAMIC_TAGS` 列会被忽略，只处理中文列名

**情况3：Excel中只有"重点区域"列（没有"优质客户"列）**
- 结果：`{"重点区域": "重点区域A"}`
- 说明：由于是覆盖模式，之前导入的"优质客户"标签会丢失

## 五、Excel格式规范

### 正确的Excel格式
- ✅ 包含固定字段列（如 `CUST_CODE`、`GRADE` 等）
- ✅ 包含动态标签列（中文列名，如"优质客户"、"重点区域"等）
- ❌ **不应包含 `DYNAMIC_TAGS` 列**

### 示例
```
CUST_CODE | GRADE | 优质客户 | 重点区域
----------|-------|---------|----------
001       | D10   | 是      | 重点区域A
002       | D15   | 否      | 重点区域B
```

## 六、建议

如果需要保留历史标签数据，可以考虑：

1. **在Excel中包含所有需要的标签列**：即使值不变，也要包含该列
2. **修改为更新模式**：改为使用UPDATE而不是重建表（需要较大改动）

---

**最后更新**: 2025-12-20

