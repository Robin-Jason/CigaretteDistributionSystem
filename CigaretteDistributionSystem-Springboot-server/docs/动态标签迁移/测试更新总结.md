# 测试更新总结

## 一、更新日期
2025-12-20

## 二、更新内容

根据新的业务规则，更新了所有相关测试代码：

### 业务规则回顾
1. **固定标签字段**（如 `QUALITY_DATA_SHARE`）：继续使用固定字段存储和查询，不写入JSON
2. **动态标签字段**：以JSON格式存放，使用中文键值对，如 `{"优质客户":"是"}`

## 三、测试文件更新

### 1. DynamicTagsDualWriteTest ✅
- **文件**: `src/test/java/org/example/shared/util/DynamicTagsDualWriteTest.java`
- **更新内容**:
  - 重命名测试方法：`should_write_both_fixed_field_and_json_field_on_import` → `should_handle_fixed_and_dynamic_tags_on_import`
  - 移除QUALITY_DATA_SHARE写入JSON的验证逻辑
  - 添加动态标签（中文键值对）的测试用例
  - 验证固定标签字段不写入JSON字段（业务规则）
- **测试覆盖**:
  - ✅ 固定标签字段（QUALITY_DATA_SHARE）只写入固定字段
  - ✅ 动态标签（中文键值对）正确写入JSON字段
  - ✅ 固定标签字段和动态标签可以同时存在

### 2. DynamicTagsJsonFieldTest ✅
- **文件**: `src/test/java/org/example/infrastructure/persistence/DynamicTagsJsonFieldTest.java`
- **更新内容**:
  - 将所有测试用例中的键名从英文改为中文（符合业务规则）
  - 例如：`"premium_customer"` → `"优质客户"`
  - 例如：`"critical_time_area"` → `"重点区域"`
- **测试覆盖**:
  - ✅ JSON字段的写入和读取（中文键名）
  - ✅ 空JSON字段的处理
  - ✅ JSON字段的更新
  - ✅ SQL直接查询JSON字段（中文键名）
  - ✅ MySQL JSON函数查询（中文键名）

### 3. TagQueryTest ✅（新增）
- **文件**: `src/test/java/org/example/shared/util/TagQueryTest.java`
- **功能**:
  - 测试固定标签字段查询（QUALITY_DATA_SHARE）
  - 测试动态标签字段查询（JSON字段，中文键名）
  - 测试 `statGradesPartition` 查询逻辑（固定标签字段）
  - 测试 `statGradesPartition` 查询逻辑（动态标签字段）
- **测试覆盖**:
  - ✅ `should_query_fixed_tag_field`: 验证固定标签字段的查询
  - ✅ `should_query_dynamic_tag_field`: 验证动态标签字段的查询（中文键名）
  - ✅ `should_query_stat_grades_partition_with_fixed_tag`: 验证statGradesPartition对固定标签字段的查询
  - ✅ `should_query_stat_grades_partition_with_dynamic_tag`: 验证statGradesPartition对动态标签字段的查询

## 四、测试验证要点

### 1. 固定标签字段验证
- ✅ QUALITY_DATA_SHARE只存储在固定字段中
- ✅ QUALITY_DATA_SHARE不写入JSON字段
- ✅ 可以通过固定字段直接查询
- ✅ 可以通过DynamicTagHelper.getFixedTagValue()读取

### 2. 动态标签字段验证
- ✅ 动态标签使用中文键值对格式
- ✅ 动态标签存储在JSON字段中
- ✅ 可以通过JSON字段查询（使用中文键名）
- ✅ 可以通过DynamicTagHelper.getDynamicTagValue()读取
- ✅ MySQL JSON函数支持中文键名查询

### 3. 查询逻辑验证
- ✅ statGradesPartition正确区分固定标签字段和动态标签字段
- ✅ 固定标签字段使用固定字段查询
- ✅ 动态标签字段使用JSON函数查询（支持中文键名）

## 五、测试执行

### 运行所有标签相关测试
```bash
mvn test -Dtest='*Tag*Test'
```

### 运行特定测试
```bash
# 固定标签字段查询测试
mvn test -Dtest='TagQueryTest#should_query_fixed_tag_field'

# 动态标签字段查询测试
mvn test -Dtest='TagQueryTest#should_query_dynamic_tag_field'

# statGradesPartition查询测试
mvn test -Dtest='TagQueryTest#should_query_stat_grades_partition*'
```

## 六、注意事项

1. **测试数据清理**
   - 所有测试都使用 `@Transactional` 注解，测试结束后自动回滚
   - 测试数据不会污染数据库

2. **中文键名支持**
   - 确保MySQL字符集支持中文（UTF-8）
   - JSON函数查询时使用中文键名，如 `JSON_EXTRACT(DYNAMIC_TAGS, '$.优质客户')`

3. **向后兼容**
   - 测试验证了固定标签字段的向后兼容性
   - 现有使用固定标签字段的代码无需修改

---

**更新日期**: 2025-12-20  
**状态**: 已完成

