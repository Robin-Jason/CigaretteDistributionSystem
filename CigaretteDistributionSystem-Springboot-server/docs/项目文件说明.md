## 一、API 层总体说明（对外 HTTP 接口层）

本节仅说明 `api` 层及其下属子层（`controller` / `converter` / `vo.request` / `vo.response`）的结构与作用，方便新同学快速理解“接口长什么样、数据如何进出系统”。  
后续 `application` / `domain` / `infrastructure` 等层将在你确认后按相同风格继续补充。

### 1.1 API 层结构概览

API 层物理路径：`src/main/java/org/example/api/web`

#### 1.1.1 子层职责总表

| 子层（包名）                                | 角色定位                         | 说明                                                         |
|---------------------------------------------|----------------------------------|--------------------------------------------------------------|
| `controller` (`api/web/controller`)         | HTTP 接口入口层                 | 定义 REST 接口，处理请求/响应的最外层，不包含业务逻辑       |
| `converter` (`api/web/converter`)           | VO 与 DTO 之间的转换适配层      | 负责 API 层 VO 与 Application 层 DTO 的双向转换              |
| `vo.request` (`api/web/vo/request`)         | 前端请求对象（Request VO）      | 描述前端传入参数结构，带基础校验注解，用于接收 HTTP Body     |
| `vo.response` (`api/web/vo/response`)       | 前端响应对象（Response VO）     | 描述返回给前端的结构，如列表、分页、结果明细等               |

---

### 1.2 `controller` 子层：各接口控制器说明

物理路径：`src/main/java/org/example/api/web/controller`

| 文件名                                | 职责定位                           | 主要功能简述                                                                 |
|---------------------------------------|------------------------------------|------------------------------------------------------------------------------|
| `DistributionCalculateController.java`| 分配计算接口控制器                 | 提供分配计算相关的4个核心接口：<br/>1. 一键生成分配方案（标准分配+价位段分配统一处理）<br/>2. 计算总实际投放量<br/>3. 调整卷烟投放策略<br/>4. 获取可用投放区域列表 |
| `ExcelImportController.java`          | Excel 导入接口控制器               | 提供2个独立的导入接口：<br/>1. 导入客户基础信息表（全量覆盖）<br/>2. 导入卷烟投放基础信息表（分区覆盖+业务校验） |
| `PredictionController.java`           | 预测数据查询与维护控制器           | 提供预测数据的完整CRUD接口：<br/>1. 查询预测数据/价位段预测数据<br/>2. 懒加载查询聚合编码表达式<br/>3. 新增投放区域分配记录<br/>4. 删除特定区域/整个卷烟分配记录<br/>5. 修改区域档位值 |
| `DeliveryCombinationRegionController.java` | 投放组合与区域映射查询控制器   | 查询本次分配包含的所有投放组合及其对应的区域全集，用于统计分析 |
| `PriceBandOrderLimitController.java`  | 价位段订购量上限查询控制器         | 根据价位段分配结果计算各价位段各档位的订购量上限 |

> 约束：`controller` 仅做参数接收、日志记录、调用 Application 层服务和返回统一响应（`ApiResponseVo<T>`），不承载业务规则和数据访问。所有接口均启用 CORS 跨域支持（`@CrossOrigin(origins = "*")`）。

---

### 1.3 `converter` 子层：VO/DTO 转换器说明

物理路径：`src/main/java/org/example/api/web/converter`

| 文件名                                   | 职责定位                      | 主要功能简述                                                                                 |
|------------------------------------------|-------------------------------|----------------------------------------------------------------------------------------------|
| `DistributionCalculateConverter.java`    | 分配计算 VO/DTO 转换器       | 在“一键生成分配方案 / 汇总实际投放量”场景下，在请求/响应 VO 与应用层 DTO 之间进行结构映射     |
| `ExcelImportConverter.java`              | Excel 导入 VO/DTO 转换器     | 将前端上传导入相关的 VO 转为应用层导入 DTO，并将导入结果 DTO 转换为返回给前端的 VO          |
| `PredictionQueryConverter.java`          | 预测查询 VO/DTO 转换器       | 将预测数据查询的原始 Map/List 结果组装为结构化的响应 VO，便于前端渲染                       |

> 约束：`converter` 只做字段/结构转换，不做业务判断和数据库访问，保证 Controller 保持瘦而清晰。

---

### 1.4 `vo.request` 子层：请求 VO 说明

物理路径：`src/main/java/org/example/api/web/vo/request`

> 下列表格侧重描述“这个请求体大概在干什么”，具体字段含义可在代码中结合注释/校验注解查看。

| 文件名                                      | 使用场景                         | 主要功能简述                                                                                 |
|---------------------------------------------|----------------------------------|----------------------------------------------------------------------------------------------|
| `GenerateDistributionPlanRequestVo.java`    | 一键生成分配方案                 | 承载生成分配方案所需的参数，例如年份、月份、周序号以及可选的市场类型比例等                  |
| `DataImportRequestVo.java`                  | Excel 数据导入                   | 描述导入请求的基本信息（批次、文件标识、导入类型等），由导入 Controller 使用                 |
| `PredictionQueryRequestVo.java`             | 预测数据查询（若封装为 Body）    | 用于封装查询预测分区或价位段数据的条件（时间、分页等），与 `PredictionQueryController` 对应  |

> 提示：项目中部分查询直接使用 `@RequestParam` 承载简单条件，未单独定义 Request VO，这些参数定义可以在对应 Controller 方法签名中查看。

---

### 1.5 `vo.response` 子层：响应 VO 说明

物理路径：`src/main/java/org/example/api/web/vo/response`

| 文件名                                         | 使用场景                               | 主要功能简述                                                                                     |
|------------------------------------------------|----------------------------------------|--------------------------------------------------------------------------------------------------|
| `ApiResponseVo.java`                           | 所有接口通用的最外层响应包装           | 统一封装 `success` / `code` / `message` / `data` 等字段，作为所有业务响应体的顶层结构           |
| `GenerateDistributionPlanResponseVo.java`      | 一键生成分配方案接口返回               | 描述生成分配方案后的结果摘要，如成功标记、处理条数、异常说明等                                 |
| `TotalActualDeliveryResponseVo.java`           | 总实际投放量汇总接口返回               | 承载指定分区（year/month/weekSeq）内的总实际投放量统计结果，用于对账/看板                      |
| `PredictionQueryResponseVo.java`               | 预测数据查询接口返回                   | 承载预测分区或价位段预测数据的明细列表/表格结构，方便前端直接渲染                               |
| `DataImportResponseVo.java`                    | Excel 数据导入接口返回                 | 承载导入操作的结果信息，包括成功/失败状态、处理条数、错误详情等                                 |

> 约束：`vo.response` 不直接暴露数据库结构，而是面向前端展示需求进行裁剪与整理，保持前后端解耦。

---

## 二、Application 层总体说明（用例编排与应用服务层）

Application 层主要负责“一个业务用例从入口到落地”的编排与协调：  
接收 API 层请求，调用领域服务、仓储、基础设施，组织完整流程，同时屏蔽下层细节。

物理路径：`src/main/java/org/example/application`

### 2.1 Application 层子层职责总表

| 子层（包名）                                  | 角色定位                               | 说明                                                                                  |
|-----------------------------------------------|----------------------------------------|---------------------------------------------------------------------------------------|
| `facade` (`application/facade`)               | 用例级门面（Facade）                   | 为复杂用例提供统一入口，如分配策略执行管理器，对上屏蔽复杂编排细节                   |
| `orchestrator.strategy`                       | 策略编排器（组合 -> 策略）             | 将投放组合/标签等高层信息转为“策略上下文”，决定调用哪类算法/规则                     |
| `orchestrator.allocation`                     | 算法分配编排器 + 算法引擎              | 负责从预投放数据/矩阵出发，组装请求并调用分配策略管理器/算法引擎，完成分配矩阵计算   |
| `service.calculate` / `impl`                  | 分配计算应用服务                       | 封装“一键生成分配方案、写回预测表、统计总实际投放量”等用例逻辑                       |
| `service.importing` / `impl`                  | 导入应用服务                           | 封装 Excel 导入用例的编排逻辑（解析、校验、落库、触发事件）                           |
| `service.coordinator` / `impl`                | 协作器型应用服务                       | 封装双周上浮、区域客户统计、标签抽取、价位段候选查询等跨多子域/多步骤的协作流程       |
| `service.encode` / `impl`                     | 编码与聚合懒加载应用服务               | 封装单区域编码与多区域聚合懒加载的对前端友好的应用接口                               |
| `service.query` / `impl`                      | 查询应用服务                           | 封装面向前端的复杂查询（包含跨表、聚合、分页等），对上提供稳定的查询接口              |
| `service.writeback` / `impl`                  | 分配结果写回服务                       | 封装分配矩阵写回预测表的逻辑，支持标准分配和价位段分配两种写回策略                   |
| `dto` (`application/dto`)                     | 应用层数据传输对象（DTO）             | 在 Application 内部和 API 层之间传递结构化的数据                                       |
| `converter` (`application/converter`)         | 应用内部数据转换器                     | 在 DTO、领域对象、PO 之间进行结构转换                                                 |
| `event.handler` (`application/event/handler`) | 应用层事件处理器（Spring Event Handler）| 响应领域/应用事件，如导入完成、分配生成完成等，负责统计/监控/后置处理                 |

---

### 2.2 `facade` 子层：用例门面说明

物理路径：`src/main/java/org/example/application/facade`

| 文件名                               | 职责定位                     | 主要功能简述                                                                                                 |
|--------------------------------------|------------------------------|----------------------------------------------------------------------------------------------------------------|
| `DistributionStrategyManager.java`   | 分配策略管理门面接口        | 定义“执行分配策略”的业务入口接口，对上屏蔽策略编排实现细节                                                   |
| `DefaultDistributionStrategyManager.java` | 分配策略管理门面默认实现 | 接收业务语义的 `DistributionStrategyCommand`，在 Facade 内完成基础校验、默认值处理和 Command→`StrategyExecutionRequest` 的转换，然后委托 `StrategyOrchestrator` 执行策略 |
| `DistributionStrategyCommand.java`   | 分配策略执行命令 DTO        | 用业务语言描述一次分配策略执行所需的入参（投放组合、批次、目标量、附加参数、档位范围等），供上游调用方构造     |

> 提示：Facade 负责“对上统一接口 + 校验/默认值 + 请求映射”，具体算法选择/矩阵处理仍由下游 orchestrator 和 domain service 完成。

---

### 2.3 `orchestrator.strategy` 子层：策略编排说明

物理路径：`src/main/java/org/example/application/orchestrator/strategy`

| 文件名                              | 职责定位                          | 主要功能简述                                                                                               |
|-------------------------------------|-----------------------------------|------------------------------------------------------------------------------------------------------------|
| `StrategyOrchestrator.java`        | 策略编排器                        | 基于投放方式、扩展投放方式、标签等信息，组装 `StrategyContext` 并调用 `DistributionAlgorithmEngine` 执行 |
| `StrategyContext.java`             | 策略执行上下文                    | 承载本次分配所需的目标量、客户矩阵、区域列表等上下文信息                                                  |
| `StrategyContextBuilder.java`      | 策略上下文构建器                  | 提供流式 API 构建 `StrategyContext`，简化上下文对象的创建过程                                             |
| `StrategyExecutionRequest.java`    | 策略执行请求 DTO                  | 描述策略执行时的输入参数（投放组合、时间、标签、附加信息等），由 orchestrator/allocation 进行填充         |
| `StrategyExecutionResult.java`     | 策略执行结果模型                  | 封装策略执行后的分配矩阵、客户矩阵、目标区域列表等结果，同时标记成功/失败与原因                          |

---

### 2.4 `orchestrator.allocation` 子层：算法分配编排与算法引擎

物理路径：`src/main/java/org/example/application/orchestrator/allocation`

| 文件名                                   | 职责定位                          | 主要功能简述                                                                                                   |
|------------------------------------------|-----------------------------------|----------------------------------------------------------------------------------------------------------------|
| `DistributionAllocationOrchestrator.java`| 分配算法编排器                    | 负责从预投放数据/组合信息出发，组装业务语义的 `DistributionStrategyCommand`，调用 `DistributionStrategyManager` 触发分配   |
| `DistributionAlgorithmEngine.java`       | 分配算法引擎（选择 + 执行）       | 基于区域集合/比例/分组信息选择 SINGLE_LEVEL / COLUMN_WISE / GROUP_SPLITTING，并调用 domain 算法服务执行       |
| `AlgorithmServiceConfiguration.java`     | 算法服务配置类                    | 通过 Spring Bean 配置将领域算法服务（SingleLevel、ColumnWise、GroupSplitting）注册到容器，供 AlgorithmEngine 依赖注入使用 |
| `AllocationCalculationResult.java`       | 分配结果封装类                    | 封装分配矩阵、客户矩阵、目标区域列表等信息，供后续写回/统计使用                                             |
| `RegionCustomerMatrix.java`              | 区域客户矩阵模型                  | 描述区域与 30 档位客户数的矩阵结构，是算法引擎与上游数据之间的桥接模型                                       |
| `provider/GroupRatioProvider.java`       | 分组比例提供接口                  | 抽象化"如何根据场景计算分组比例"，例如城网/农网比例、诚信互助小组比例等                                     |
| `provider/impl/MarketTypeRatioProvider.java` | 市场类型分组比例提供实现       | 按城网/农网等市场类型计算分组比例，供 GROUP_SPLITTING 算法使用                                               |
| `provider/impl/IntegrityGroupRatioProvider.java` | 诚信互助小组分组比例实现     | 按诚信互助小组配置计算分组比例，支持大量分组的拆分分配                                                       |

> 提示：`DistributionAlgorithmEngine` 已将原基础设施层算法的关键日志上移，成为运维排查的主观测点。

---

### 2.5 `service.calculate` / `impl` 子层：分配计算应用服务

物理路径：`src/main/java/org/example/application/service/calculate`

| 文件名                                        | 职责定位                          | 主要功能简述                                                                                       |
|-----------------------------------------------|-----------------------------------|----------------------------------------------------------------------------------------------------|
| `UnifiedAllocationService.java`               | 统一分配服务接口                  | 定义"一键生成分配方案"的统一入口接口                                                              |
| `impl/UnifiedAllocationServiceImpl.java`      | 统一分配服务实现                  | 查询 info 表获取所有待分配卷烟，按 `delivery_method` 自动分流为标准分配和价位段分配，分别调用对应服务处理，最后合并结果返回 |
| `StandardAllocationService.java`              | 标准分配服务接口                  | 定义标准分配（按档位投放、按档位扩展投放）的服务接口                                              |
| `impl/StandardAllocationServiceImpl.java`     | 标准分配服务实现                  | 处理标准分配类型的卷烟，协调客户矩阵构建、算法选择、分配结果写回等流程，支持计算总实际投放量     |
| `PriceBandAllocationService.java`             | 价位段自选投放分配服务接口        | 定义按价位段自选投放（全市默认策略）的完整分配流程                                                |
| `impl/PriceBandAllocationServiceImpl.java`    | 价位段自选投放分配服务实现        | 查询价位段候选卷烟、执行初分配、价位段分组截断与微调、写回 prediction_price 分区表                |

---

### 2.6 `service.importing` / `impl` 子层：导入应用服务

物理路径：`src/main/java/org/example/application/service/importing`

| 文件名                                  | 职责定位                         | 主要功能简述                                                                                                   |
|-----------------------------------------|----------------------------------|----------------------------------------------------------------------------------------------------------------|
| `ExcelImportService.java`               | Excel 导入应用服务接口           | 定义导入用例：接收导入请求，触发解析/校验/落库/事件通知                                                        |
| `impl/ExcelImportServiceImpl.java`      | Excel 导入应用服务实现           | 负责编排整体导入流程：调用解析/表管理/写入组件，并在写库前统一调用业务校验器 `CigaretteImportValidator`       |
| `CigaretteImportValidator.java`         | 卷烟投放导入业务校验接口         | 定义导入卷烟投放基础信息时需要执行的批次级业务校验能力（全市占比、货源属性 + 投放方式 + 标签合法性等）        |
| `impl/CigaretteImportValidatorImpl.java`| 卷烟投放导入业务校验实现         | 基于导入校验配置和领域规则实现具体校验逻辑，发现问题时通过抛出异常驱动导入失败，并为前端提供可读的错误信息    |

---

### 2.7 `service.coordinator` / `impl` 子层：协作型应用服务

物理路径：`src/main/java/org/example/application/service/coordinator`

| 文件名                                                  | 职责定位                         | 主要功能简述                                                                                         |
|---------------------------------------------------------|----------------------------------|------------------------------------------------------------------------------------------------------|
| `AlgorithmServiceConfiguration.java`                    | 算法服务配置类                   | 通过 Spring Bean 配置将领域算法服务（SingleLevel、ColumnWise、GroupSplitting）注册到容器，供 AllocationAlgorithmSelector 依赖注入使用 |
| `AllocationAlgorithmSelector.java`                      | 分配算法选择器                   | 根据区域数、分组比例等信息选择合适的分配算法（SINGLE_LEVEL / COLUMN_WISE / GROUP_SPLITTING），调用领域算法服务执行分配，记录算法执行日志 |
| `CustomerMatrixBuilder.java`                            | 客户矩阵构建器                   | 从 `region_customer_statistics` 表构建区域客户矩阵（RegionCustomerMatrix），支持双周上浮处理 |
| `BiWeeklyVisitBoostService.java`                        | 双周上浮协作服务接口             | 定义与双周拜访相关的上浮规则执行用例                                                                 |
| `impl/BiWeeklyVisitBoostServiceImpl.java`               | 双周上浮协作服务实现             | 协调 domain 规则实现，对相关预测/客户数据进行调整                                                   |
| `RegionCustomerStatisticsBuildService.java`             | 区域客户统计构建服务接口         | 定义构建区域客户统计信息的用例                                                                       |
| `impl/RegionCustomerStatisticsBuildServiceImpl.java`    | 区域客户统计构建服务实现         | 从 customer_filter 分区表查询数据，构建区域客户统计表，写入 region_customer_statistics 分区表       |
| `TagExtractionService.java`                             | 标签抽取协作服务接口             | 定义从基础数据中抽取业务标签的用例                                                                   |
| `impl/TagExtractionServiceImpl.java`                    | 标签抽取协作服务实现             | 调用 domain 规则与 shared 工具，从导入/基础数据中抽取标签并保存                                     |
| `PriceBandCandidateQueryService.java`                   | 价位段候选查询服务接口           | 定义基于投放信息分区表和价目表，构建"按价位段升序、组内批发价降序"的候选卷烟列表的用例             |
| `impl/PriceBandCandidateQueryServiceImpl.java`          | 价位段候选查询服务实现           | 查询指定分区下"按价位段自选投放"的候选卷烟，为后续按价位段自选投放算法提供输入                     |
| `CustomerFilterPartitionCleanupService.java`            | 客户过滤分区清理服务             | 自动清理 customer_filter 分区表中超过保留期（默认1周）的旧分区，支持定时任务（每天凌晨2点）和手动触发 |
| `provider/GroupRatioProvider.java`                      | 分组比例提供接口                 | 抽象化"如何根据场景计算分组比例"，例如城网/农网比例、诚信互助小组比例等                             |
| `provider/MarketTypeRatioProvider.java`                 | 市场类型分组比例提供实现         | 按城网/农网等市场类型计算分组比例，供 GROUP_SPLITTING 算法使用                                       |
| `provider/IntegrityGroupRatioProvider.java`             | 诚信互助小组分组比例实现         | 按诚信互助小组配置计算分组比例，支持大量分组的拆分分配                                               |

---

### 2.8 `service.encode` / `impl` 子层：编码与聚合懒加载服务

物理路径：`src/main/java/org/example/application/service/encode`

| 文件名                                           | 职责定位                             | 主要功能简述                                                                                              |
|--------------------------------------------------|--------------------------------------|-----------------------------------------------------------------------------------------------------------|
| `EncodeService.java`                             | 单区域编码应用服务接口               | 定义对单个区域/组合进行编码生成的能力，支持所有投放方式（按档位投放、按档位扩展投放、按价位段自选投放等） |
| `impl/EncodeServiceImpl.java`                    | 单区域编码应用服务实现               | 调用 domain 规则与 repository，将业务含义转换为编码表达式；支持 B 类型（按档位扩展投放）必须有扩展类型编码，C 类型（按价位段自选投放）可选使用扩展类型编码（预留未来扩展） |
| `AggregatedEncodingQueryService.java`            | 聚合编码懒加载查询服务接口           | 定义按批次+卷烟代码懒加载多区域聚合编码表达式的应用服务能力                                              |
| `impl/AggregatedEncodingQueryServiceImpl.java`   | 聚合编码懒加载查询服务实现           | 基于预测分区表/编码规则表，按需计算并返回聚合表达式，避免一次性加载全部区域数据                          |

---

### 2.9 `service.prediction` / `impl` 子层：预测数据查询与维护服务

物理路径：`src/main/java/org/example/application/service/prediction`

| 文件名                                          | 职责定位                      | 主要功能简述                                                                                          |
|-------------------------------------------------|-------------------------------|-------------------------------------------------------------------------------------------------------|
| `PredictionQueryService.java`                   | 预测数据查询服务接口          | 定义按时间分区查询预测数据和价位段预测数据的接口                                                      |
| `impl/PredictionQueryServiceImpl.java`          | 预测数据查询服务实现          | 调用 repository 查询数据，转换为有序的 Map 格式返回，便于前端展示                                    |
| `PredictionAddService.java`                     | 预测数据新增服务接口          | 定义新增投放区域分配记录的接口                                                                        |
| `impl/PredictionAddServiceImpl.java`            | 预测数据新增服务实现          | 执行新增逻辑，包括参数校验、编码生成、实际投放量计算、数据库写入                                      |
| `PredictionDeleteService.java`                  | 预测数据删除服务接口          | 定义删除指定卷烟特定区域或所有区域分配记录的接口                                                      |
| `impl/PredictionDeleteServiceImpl.java`         | 预测数据删除服务实现          | 执行删除逻辑，支持删除特定区域或整个卷烟的分配记录                                                    |
| `PredictionUpdateService.java`                  | 预测数据修改服务接口          | 定义修改指定卷烟特定区域档位值的接口                                                                  |
| `impl/PredictionUpdateServiceImpl.java`         | 预测数据修改服务实现          | 执行修改逻辑，重新计算实际投放量和编码表达式，更新备注字段                                            |
| `PartitionPredictionQueryService.java`          | 分区预测查询服务接口          | 定义更底层的分区预测数据查询与删除操作接口                                                            |
| `impl/PartitionPredictionQueryServiceImpl.java` | 分区预测查询服务实现          | 实现具体的分区表查询与删除逻辑，供其他服务调用                                                        |

---

### 2.10 `service.writeback` / `impl` 子层：分配结果写回服务

物理路径：`src/main/java/org/example/application/service/writeback`

| 文件名                                                  | 职责定位                         | 主要功能简述                                                                                         |
|---------------------------------------------------------|----------------------------------|------------------------------------------------------------------------------------------------------|
| `StandardDistributionWriteBackService.java`             | 标准分配写回服务接口             | 定义标准分配（按档位投放、按档位扩展投放）的写回接口                                                 |
| `impl/StandardDistributionWriteBackServiceImpl.java`    | 标准分配写回服务实现             | 将分配矩阵写回 `cigarette_distribution_prediction` 表，生成编码表达式，计算实际投放量，支持单个卷烟和批量写回 |
| `PriceBandDistributionWriteBackService.java`            | 价位段分配写回服务接口           | 定义价位段分配的写回接口                                                                             |
| `impl/PriceBandDistributionWriteBackServiceImpl.java`   | 价位段分配写回服务实现           | 将价位段分配结果批量写回 `cigarette_distribution_prediction_price` 表，调用 `EncodeService` 生成编码表达式 |

### 2.11 `service.adjust` / `impl` 子层：策略调整服务

物理路径：`src/main/java/org/example/application/service/adjust`

| 文件名                                                  | 职责定位                         | 主要功能简述                                                                                         |
|---------------------------------------------------------|----------------------------------|------------------------------------------------------------------------------------------------------|
| `CigaretteStrategyAdjustService.java`                   | 卷烟投放策略调整服务接口         | 定义单个卷烟投放策略调整的接口                                                                       |
| `impl/CigaretteStrategyAdjustServiceImpl.java`          | 卷烟投放策略调整服务实现         | 删除旧分配记录、根据新投放组合重新执行分配算法、写回数据库、更新 Info 表备注为"已人工调整策略"     |

### 2.12 `service.region` / `impl` 子层：区域服务

物理路径：`src/main/java/org/example/application/service/region`

| 文件名                                                  | 职责定位                         | 主要功能简述                                                                                         |
|---------------------------------------------------------|----------------------------------|------------------------------------------------------------------------------------------------------|
| `GetAvailableRegionsService.java`                       | 获取可用投放区域服务接口         | 定义获取可用投放区域列表的接口                                                                       |
| `impl/GetAvailableRegionsServiceImpl.java`              | 获取可用投放区域服务实现         | 根据投放类型和扩展类型解析所有可能的区域，检查并构建区域客户统计数据，返回完整的可用区域列表         |

### 2.13 `service.statistics` / `impl` 子层：统计服务

物理路径：`src/main/java/org/example/application/service/statistics`

| 文件名                                                  | 职责定位                         | 主要功能简述                                                                                         |
|---------------------------------------------------------|----------------------------------|------------------------------------------------------------------------------------------------------|
| `DeliveryCombinationRegionService.java`                 | 投放组合与区域映射服务接口       | 定义查询投放组合与区域映射的接口                                                                     |
| `impl/DeliveryCombinationRegionServiceImpl.java`        | 投放组合与区域映射服务实现       | 查询本次分配包含的所有投放组合（投放方式+扩展类型+标签）及其对应的区域全集                           |
| `PriceBandOrderLimitService.java`                       | 价位段订购量上限服务接口         | 定义查询价位段订购量上限的接口                                                                       |
| `impl/PriceBandOrderLimitServiceImpl.java`              | 价位段订购量上限服务实现         | 根据价位段分配结果计算每个价位段各档位的订购量上限（计算规则：价位段单档位投放量之和 / 设定阈值）   |

---

### 2.14 `dto` / `converter` / `event.handler` 子层：应用内部 DTO、转换与事件处理

物理路径：
- DTO：`src/main/java/org/example/application/dto`
- Converter：`src/main/java/org/example/application/converter`
- Event Handler：`src/main/java/org/example/application/event/handler`

| 子层/文件                                    | 职责定位                     | 主要功能简述                                                                                          |
|---------------------------------------------|------------------------------|-------------------------------------------------------------------------------------------------------|
| `dto/allocation/*`                          | 分配相关DTO                  | 包含分配计算、策略调整、获取可用区域等用例的请求和响应DTO                                             |
| `dto/importing/*`                           | 导入相关DTO                  | 包含客户基础信息表、卷烟投放基础信息表导入的请求和响应DTO                                             |
| `dto/prediction/*`                          | 预测数据相关DTO              | 包含预测数据增删改查相关的请求和响应DTO                                                               |
| `converter/DistributionDataConverter.java`  | 分配数据转换器               | 在 DTO 与领域模型/持久化模型之间进行转换，提供通用的数据提取和转换方法                                |
| `event/handler/DataImportEventHandler.java` | 导入事件处理器               | 响应导入相关领域/应用事件，进行后续统计/日志/监控等                                                   |
| `event/handler/DistributionPlanMonitorHandler.java` | 分配方案监控事件处理器 | 监听分配生成相关事件，做监控与告警                                                                     |
| `event/handler/DistributionPlanStatisticsHandler.java` | 分配方案统计事件处理器 | 监听分配生成完成事件，统计结果写入统计表或监控系统                                                    |

---


## 三、Domain 层总体说明（领域模型与业务规则层）

Domain 层承载“卷烟分配与预测”领域的核心业务模型与业务规则，是系统的业务心脏：  
包括领域实体/值对象、领域服务（算法/规则）、领域事件以及 Repository 抽象接口。

物理路径：`src/main/java/org/example/domain`

### 3.1 Domain 层子层职责总表

| 子层（包名）                               | 角色定位                          | 说明                                                                                          |
|--------------------------------------------|-----------------------------------|-----------------------------------------------------------------------------------------------|
| `model.entity` (`domain/model/entity`)     | 领域实体（Entity）                | 预留目录，用于存放具有业务身份与生命周期的核心业务对象（当前为空，业务数据主要通过 Map/DTO 传递） |
| `model.valueobject` (`domain/model/valueobject`) | 值对象（Value Object）      | 表示无独立身份、以值定义的对象，如投放组合、投放方式类型、扩展投放类型等                     |
| `model.tag` (`domain/model/tag`)           | 领域标签规则模型                  | 存放与标签过滤相关的规则接口定义                                                               |
| `repository` (`domain/repository`)         | 领域仓储接口（Repository Abstraction） | 定义对领域实体/聚合根的持久化操作抽象，由基础设施层实现                                      |
| `service.algorithm`                        | 领域算法服务                      | 定义并实现分配算法（单层、多区域无权重、多区域带权重）的纯业务逻辑                           |
| `service.rule`                             | 领域规则服务                      | 定义与标签过滤、双周上浮、编码规则、全市占比、价位段、货源属性校验等相关的领域规则           |
| `service.delivery`                         | 投放组合解析等领域服务            | 封装投放组合解析等与投放策略密切相关的领域逻辑                                               |
| `event` (`domain/event`)                   | 领域事件                          | 在导入、分配生成等领域行为发生时发布的事件，用于驱动应用层后续处理                           |

---

### 3.2 `repository` 子层：领域仓储接口说明

物理路径：`src/main/java/org/example/domain/repository`

| 接口文件名                                      | 聚合/实体范围                      | 主要功能简述                                                                                         |
|-------------------------------------------------|------------------------------------|------------------------------------------------------------------------------------------------------|
| `BaseCustomerInfoRepository.java`               | 基础客户信息聚合                   | 抽象基础客户信息的查询与维护，用于构建区域客户矩阵、标签抽取等                                     |
| `CigaretteDistributionInfoRepository.java`      | 卷烟分配记录聚合                   | 抽象卷烟分配结果的查询与操作，用于一键生成分配方案、结果校验等                                     |
| `CigaretteDistributionPredictionRepository.java`| 预测分区数据聚合                   | 抽象预测分区（含多区域聚合）的读写操作，支持聚合懒加载等场景                                       |
| `CigaretteDistributionPredictionPriceRepository.java` | 价位段预测数据聚合            | 抽象价位段预测数据的读写，支撑价位段预测查询与分配                                                 |
| `IntegrityGroupMappingRepository.java`          | 诚信互助小组映射聚合               | 抽象客户与诚信互助小组之间的映射关系，供分组拆 target 算法和统计使用                               |
| `RegionCustomerStatisticsRepository.java`       | 区域客户统计聚合                   | 抽象区域客户统计结果的持久化，用于统计报表与分配前置校验                                           |
| `FilterCustomerTableRepository.java`         | 客户过滤表聚合（分区表）                     | 抽象 customer_filter 分区表的增删查等操作，用于区域客户统计构建、双周上浮等场景的数据过滤与查询                                               |

> 约束：Domain 层只定义接口，不关心具体存储技术；具体实现位于 `infrastructure/repository/impl`。

---

### 3.3 `service.algorithm` 子层：领域算法服务说明

物理路径：`src/main/java/org/example/domain/service/algorithm`

| 文件名                                          | 职责定位                               | 主要功能简述                                                                                              |
|-------------------------------------------------|----------------------------------------|-----------------------------------------------------------------------------------------------------------|
| `SingleLevelDistributionService.java`           | 单层区域分配算法领域服务接口           | 定义“单区域/简单场景”下，根据客户矩阵和目标量计算分配矩阵的抽象                                         |
| `ColumnWiseAdjustmentService.java`              | 多区域无权重分配算法领域服务接口       | 定义“多区域无权重”场景下，执行整列粗调 + 排序微调的分配算法抽象                                         |
| `GroupSplittingDistributionService.java`        | 多区域带权重分配算法领域服务接口       | 定义“按分组+权重拆分 target，再分别分配”的算法抽象                                                       |
| `impl/SingleLevelDistributionServiceImpl.java`  | 单层区域分配算法领域服务实现           | 复制并整理自历史最新算法实现，保证与原实现结果一致，去除基础设施依赖，便于单元测试与复用                 |
| `impl/ColumnWiseAdjustmentServiceImpl.java`     | 多区域无权重分配算法领域服务实现       | 实现整列粗调 + 微调 + 非递增约束等逻辑，作为 COLUMN_WISE 算法在领域层的唯一权威实现                     |
| `impl/GroupSplittingDistributionServiceImpl.java`| 多区域带权重分配算法领域服务实现     | 实现按分组比例拆分 target、为每个分组调用单层/多区域算法并合并结果的完整过程                            |

> 提示：Application 层的 `DistributionAlgorithmEngine` 已经全部依赖这些领域服务接口，而不再依赖基础设施算法接口。

---

### 3.4 `service.rule` 子层：领域规则服务说明

物理路径：`src/main/java/org/example/domain/service/rule`

| 文件名                                      | 职责定位                       | 主要功能简述                                                                                             |
|---------------------------------------------|--------------------------------|----------------------------------------------------------------------------------------------------------|
| `TagFilterRule.java`                        | 标签过滤规则接口               | 抽象“如何根据标签配置对客户/分区进行过滤”的规则                                                         |
| `EncodingRule.java`                         | 编码规则接口                   | 抽象“如何根据业务含义生成编码表达式”的规则                                                              |
| `BiWeeklyVisitBoostRule.java`               | 双周上浮规则接口               | 抽象与双周上访相关的上浮规则                                                                             |
| `CityWideRatioRule.java`                    | 全市占比规则接口               | 抽象全市投放占比的计算与校验规则，用于导入校验等场景                                                     |
| `PriceBandRule.java`                        | 价位段规则接口                 | 抽象价位段相关的业务规则，如价位段分组、截断策略等                                                       |
| `SupplySourceValidationRule.java`           | 货源属性校验规则接口           | 抽象货源属性与投放方式、标签组合的合法性校验规则                                                         |
| `impl/TagFilterRuleImpl.java`              | 标签过滤规则实现               | 根据标签配置和过滤条件，筛选符合条件的客户/分区                                                          |
| `impl/EncodingRuleImpl.java`               | 编码规则实现                   | 实现编码生成的具体规则，与 `EncodeServiceImpl` 协作生成编码                                             |
| `impl/BiWeeklyVisitBoostRuleImpl.java`     | 双周上浮规则实现               | 实现双周拜访相关的提升逻辑，供 `BiWeeklyVisitBoostServiceImpl` 复用                                     |
| `impl/CityWideRatioRuleImpl.java`          | 全市占比规则实现               | 实现全市投放占比的计算逻辑，供导入校验器使用                                                             |
| `impl/PriceBandRuleImpl.java`              | 价位段规则实现                 | 实现价位段分组、截断与微调等具体业务逻辑                                                                 |
| `impl/SupplySourceValidationRuleImpl.java` | 货源属性校验规则实现           | 实现货源属性 + 投放方式 + 标签组合的合法性校验逻辑                                                       |

---

### 3.5 `service.delivery` 子层：投放组合解析等领域服务

物理路径：`src/main/java/org/example/domain/service/delivery`

| 文件名                                  | 职责定位                     | 主要功能简述                                                                                             |
|-----------------------------------------|------------------------------|----------------------------------------------------------------------------------------------------------|
| `DeliveryCombinationParser.java`        | 投放组合解析领域服务         | 将投放方式、扩展投放方式、区域/标签等组合解析为更结构化的信息，供策略编排和算法选择使用                |

---

### 3.6 `model` 与 `event` 子层：领域模型与事件

物理路径：
- `model.entity`：`src/main/java/org/example/domain/model/entity`（当前为空目录）
- `model.valueobject`：`src/main/java/org/example/domain/model/valueobject`
- `model.tag`：`src/main/java/org/example/domain/model/tag`
- `event`：`src/main/java/org/example/domain/event`

| 子层/文件                                    | 职责定位                 | 主要功能简述                                                                                             |
|----------------------------------------------|--------------------------|----------------------------------------------------------------------------------------------------------|
| `model/entity/`                              | 领域实体（预留）         | 预留目录，用于存放具有业务身份的核心业务对象（当前为空，业务数据主要通过 Map/DTO 传递）                 |
| `model/valueobject/DeliveryCombination.java` | 投放组合值对象           | 表示投放方式、扩展投放方式、区域、标签等组合信息的不可变值对象                                         |
| `model/valueobject/DeliveryMethodType.java`  | 投放方式类型枚举/值对象  | 定义投放方式的类型常量或枚举                                                                             |
| `model/valueobject/DeliveryExtensionType.java`| 扩展投放类型枚举/值对象 | 定义扩展投放方式的类型常量或枚举                                                                         |
| `model/tag/TagFilterRule.java`               | 标签过滤规则接口         | 定义标签过滤规则的抽象接口（注：与 `service.rule.TagFilterRule` 可能存在重复，建议后续整理）            |
| `event/DataImportStartedEvent.java`          | 导入开始事件             | 在数据导入开始时发布，用于触发相关监控/日志                                                             |
| `event/DataImportCompletedEvent.java`        | 导入完成事件             | 在数据导入成功完成时发布，用于触发后续统计处理                                                           |
| `event/DataImportFailedEvent.java`           | 导入失败事件             | 在数据导入失败时发布，用于触发告警/错误处理                                                             |
| `event/DistributionPlanGenerationStartedEvent.java` | 分配生成开始事件  | 在分配方案生成开始时发布                                                                                 |
| `event/DistributionPlanGenerationCompletedEvent.java` | 分配生成完成事件 | 在分配方案生成完成时发布，用于触发统计/监控                                                             |
| `event/ExistingDataDeletedEvent.java`        | 数据删除事件             | 在删除已有数据时发布，用于记录操作日志                                                                   |

---

## 四、Infrastructure 层总体说明（技术细节与外部资源接入层）

Infrastructure 层负责具体技术实现细节：数据库访问、配置、监控以及历史算法实现等，  
为 Domain 和 Application 提供可替换的技术支撑，不承载业务决策。

物理路径：`src/main/java/org/example/infrastructure`

### 4.1 Infrastructure 层子层职责总表

| 子层（包名）                                  | 角色定位                           | 说明                                                                                           |
|-----------------------------------------------|------------------------------------|------------------------------------------------------------------------------------------------|
| `persistence.mapper`                          | MyBatis Mapper 接口                | 描述数据库表级别的 CRUD 与查询语句，由 XML/注解实现 SQL                                       |
| `persistence.po`                              | 持久化对象（PO）                   | 映射数据库表结构的 Java 对象，主要用于 MyBatis 映射                                            |
| `persistence.typehandler`                     | MyBatis 类型处理器                 | 自定义类型转换器，如 JSON 与 Map 之间的转换                                                    |
| `repository.impl`                             | 仓储实现                           | 实现 Domain 层 `repository` 接口，将领域操作翻译为 Mapper 调用                                 |
| `algorithm` / `algorithm.impl`                | 历史版本最新算法实现（对比/回归用）| 保留的基础设施层算法接口与实现，主链路已迁移到 Domain 算法服务，仅用于对比和回归测试          |
| `config`                                      | 基础设施配置                       | 包括线程池/异步、编码规则加载、价位段规则加载、导入校验规则加载、监控（MeterRegistry）等配置  |
| `monitor`                                     | 运行时监控与切面                   | 对事务/执行过程进行监控和日志记录                                                               |

---

### 4.2 `persistence.mapper` 子层：MyBatis Mapper 接口

物理路径：`src/main/java/org/example/infrastructure/persistence/mapper`

| 文件名                                      | 对应聚合/表                         | 主要功能简述                                                                                         |
|---------------------------------------------|-------------------------------------|------------------------------------------------------------------------------------------------------|
| `BaseCustomerInfoMapper.java`               | 基础客户信息表                      | 提供客户基础信息的增删改查与查询接口                                                                 |
| `CigaretteDistributionInfoMapper.java`      | 卷烟分配记录表                      | 提供卷烟分配结果的持久化操作与查询接口                                                               |
| `CigaretteDistributionPredictionMapper.java`| 预测分区表                          | 提供按时间/卷烟代码等维度查询预测分区数据的接口，支撑懒加载聚合等场景                               |
| `CigaretteDistributionPredictionPriceMapper.java` | 价位段预测表                    | 提供价位段预测数据的查询与维护接口                                                                   |
| `RegionCustomerStatisticsMapper.java`       | 区域客户统计表                      | 提供区域客户统计数据的持久化与查询接口                                                               |
| `IntegrityGroupMappingMapper.java`          | 诚信互助小组映射表                  | 提供诚信互助小组与客户关系映射的访问接口                                                             |
| `FilterCustomerTableMapper.java`         | 客户过滤表（分区表）                          | 提供 customer_filter 分区表的操作接口，包括分区数据插入、查询、统计等功能                                                     |

---

### 4.3 `persistence.po` 子层：持久化对象（PO）

物理路径：`src/main/java/org/example/infrastructure/persistence/po`

| 文件名/子层                                      | 职责定位                 | 主要功能简述                                                                                         |
|--------------------------------------------------|--------------------------|------------------------------------------------------------------------------------------------------|
| `CigaretteDistributionPredictionPO.java`         | 预测分区持久化对象       | 对应 `cigarette_distribution_prediction` 表，包含卷烟代码、名称、投放方式、区域、D30-D1 档位等字段   |
| `CigaretteDistributionPredictionPricePO.java`    | 价位段预测持久化对象     | 继承自 `CigaretteDistributionPredictionPO`，对应 `cigarette_distribution_prediction_price` 表，表结构完全一致，仅表名不同 |
| `*Po.java`                                       | 其他持久化对象           | 与数据库表字段一一对应，用于 MyBatis 映射，不承载业务逻辑                                           |

---

### 4.4 `repository.impl` 子层：领域仓储实现

物理路径：`src/main/java/org/example/infrastructure/repository/impl`

| 文件名                                                 | 对应领域仓储接口                         | 主要功能简述                                                                                           |
|--------------------------------------------------------|------------------------------------------|--------------------------------------------------------------------------------------------------------|
| `BaseCustomerInfoRepositoryImpl.java`                  | `BaseCustomerInfoRepository`             | 调用 `BaseCustomerInfoMapper` 实现基础客户信息相关的持久化操作                                         |
| `CigaretteDistributionInfoRepositoryImpl.java`         | `CigaretteDistributionInfoRepository`    | 实现卷烟分配记录聚合的查询与写入逻辑                                                                   |
| `CigaretteDistributionPredictionRepositoryImpl.java`   | `CigaretteDistributionPredictionRepository` | 实现预测分区数据的领域仓储接口，包括按批次/卷烟代码的查询等                                       |
| `CigaretteDistributionPredictionPriceRepositoryImpl.java` | `CigaretteDistributionPredictionPriceRepository` | 实现价位段预测数据聚合的仓储逻辑                                                       |
| `IntegrityGroupMappingRepositoryImpl.java`             | `IntegrityGroupMappingRepository`        | 实现诚信互助小组映射的持久化操作                                                                       |
| `RegionCustomerStatisticsRepositoryImpl.java`          | `RegionCustomerStatisticsRepository`     | 实现区域客户统计结果的读写操作                                                                         |
| `FilterCustomerTableRepositoryImpl.java`            | `FilterCustomerTableRepository`       | 实现 customer_filter 分区表相关的持久化操作，包括分区管理、数据插入、查询统计等功能                                                                         |

---

### 4.5 `algorithm` / `algorithm.impl` 子层：历史算法实现（仅对比/回归用途）

物理路径：`src/main/java/org/example/infrastructure/algorithm`

| 文件名                                                 | 职责定位                                     | 主要功能简述                                                                                             |
|--------------------------------------------------------|----------------------------------------------|----------------------------------------------------------------------------------------------------------|
| `SingleLevelDistributionAlgorithm.java`                | 单层区域分配算法接口（历史版本最新）         | 描述单层区域分配算法的接口，Javadoc 标明为“历史版本最新算法，仅用于对比与回归验证”                      |
| `ColumnWiseAdjustmentAlgorithm.java`                   | 多区域无权重分配算法接口（历史版本最新）     | 描述多区域无权重分配算法的接口，Javadoc 标明对应的粗调+微调+非递增约束策略                               |
| `GroupSplittingDistributionAlgorithm.java`             | 多区域带权重分配算法接口（历史版本最新）     | 描述多区域带权重分配算法的接口，Javadoc 标明分组拆分/独立分配/非递增约束等策略                           |
| `impl/DefaultSingleLevelDistributionAlgorithm.java`    | 单层区域分配算法默认实现（历史版本最新）     | 基础设施层的具体实现，主业务已迁移到 Domain 服务，实现仅保留用于对比与回归                              |
| `impl/DefaultColumnWiseAdjustmentAlgorithm.java`       | 多区域无权重分配算法默认实现（历史版本最新） | 对应 COLUMN_WISE 算法的历史实现，已在领域服务中复制并去掉基础设施依赖，用于结果一致性对比               |
| `impl/DefaultGroupSplittingDistributionAlgorithm.java` | 多区域带权重分配算法默认实现（历史版本最新） | 对应 GROUP_SPLITTING 算法的历史实现，仅用于与领域服务实现做回归测试和结果对比                           |

---

### 4.6 `config` 与 `monitor` 子层：基础设施配置与监控

物理路径：
- `config`：`src/main/java/org/example/infrastructure/config`
- `monitor`：`src/main/java/org/example/infrastructure/monitor`

| 文件名/子层                                | 职责定位                   | 主要功能简述                                                                                         |
|--------------------------------------------|----------------------------|------------------------------------------------------------------------------------------------------|
| `AsyncConfig.java`                         | 异步执行配置               | 配置线程池/异步任务相关参数，支撑导入/分配等耗时任务                                                 |
| `encoding/EncodingRuleProperties.java`     | 编码规则属性配置           | 从 `encoding-rules.yml` 加载编码规则配置属性                                                         |
| `encoding/EncodingRuleRepository.java`     | 编码规则仓储               | 提供编码规则的查询接口，供领域编码规则使用                                                           |
| `importing/ImportValidationRuleProperties.java` | 导入校验规则属性配置  | 从 `import-validation-rules.yml` 加载导入校验规则配置                                                |
| `importing/ImportValidationRuleRepository.java` | 导入校验规则仓储      | 提供导入校验规则的查询接口，供导入校验器使用                                                         |
| `price/PriceBandRuleProperties.java`       | 价位段规则属性配置         | 从配置文件加载价位段相关规则配置                                                                     |
| `price/PriceBandRuleRepository.java`       | 价位段规则仓储             | 提供价位段规则的查询接口，供价位段分配服务使用                                                       |
| `MeterRegistryConfig.java`                 | 指标监控配置               | 配置监控指标上报（如 Micrometer），便于线上观测                                                       |
| `TransactionMonitor.java`                  | 事务/操作监控切面          | 对关键事务或方法进行监控和日志记录，帮助排查问题                                                     |

---

## 五、Shared 层总体说明（跨层共享工具与基础能力）

Shared 层提供跨层复用的基础能力：常量、异常处理、工具方法、辅助服务等，  
不依赖具体业务上下文，尽量保持纯粹与通用。

物理路径：`src/main/java/org/example/shared`

### 5.1 Shared 层子层职责总表

| 子层（包名）                          | 角色定位                   | 说明                                                                                           |
|---------------------------------------|----------------------------|------------------------------------------------------------------------------------------------|
| `constants`                           | 业务/技术常量              | 定义表名、档位、业务编码等常量，避免魔法字符串                                                 |
| `exception`                           | 全局异常处理               | 提供统一的异常处理入口，统一返回格式                                                           |
| `helper`                              | 领域相关的辅助类           | 封装导入/写入/表管理等复用流程片段                                                             |
| `util`                                | 通用工具类                 | 提供字符串、集合、矩阵、校验等通用工具方法                                                     |
| `dto`                                 | 共享 DTO                   | 在多层之间共享的简单数据结构，如区域客户记录                                                   |

---

### 5.2 `constants` / `exception` 子层：常量与全局异常

物理路径：
- `constants`：`src/main/java/org/example/shared/constants`
- `exception`：`src/main/java/org/example/shared/exception`

| 文件名/子层                                | 职责定位                 | 主要功能简述                                                                                         |
|--------------------------------------------|--------------------------|------------------------------------------------------------------------------------------------------|
| `BusinessConstants.java`                   | 业务常量                 | 定义与业务流程相关的固定值，如投放方式、标记位等                                                     |
| `GradeConstants.java`                      | 档位常量                 | 定义 D1~D30 等档位相关常量，供算法/统计/展示共同使用                                                 |
| `TableConstants.java`                      | 表名常量                 | 定义数据库表名等字符串常量，避免硬编码                                                               |
| `GlobalExceptionHandler.java`              | 全局异常处理器           | 拦截 Controller 层异常，统一封装成标准 API 响应结构                                                  |
| `IntegrityGroupMappingEmptyException.java` | 诚信互助小组映射为空异常 | 当诚信互助小组映射数据为空时抛出，用于分组分配算法的前置校验                                         |
| `RegionNoCustomerException.java`           | 区域无客户异常           | 当指定区域没有客户数据时抛出，用于分配算法的前置校验                                                 |

---

### 5.3 `helper` / `util` / `dto` 子层：辅助类与工具方法

物理路径：
- `helper`：`src/main/java/org/example/shared/helper`
- `util`：`src/main/java/org/example/shared/util`
- `dto`：`src/main/java/org/example/shared/dto`

| 文件名/子层                            | 职责定位                     | 主要功能简述                                                                                         |
|----------------------------------------|------------------------------|------------------------------------------------------------------------------------------------------|
| `BaseCustomerTableManager.java`        | 基础客户表管理辅助类         | 封装对基础客户表/临时表的通用操作逻辑                                                                 |
| `CigaretteInfoWriter.java`             | 卷烟信息写入辅助类           | 封装将卷烟信息批量写入数据库的通用逻辑                                                               |
| `CustomerFilterTableSyncService.java`  | 客户过滤表同步服务           | 封装 customer_filter 分区表的数据同步逻辑                                                            |
| `ExcelParseHelper.java`                | Excel 解析辅助类             | 封装 Excel 文件解析逻辑，供导入流程复用                                                             |
| `ImportValidationHelper.java`          | 导入校验辅助类               | 提供导入数据合法性校验的通用方法                                                                     |
| `IntegrityGroupMappingService.java`    | 诚信互助小组辅助服务         | 对诚信互助小组相关的共性操作进行封装                                                                |
| `ActualDeliveryCalculator.java`        | 实际投放量计算工具           | 计算实际投放量的工具方法                                                                             |
| `ApiResponses.java`                    | API 响应构造工具             | 提供构造标准 API 响应结构的工具方法（如成功/失败包装）                                               |
| `CombinationStrategyAnalyzer.java`     | 组合策略分析工具             | 分析投放组合/策略字符串的结构，为上层编排提供辅助                                                   |
| `DynamicTagHelper.java`                | 动态标签辅助工具             | 提供动态标签解析与处理的工具方法                                                                     |
| `GradeExtractor.java`                  | 档位提取工具                 | 从数据记录中提取档位信息的工具方法                                                                   |
| `GradeParser.java`                     | 档位解析工具                 | 解析档位字符串到内部索引，供算法/统计使用                                                            |
| `KmpMatcher.java`                      | 字符串匹配工具               | 提供 KMP 等字符串匹配算法实现                                                                        |
| `MapValueExtractor.java`               | Map 值提取工具               | 简化从 Map 中安全取值的逻辑                                                                         |
| `OrderCycleMatrixCalculator.java`      | 订货周期矩阵计算工具         | 提供与订货周期相关的矩阵计算逻辑                                                                    |
| `PartitionTableManager.java`           | 分区表管理工具               | 封装分区表相关的操作逻辑                                                                            |
| `RegionNameBuilder.java`               | 区域名称构建工具             | 标准化区域名称的拼接/解析                                                                           |
| `RegionRecordBuilder.java`             | 区域记录构建工具             | 快速构建区域记录对象的辅助方法                                                                     |
| `RequestValidators.java`               | 请求参数校验工具             | 提供对请求参数统一的校验逻辑                                                                       |
| `UploadValidators.java`                | 上传文件校验工具             | 提供对上传文件（如 Excel）的校验逻辑                                                               |
| `WriteBackHelper.java`                 | 写回辅助工具                 | 封装分配结果写回预测表的通用辅助方法                                                                 |
| `dto/RegionCustomerRecord.java`        | 共享 DTO：区域客户记录       | 在多层之间传递的区域客户记录数据结构                                                               |


## 六、关键规则与运维观测（Rules & Operations）

本节从“排查问题”和“理解核心规则”的角度，对聚合规则、算法选择策略、算法日志以及常见异常排查入口做一个集中说明。

### 6.1 聚合规则要点（多区域聚合编码）

多区域聚合编码（即“将多条预测记录组合为一个聚合表达式”）的核心思路：

- **规则 1：同一批次 + 同一卷烟代码才参与聚合**
  - 聚合查询接口会按 `year/month/weekSeq` + `cigCode` 过滤出候选记录。

- **规则 2：关键业务字段一致才能聚合**
  - 如投放方式、扩展投放方式、标签过滤配置等字段必须相同，才能被视为同一组进行表达式合并。

- **规则 3：聚合只在“30 档分配结构相同”的记录之间发生**
  - 若两条记录的 D30~D1 结构完全一致（或满足一定的等价条件），才可以用“编码表达式”合并展示；
  - 否则应当保留为多条记录，避免误解投放含义。

- **规则 4：两层聚合顺序：先主扩展，再子扩展**
  - 先按主扩展投放类型（如“档位+区县”）聚合，再在每一组内部按子扩展维度（如市场类型、标签）进一步聚合；
  - 保证最终表达式既能体现主维度，又不会丢失子维度信息。

> 具体算法实现由 `application/service/encode` 与相关领域规则共同完成，上述规则是阅读代码时的“思维框架”。

---

### 6.2 算法选择策略（DistributionAlgorithmEngine）

在实际分配计算中，`DistributionAlgorithmEngine` 会根据上下文选择不同的领域算法服务进行调用。可以粗略理解为如下策略：

- **输入关键信息**：
  - 实际参与分配的区域集合（区域数量、区域名称列表）；
  - 是否存在分组 + 权重（如城网/农网比例、诚信互助小组比例等）；
  - 请求中传入的扩展投放类型、额外参数（ExtraInfo）等。

- **选择逻辑示意**（伪代码）：

```text
if (区域数 == 1 且无分组/权重) {
    使用 SINGLE_LEVEL 算法（SingleLevelDistributionService）
} else if (存在有效的分组 + 权重参数) {
    使用 GROUP_SPLITTING 算法（GroupSplittingDistributionService）
} else {
    使用 COLUMN_WISE 算法（ColumnWiseAdjustmentService）
}
```

- **决策原则**：
  - **简单场景用简单算法**：单区域直接用单层算法，保持可读性和性能。
  - **有明确分组权重时优先 GROUP_SPLITTING**：保证分组间比例符合业务要求。
  - **其余多区域情况用 COLUMN_WISE**：在多区域、无权重场景下寻找误差最优的分配方案。

---

### 6.3 `DistributionAlgorithmEngine` 日志观测点

算法执行相关的关键日志被集中放在 `DistributionAlgorithmEngine` 中，是排查分配问题的首选入口：

- **进入算法前/选择算法时**：
  - 记录卷烟代码、卷烟名称、投放方式、扩展投放方式、标签、区域数量等信息；
  - 记录被选中的算法类型（SINGLE_LEVEL / COLUMN_WISE / GROUP_SPLITTING）；
  - 若存在分组比例（如城网/农网、诚信互助小组），会记录各分组权重。

- **算法执行完成后**：
  - 统一记录一次“算法结果”日志，包含：
    - 算法类型；
    - 目标投放量（target）；
    - 实际投放量（actual）；
    - 误差（error = |target - actual|）；
    - 区域数量、矩阵维度等。

- **使用建议**：
  - 若线上反馈“分配不准”或“误差偏大”，可以先根据卷烟代码/批次在日志中搜索对应算法执行日志，查看：
    - 实际使用的算法类型是否符合预期；
    - target/actual/error 是否在可接受范围；
    - 分组比例是否传入/解析正确。

---

### 6.4 常见异常与排查入口

下面列出一些常见问题场景以及推荐的排查路径：

| 问题现象                                   | 可能原因示例                                         | 推荐排查入口                                                                                   |
|--------------------------------------------|------------------------------------------------------|------------------------------------------------------------------------------------------------|
| 实际投放量与目标量误差过大                 | 预测源数据异常、市场比例参数错误、算法选择不符合预期 | 查看 `DistributionAlgorithmEngine` 日志中的 target/actual/error 以及算法类型；检查输入参数   |
| 多区域聚合编码表达式“不符合直觉”          | 聚合规则匹配条件不满足、某些字段不一致导致未聚合     | 检查 `AggregatedEncodingQueryService` 相关日志和 SQL，核对参与聚合的记录字段是否完全一致     |
| 某些区域/卷烟“没有生成分配记录”           | 输入数据缺失、过滤规则（标签/组合）过严              | 查看生成分配方案的集成测试或日志，检查过滤规则、区域客户矩阵是否为空                         |
| 导入过程频繁失败                           | Excel 模板格式变更、字段校验不通过、业务合法性校验失败 | 查看导入接口日志、`DataImportEventHandler` 日志；检查 `ExcelImportServiceImpl`、`CigaretteImportValidatorImpl` 的 warn/error 日志以及导入校验配置 |
| 价位段预测查询结果异常                     | 价位段预测表数据不完整或 SQL 条件不正确             | 检查 `CigaretteDistributionPredictionPriceMapper` 相关 SQL 与调用参数                          |

> 建议：遇到问题时，优先沿“Controller → Application Service → Orchestrator → AlgorithmEngine / Domain Service → Repository/Mapper”这条链路向下排查，并结合日志与数据库实际数据交叉验证。

---


