## 一、API 层总体说明（对外 HTTP 接口层）

本节仅说明 `api` 层及其下属子层（`controller` / `converter` / `vo.request` / `vo.response`）的结构与作用，方便新同学快速理解“接口长什么样、数据如何进出系统”。  
后续 `application` / `domain` / `infrastructure` 等层将在你确认后按相同风格继续补充。

### 1.1 API 层结构概览

API 层物理路径：`src/main/java/org/example/api/web`

#### 1.1.1 子层职责总表

| 子层（包名）                                | 角色定位                         | 说明                                                         |
|---------------------------------------------|----------------------------------|--------------------------------------------------------------|
| `controller` (`api/web/controller`)         | HTTP 接口入口层                 | 定义 REST 接口，处理请求/响应的最外层，不包含业务逻辑       |
| `converter` (`api/web/converter`)           | VO 与 DTO 之间的转换适配层      | 负责 API 层 VO 与 Application 层 DTO 的双向转换              |
| `vo.request` (`api/web/vo/request`)         | 前端请求对象（Request VO）      | 描述前端传入参数结构，带基础校验注解，用于接收 HTTP Body     |
| `vo.response` (`api/web/vo/response`)       | 前端响应对象（Response VO）     | 描述返回给前端的结构，如列表、分页、结果明细等               |

---

### 1.2 `controller` 子层：各接口控制器说明

物理路径：`src/main/java/org/example/api/web/controller`

| 文件名                                | 职责定位                           | 主要功能简述                                                                 |
|---------------------------------------|------------------------------------|------------------------------------------------------------------------------|
| `DistributionCalculateController.java`| 分配计算接口控制器                 | 提供“一键生成分配方案”和“汇总总实际投放量”的 HTTP 接口入口，调用应用层分配计算服务 |
| `ExcelImportController.java`          | Excel 导入接口控制器               | 提供 Excel 模板上传/导入的 HTTP 接口入口，负责触发导入流程并返回结果        |
| `PredictionQueryController.java`      | 预测数据查询与聚合懒加载控制器     | 提供预测分区数据查询、价位段预测数据查询，以及“聚合编码懒加载”查询接口      |

> 约束：`controller` 仅做参数接收、日志记录、调用 Application 层服务和返回统一响应，不承载业务规则和数据访问。

---

### 1.3 `converter` 子层：VO/DTO 转换器说明

物理路径：`src/main/java/org/example/api/web/converter`

| 文件名                                   | 职责定位                      | 主要功能简述                                                                                 |
|------------------------------------------|-------------------------------|----------------------------------------------------------------------------------------------|
| `DistributionCalculateConverter.java`    | 分配计算 VO/DTO 转换器       | 在“一键生成分配方案 / 汇总实际投放量”场景下，在请求/响应 VO 与应用层 DTO 之间进行结构映射     |
| `ExcelImportConverter.java`              | Excel 导入 VO/DTO 转换器     | 将前端上传导入相关的 VO 转为应用层导入 DTO，并将导入结果 DTO 转换为返回给前端的 VO          |
| `PredictionQueryConverter.java`          | 预测查询 VO/DTO 转换器       | 将预测数据查询的原始 Map/List 结果组装为结构化的响应 VO，便于前端渲染                       |

> 约束：`converter` 只做字段/结构转换，不做业务判断和数据库访问，保证 Controller 保持瘦而清晰。

---

### 1.4 `vo.request` 子层：请求 VO 说明

物理路径：`src/main/java/org/example/api/web/vo/request`

> 下列表格侧重描述“这个请求体大概在干什么”，具体字段含义可在代码中结合注释/校验注解查看。

| 文件名                                      | 使用场景                         | 主要功能简述                                                                                 |
|---------------------------------------------|----------------------------------|----------------------------------------------------------------------------------------------|
| `GenerateDistributionPlanRequestVo.java`    | 一键生成分配方案                 | 承载生成分配方案所需的参数，例如年份、月份、周序号以及可选的市场类型比例等                  |
| `ExcelImportRequestVo.java`（如存在）       | Excel 数据导入                   | 描述导入请求的基本信息（批次、文件标识、导入类型等），由导入 Controller 使用                 |
| `PredictionQueryRequestVo.java`（如存在）   | 预测数据查询（若封装为 Body）    | 用于封装查询预测分区或价位段数据的条件（时间、分页等），与 `PredictionQueryController` 对应  |

> 提示：项目中部分查询直接使用 `@RequestParam` 承载简单条件，未单独定义 Request VO，这些参数定义可以在对应 Controller 方法签名中查看。

---

### 1.5 `vo.response` 子层：响应 VO 说明

物理路径：`src/main/java/org/example/api/web/vo/response`

| 文件名                                         | 使用场景                               | 主要功能简述                                                                                     |
|------------------------------------------------|----------------------------------------|--------------------------------------------------------------------------------------------------|
| `ApiResponseVo.java`                           | 所有接口通用的最外层响应包装           | 统一封装 `success` / `code` / `message` / `data` 等字段，作为所有业务响应体的顶层结构           |
| `GenerateDistributionPlanResponseVo.java`      | 一键生成分配方案接口返回               | 描述生成分配方案后的结果摘要，如成功标记、处理条数、异常说明等                                 |
| `TotalActualDeliveryResponseVo.java`           | 总实际投放量汇总接口返回               | 承载指定分区（year/month/weekSeq）内的总实际投放量统计结果，用于对账/看板                      |
| `PredictionQueryResponseVo.java`               | 预测数据查询接口返回                   | 承载预测分区或价位段预测数据的明细列表/表格结构，方便前端直接渲染                               |

> 约束：`vo.response` 不直接暴露数据库结构，而是面向前端展示需求进行裁剪与整理，保持前后端解耦。

---

## 二、Application 层总体说明（用例编排与应用服务层）

Application 层主要负责“一个业务用例从入口到落地”的编排与协调：  
接收 API 层请求，调用领域服务、仓储、基础设施，组织完整流程，同时屏蔽下层细节。

物理路径：`src/main/java/org/example/application`

### 2.1 Application 层子层职责总表

| 子层（包名）                                  | 角色定位                               | 说明                                                                                  |
|-----------------------------------------------|----------------------------------------|---------------------------------------------------------------------------------------|
| `facade` (`application/facade`)               | 用例级门面（Facade）                   | 为复杂用例提供统一入口，如分配策略执行管理器，对上屏蔽复杂编排细节                   |
| `orchestrator.strategy`                       | 策略编排器（组合 -> 策略）             | 将投放组合/标签等高层信息转为“策略上下文”，决定调用哪类算法/规则                     |
| `orchestrator.allocation`                     | 算法分配编排器 + 算法引擎              | 负责从预投放数据/矩阵出发，组装请求并调用分配策略管理器/算法引擎，完成分配矩阵计算   |
| `service.calculate` / `impl`                  | 分配计算应用服务                       | 封装“一键生成分配方案、写回预测表、统计总实际投放量”等用例逻辑                       |
| `service.importing` / `impl`                  | 导入应用服务                           | 封装 Excel 导入用例的编排逻辑（解析、校验、落库、触发事件）                           |
| `service.coordinator` / `impl`                | 协作器型应用服务                       | 封装双周上浮、区域客户统计、标签抽取等跨多子域/多步骤的协作流程                       |
| `service.encode` / `impl`                     | 编码与聚合懒加载应用服务               | 封装单区域编码与多区域聚合懒加载的对前端友好的应用接口                               |
| `service.query` / `impl`                      | 查询应用服务                           | 封装面向前端的复杂查询（包含跨表、聚合、分页等），对上提供稳定的查询接口              |
| `dto` (`application/dto`)                     | 应用层数据传输对象（DTO）             | 在 Application 内部和 API 层之间传递结构化的数据                                       |
| `converter` (`application/converter`)         | 应用内部数据转换器                     | 在 DTO、领域对象、PO 之间进行结构转换                                                 |
| `event.handler` (`application/event/handler`) | 应用层事件处理器（Spring Event Handler）| 响应领域/应用事件，如导入完成、分配生成完成等，负责统计/监控/后置处理                 |

---

### 2.2 `facade` 子层：用例门面说明

物理路径：`src/main/java/org/example/application/facade`

| 文件名                               | 职责定位                     | 主要功能简述                                                                                                 |
|--------------------------------------|------------------------------|----------------------------------------------------------------------------------------------------------------|
| `DistributionStrategyManager.java`   | 分配策略管理门面接口        | 定义“执行分配策略”的业务入口接口，对上屏蔽策略编排实现细节                                                   |
| `DefaultDistributionStrategyManager.java` | 分配策略管理门面默认实现 | 接收业务语义的 `DistributionStrategyCommand`，在 Facade 内完成基础校验、默认值处理和 Command→`StrategyExecutionRequest` 的转换，然后委托 `StrategyOrchestrator` 执行策略 |
| `DistributionStrategyCommand.java`   | 分配策略执行命令 DTO        | 用业务语言描述一次分配策略执行所需的入参（投放组合、批次、目标量、附加参数、档位范围等），供上游调用方构造     |

> 提示：Facade 负责“对上统一接口 + 校验/默认值 + 请求映射”，具体算法选择/矩阵处理仍由下游 orchestrator 和 domain service 完成。

---

### 2.3 `orchestrator.strategy` 子层：策略编排说明

物理路径：`src/main/java/org/example/application/orchestrator/strategy`

| 文件名                              | 职责定位                          | 主要功能简述                                                                                               |
|-------------------------------------|-----------------------------------|------------------------------------------------------------------------------------------------------------|
| `StrategyOrchestrator.java`        | 策略编排器                        | 基于投放方式、扩展投放方式、标签等信息，组装 `StrategyContext` 并调用 `DistributionAlgorithmEngine` 执行 |
| `StrategyContext.java`             | 策略执行上下文                    | 承载本次分配所需的目标量、客户矩阵、区域列表等上下文信息                                                  |
| `StrategyExecutionRequest.java`    | 策略执行请求 DTO                  | 描述策略执行时的输入参数（投放组合、时间、标签、附加信息等），由 orchestrator/allocation 进行填充         |
| `StrategyExecutionResult.java`     | 策略执行结果模型                  | 封装策略执行后的分配矩阵、客户矩阵、目标区域列表等结果，同时标记成功/失败与原因                          |

---

### 2.4 `orchestrator.allocation` 子层：算法分配编排与算法引擎

物理路径：`src/main/java/org/example/application/orchestrator/allocation`

| 文件名                                   | 职责定位                          | 主要功能简述                                                                                                   |
|------------------------------------------|-----------------------------------|----------------------------------------------------------------------------------------------------------------|
| `DistributionAllocationOrchestrator.java`| 分配算法编排器                    | 负责从预投放数据/组合信息出发，组装业务语义的 `DistributionStrategyCommand`，调用 `DistributionStrategyManager` 触发分配   |
| `DistributionAlgorithmEngine.java`       | 分配算法引擎（选择 + 执行）       | 基于区域集合/比例/分组信息选择 SINGLE_LEVEL / COLUMN_WISE / GROUP_SPLITTING，并调用 domain 算法服务执行       |
| `AllocationCalculationResult.java`       | 分配结果封装类                    | 封装分配矩阵、客户矩阵、目标区域列表等信息，供后续写回/统计使用                                             |
| `RegionCustomerMatrix.java`              | 区域客户矩阵模型                  | 描述区域与 30 档位客户数的矩阵结构，是算法引擎与上游数据之间的桥接模型                                       |
| `provider/GroupRatioProvider.java`       | 分组比例提供接口                  | 抽象化“如何根据场景计算分组比例”，例如城网/农网比例、诚信互助小组比例等                                     |
| `provider/impl/MarketTypeRatioProvider.java` | 市场类型分组比例提供实现       | 按城网/农网等市场类型计算分组比例，供 GROUP_SPLITTING 算法使用                                               |
| `provider/impl/IntegrityGroupRatioProvider.java` | 诚信互助小组分组比例实现     | 按诚信互助小组配置计算分组比例，支持大量分组的拆分分配                                                       |

> 提示：`DistributionAlgorithmEngine` 已将原基础设施层算法的关键日志上移，成为运维排查的主观测点。

---

### 2.5 `service.calculate` / `impl` 子层：分配计算应用服务

物理路径：`src/main/java/org/example/application/service/calculate`

| 文件名                                        | 职责定位                          | 主要功能简述                                                                                       |
|-----------------------------------------------|-----------------------------------|----------------------------------------------------------------------------------------------------|
| `DistributionCalculateService.java`           | 分配计算应用服务接口              | 定义“一键生成分配方案、计算总实际投放量”等对外应用服务能力                                       |
| `impl/DistributionCalculateServiceImpl.java`  | 分配计算应用服务实现              | 从 DTO 入参出发，协调 orchestrator、domain service、repository 完成分配生成与写回                  |
| `impl/DistributionWriteBackService.java`      | 分配写回服务实现（内部使用）      | 封装将分配结果写回到预测表的具体逻辑，供 `DistributionCalculateServiceImpl` 复用                   |

---

### 2.6 `service.importing` / `impl` 子层：导入应用服务

物理路径：`src/main/java/org/example/application/service/importing`

| 文件名                                  | 职责定位                   | 主要功能简述                                                                                     |
|-----------------------------------------|----------------------------|--------------------------------------------------------------------------------------------------|
| `ExcelImportService.java`               | Excel 导入应用服务接口     | 定义导入用例：接收导入请求，触发解析/校验/落库/事件通知                                          |
| `impl/ExcelImportServiceImpl.java`      | Excel 导入应用服务实现     | 调用 shared 层解析/校验工具与 infrastructure 持久化实现，完成一次完整导入流程                   |

---

### 2.7 `service.coordinator` / `impl` 子层：协作型应用服务

物理路径：`src/main/java/org/example/application/service/coordinator`

| 文件名                                                  | 职责定位                         | 主要功能简述                                                                                         |
|---------------------------------------------------------|----------------------------------|------------------------------------------------------------------------------------------------------|
| `BiWeeklyVisitBoostService.java`                        | 双周上浮协作服务接口             | 定义与双周拜访相关的上浮规则执行用例                                                                 |
| `impl/BiWeeklyVisitBoostServiceImpl.java`               | 双周上浮协作服务实现             | 协调 domain 规则实现，对相关预测/客户数据进行调整                                                   |
| `RegionCustomerStatisticsBuildService.java`             | 区域客户统计构建服务接口         | 定义构建区域客户统计信息的用例                                                                       |
| `impl/RegionCustomerStatisticsBuildServiceImpl.java`    | 区域客户统计构建服务实现         | 调用仓储/工具，构建区域客户统计表                                                                    |
| `TagExtractionService.java`                             | 标签抽取协作服务接口             | 定义从基础数据中抽取业务标签的用例                                                                   |
| `impl/TagExtractionServiceImpl.java`                    | 标签抽取协作服务实现             | 调用 domain 规则与 shared 工具，从导入/基础数据中抽取标签并保存                                     |

---

### 2.8 `service.encode` / `impl` 子层：编码与聚合懒加载服务

物理路径：`src/main/java/org/example/application/service/encode`

| 文件名                                           | 职责定位                             | 主要功能简述                                                                                              |
|--------------------------------------------------|--------------------------------------|-----------------------------------------------------------------------------------------------------------|
| `EncodeService.java`                             | 单区域编码应用服务接口               | 定义对单个区域/组合进行编码生成的能力                                                                     |
| `impl/EncodeServiceImpl.java`                    | 单区域编码应用服务实现               | 调用 domain 规则与 repository，将业务含义转换为编码表达式                                                |
| `AggregatedEncodingQueryService.java`            | 聚合编码懒加载查询服务接口           | 定义按批次+卷烟代码懒加载多区域聚合编码表达式的应用服务能力                                              |
| `impl/AggregatedEncodingQueryServiceImpl.java`   | 聚合编码懒加载查询服务实现           | 基于预测分区表/编码规则表，按需计算并返回聚合表达式，避免一次性加载全部区域数据                          |

---

### 2.9 `service.query` / `impl` 子层：查询应用服务

物理路径：`src/main/java/org/example/application/service/query`

| 文件名                                          | 职责定位                      | 主要功能简述                                                                                          |
|-------------------------------------------------|-------------------------------|-------------------------------------------------------------------------------------------------------|
| `PredictionQueryService.java`                   | 预测数据查询服务接口          | 定义按时间分区/价位段查询预测数据的应用服务能力                                                      |
| `PredictionQueryServiceImpl.java`               | 预测数据查询服务实现          | 调用 repository / mapper 组合，并做必要聚合与结构整理后返回                                           |
| `PartitionPredictionQueryService.java`          | 分区预测查询服务接口          | 定义更细粒度的分区预测数据查询用例（若存在）                                                          |
| `PartitionPredictionQueryServiceImpl.java`      | 分区预测查询服务实现          | 实现具体查询逻辑，供 Controller 或其他服务调用                                                         |

---

### 2.10 `dto` / `converter` / `event.handler` 子层：应用内部 DTO、转换与事件处理

物理路径：
- DTO：`src/main/java/org/example/application/dto`
- Converter：`src/main/java/org/example/application/converter`
- Event Handler：`src/main/java/org/example/application/event/handler`

| 子层/文件                                    | 职责定位                     | 主要功能简述                                                                                          |
|---------------------------------------------|------------------------------|-------------------------------------------------------------------------------------------------------|
| `dto/*`                                     | 应用层入参/出参数据结构     | 如 `GenerateDistributionPlanRequestDto` / `GenerateDistributionPlanResponseDto` 等，承载用例级数据     |
| `converter/DistributionDataConverter.java`  | 应用内部数据转换器           | 在 DTO 与领域模型/持久化模型之间进行转换，减少重复 mapping 代码                                      |
| `event/handler/DataImportEventHandler.java` | 导入事件处理器               | 响应导入相关领域/应用事件，进行后续统计/日志/监控等                                                   |
| `event/handler/DistributionPlanMonitorHandler.java` | 分配方案监控事件处理器 | 监听分配生成相关事件，做监控与告警                                                                     |
| `event/handler/DistributionPlanStatisticsHandler.java` | 分配方案统计事件处理器 | 监听分配生成完成事件，统计结果写入统计表或监控系统                                                    |

---


## 三、Domain 层总体说明（领域模型与业务规则层）

Domain 层承载“卷烟分配与预测”领域的核心业务模型与业务规则，是系统的业务心脏：  
包括领域实体/值对象、领域服务（算法/规则）、领域事件以及 Repository 抽象接口。

物理路径：`src/main/java/org/example/domain`

### 3.1 Domain 层子层职责总表

| 子层（包名）                               | 角色定位                          | 说明                                                                                          |
|--------------------------------------------|-----------------------------------|-----------------------------------------------------------------------------------------------|
| `model.entity` (`domain/model/entity`)     | 领域实体（Entity）                | 表示具有业务身份与生命周期的核心业务对象，如卷烟、分配记录等                                 |
| `model.valueobject` (`domain/model/valueobject`) | 值对象（Value Object）      | 表示无独立身份、以值定义的对象，如编码组合、档位范围等                                       |
| `model.tag` (`domain/model/tag`)           | 领域标签模型                      | 表达与客户/卷烟相关的业务标签结构                                                             |
| `repository` (`domain/repository`)         | 领域仓储接口（Repository Abstraction） | 定义对领域实体/聚合根的持久化操作抽象，由基础设施层实现                                      |
| `service.algorithm`                        | 领域算法服务                      | 定义并实现分配算法（单层、多区域无权重、多区域带权重）的纯业务逻辑                           |
| `service.rule`                             | 领域规则服务                      | 定义与标签过滤、双周上浮、编码规则等相关的领域规则                                           |
| `service.delivery`                         | 投放组合解析等领域服务            | 封装投放组合解析等与投放策略密切相关的领域逻辑                                               |
| `event` (`domain/event`)                   | 领域事件                          | 在导入、分配生成等领域行为发生时发布的事件，用于驱动应用层后续处理                           |

---

### 3.2 `repository` 子层：领域仓储接口说明

物理路径：`src/main/java/org/example/domain/repository`

| 接口文件名                                      | 聚合/实体范围                      | 主要功能简述                                                                                         |
|-------------------------------------------------|------------------------------------|------------------------------------------------------------------------------------------------------|
| `BaseCustomerInfoRepository.java`               | 基础客户信息聚合                   | 抽象基础客户信息的查询与维护，用于构建区域客户矩阵、标签抽取等                                     |
| `CigaretteDistributionInfoRepository.java`      | 卷烟分配记录聚合                   | 抽象卷烟分配结果的查询与操作，用于一键生成分配方案、结果校验等                                     |
| `CigaretteDistributionPredictionRepository.java`| 预测分区数据聚合                   | 抽象预测分区（含多区域聚合）的读写操作，支持聚合懒加载等场景                                       |
| `CigaretteDistributionPredictionPriceRepository.java` | 价位段预测数据聚合            | 抽象价位段预测数据的读写，支撑价位段预测查询与分配                                                 |
| `IntegrityGroupMappingRepository.java`          | 诚信互助小组映射聚合               | 抽象客户与诚信互助小组之间的映射关系，供分组拆 target 算法和统计使用                               |
| `RegionCustomerStatisticsRepository.java`       | 区域客户统计聚合                   | 抽象区域客户统计结果的持久化，用于统计报表与分配前置校验                                           |
| `TemporaryCustomerTableRepository.java`         | 临时客户表聚合                     | 抽象临时表的增删查等操作，用于导入/中间计算阶段的缓冲                                               |

> 约束：Domain 层只定义接口，不关心具体存储技术；具体实现位于 `infrastructure/repository/impl`。

---

### 3.3 `service.algorithm` 子层：领域算法服务说明

物理路径：`src/main/java/org/example/domain/service/algorithm`

| 文件名                                          | 职责定位                               | 主要功能简述                                                                                              |
|-------------------------------------------------|----------------------------------------|-----------------------------------------------------------------------------------------------------------|
| `SingleLevelDistributionService.java`           | 单层区域分配算法领域服务接口           | 定义“单区域/简单场景”下，根据客户矩阵和目标量计算分配矩阵的抽象                                         |
| `ColumnWiseAdjustmentService.java`              | 多区域无权重分配算法领域服务接口       | 定义“多区域无权重”场景下，执行整列粗调 + 排序微调的分配算法抽象                                         |
| `GroupSplittingDistributionService.java`        | 多区域带权重分配算法领域服务接口       | 定义“按分组+权重拆分 target，再分别分配”的算法抽象                                                       |
| `impl/SingleLevelDistributionServiceImpl.java`  | 单层区域分配算法领域服务实现           | 复制并整理自历史最新算法实现，保证与原实现结果一致，去除基础设施依赖，便于单元测试与复用                 |
| `impl/ColumnWiseAdjustmentServiceImpl.java`     | 多区域无权重分配算法领域服务实现       | 实现整列粗调 + 微调 + 非递增约束等逻辑，作为 COLUMN_WISE 算法在领域层的唯一权威实现                     |
| `impl/GroupSplittingDistributionServiceImpl.java`| 多区域带权重分配算法领域服务实现     | 实现按分组比例拆分 target、为每个分组调用单层/多区域算法并合并结果的完整过程                            |

> 提示：Application 层的 `DistributionAlgorithmEngine` 已经全部依赖这些领域服务接口，而不再依赖基础设施算法接口。

---

### 3.4 `service.rule` 子层：领域规则服务说明

物理路径：`src/main/java/org/example/domain/service/rule`

| 文件名                                      | 职责定位                       | 主要功能简述                                                                                             |
|---------------------------------------------|--------------------------------|----------------------------------------------------------------------------------------------------------|
| `TagFilterRule.java`                        | 标签过滤规则接口               | 抽象“如何根据标签配置对客户/分区进行过滤”的规则                                                         |
| `EncodingRule.java`                         | 编码规则接口                   | 抽象“如何根据业务含义生成编码表达式”的规则                                                              |
| `BiWeeklyVisitBoostRule.java`               | 双周上浮规则接口               | 抽象与双周上访相关的上浮规则                                                                             |
| `impl/TagFilterRuleImpl.java`              | 标签过滤规则实现               | 根据标签配置和过滤条件，筛选符合条件的客户/分区                                                          |
| `impl/EncodingRuleImpl.java`               | 编码规则实现                   | 实现编码生成的具体规则，与 `EncodeServiceImpl` 协作生成编码                                             |
| `impl/BiWeeklyVisitBoostRuleImpl.java`     | 双周上浮规则实现               | 实现双周拜访相关的提升逻辑，供 `BiWeeklyVisitBoostServiceImpl` 复用                                     |

---

### 3.5 `service.delivery` 子层：投放组合解析等领域服务

物理路径：`src/main/java/org/example/domain/service/delivery`

| 文件名                                  | 职责定位                     | 主要功能简述                                                                                             |
|-----------------------------------------|------------------------------|----------------------------------------------------------------------------------------------------------|
| `DeliveryCombinationParser.java`        | 投放组合解析领域服务         | 将投放方式、扩展投放方式、区域/标签等组合解析为更结构化的信息，供策略编排和算法选择使用                |

---

### 3.6 `model` 与 `event` 子层：领域模型与事件

物理路径：
- `model.entity`：`src/main/java/org/example/domain/model/entity`
- `model.valueobject`：`src/main/java/org/example/domain/model/valueobject`
- `model.tag`：`src/main/java/org/example/domain/model/tag`
- `event`：`src/main/java/org/example/domain/event`

| 子层/文件                         | 职责定位                 | 主要功能简述                                                                                             |
|-----------------------------------|--------------------------|----------------------------------------------------------------------------------------------------------|
| `model/entity/*`                  | 领域实体                 | 表示卷烟、客户、预测记录等核心业务对象，承载业务字段与部分不变式                                       |
| `model/valueobject/*`            | 领域值对象               | 表示如编码组合、档位范围等不可变值对象，通常仅以值相等来判断                                           |
| `model/tag/*`                    | 领域标签模型             | 表示标签本身结构或标签与实体的关联                                                                     |
| `event/DataImportStartedEvent.java` 等 | 领域事件             | 在导入开始/完成/失败、分配生成开始/完成等关键行为发生时发布，用于驱动应用层的统计、监控等              |

---

## 四、Infrastructure 层总体说明（技术细节与外部资源接入层）

Infrastructure 层负责具体技术实现细节：数据库访问、配置、监控以及历史算法实现等，  
为 Domain 和 Application 提供可替换的技术支撑，不承载业务决策。

物理路径：`src/main/java/org/example/infrastructure`

### 4.1 Infrastructure 层子层职责总表

| 子层（包名）                                  | 角色定位                           | 说明                                                                                           |
|-----------------------------------------------|------------------------------------|------------------------------------------------------------------------------------------------|
| `persistence.mapper`                          | MyBatis Mapper 接口                | 描述数据库表级别的 CRUD 与查询语句，由 XML/注解实现 SQL                                       |
| `persistence.po`                              | 持久化对象（PO）                   | 映射数据库表结构的 Java 对象，主要用于 MyBatis 映射                                            |
| `repository.impl`                             | 仓储实现                           | 实现 Domain 层 `repository` 接口，将领域操作翻译为 Mapper 调用                                 |
| `algorithm` / `algorithm.impl`                | 历史版本最新算法实现（对比/回归用）| 保留的基础设施层算法接口与实现，主链路已迁移到 Domain 算法服务，仅用于对比和回归测试          |
| `config`                                      | 基础设施配置                       | 包括线程池/异步、编码规则加载、监控（MeterRegistry）等配置                                    |
| `monitor`                                     | 运行时监控与切面                   | 对事务/执行过程进行监控和日志记录                                                               |

---

### 4.2 `persistence.mapper` 子层：MyBatis Mapper 接口

物理路径：`src/main/java/org/example/infrastructure/persistence/mapper`

| 文件名                                      | 对应聚合/表                         | 主要功能简述                                                                                         |
|---------------------------------------------|-------------------------------------|------------------------------------------------------------------------------------------------------|
| `BaseCustomerInfoMapper.java`               | 基础客户信息表                      | 提供客户基础信息的增删改查与查询接口                                                                 |
| `CigaretteDistributionInfoMapper.java`      | 卷烟分配记录表                      | 提供卷烟分配结果的持久化操作与查询接口                                                               |
| `CigaretteDistributionPredictionMapper.java`| 预测分区表                          | 提供按时间/卷烟代码等维度查询预测分区数据的接口，支撑懒加载聚合等场景                               |
| `CigaretteDistributionPredictionPriceMapper.java` | 价位段预测表                    | 提供价位段预测数据的查询与维护接口                                                                   |
| `RegionCustomerStatisticsMapper.java`       | 区域客户统计表                      | 提供区域客户统计数据的持久化与查询接口                                                               |
| `IntegrityGroupMappingMapper.java`          | 诚信互助小组映射表                  | 提供诚信互助小组与客户关系映射的访问接口                                                             |
| `TemporaryCustomerTableMapper.java`         | 临时客户表                          | 提供导入/中间计算过程中使用的临时客户表的操作接口                                                     |

---

### 4.3 `persistence.po` 子层：持久化对象（PO）

物理路径：`src/main/java/org/example/infrastructure/persistence/po`

| 文件名/子层                      | 职责定位                 | 主要功能简述                                                                                         |
|----------------------------------|--------------------------|------------------------------------------------------------------------------------------------------|
| `*Po.java`                       | 持久化对象（PO）         | 与数据库表字段一一对应，用于 MyBatis 映射，不承载业务逻辑                                           |

---

### 4.4 `repository.impl` 子层：领域仓储实现

物理路径：`src/main/java/org/example/infrastructure/repository/impl`

| 文件名                                                 | 对应领域仓储接口                         | 主要功能简述                                                                                           |
|--------------------------------------------------------|------------------------------------------|--------------------------------------------------------------------------------------------------------|
| `BaseCustomerInfoRepositoryImpl.java`                  | `BaseCustomerInfoRepository`             | 调用 `BaseCustomerInfoMapper` 实现基础客户信息相关的持久化操作                                         |
| `CigaretteDistributionInfoRepositoryImpl.java`         | `CigaretteDistributionInfoRepository`    | 实现卷烟分配记录聚合的查询与写入逻辑                                                                   |
| `CigaretteDistributionPredictionRepositoryImpl.java`   | `CigaretteDistributionPredictionRepository` | 实现预测分区数据的领域仓储接口，包括按批次/卷烟代码的查询等                                       |
| `CigaretteDistributionPredictionPriceRepositoryImpl.java` | `CigaretteDistributionPredictionPriceRepository` | 实现价位段预测数据聚合的仓储逻辑                                                       |
| `IntegrityGroupMappingRepositoryImpl.java`             | `IntegrityGroupMappingRepository`        | 实现诚信互助小组映射的持久化操作                                                                       |
| `RegionCustomerStatisticsRepositoryImpl.java`          | `RegionCustomerStatisticsRepository`     | 实现区域客户统计结果的读写操作                                                                         |
| `TemporaryCustomerTableRepositoryImpl.java`            | `TemporaryCustomerTableRepository`       | 实现临时客户表相关的持久化操作                                                                         |

---

### 4.5 `algorithm` / `algorithm.impl` 子层：历史算法实现（仅对比/回归用途）

物理路径：`src/main/java/org/example/infrastructure/algorithm`

| 文件名                                                 | 职责定位                                     | 主要功能简述                                                                                             |
|--------------------------------------------------------|----------------------------------------------|----------------------------------------------------------------------------------------------------------|
| `SingleLevelDistributionAlgorithm.java`                | 单层区域分配算法接口（历史版本最新）         | 描述单层区域分配算法的接口，Javadoc 标明为“历史版本最新算法，仅用于对比与回归验证”                      |
| `ColumnWiseAdjustmentAlgorithm.java`                   | 多区域无权重分配算法接口（历史版本最新）     | 描述多区域无权重分配算法的接口，Javadoc 标明对应的粗调+微调+非递增约束策略                               |
| `GroupSplittingDistributionAlgorithm.java`             | 多区域带权重分配算法接口（历史版本最新）     | 描述多区域带权重分配算法的接口，Javadoc 标明分组拆分/独立分配/非递增约束等策略                           |
| `impl/DefaultSingleLevelDistributionAlgorithm.java`    | 单层区域分配算法默认实现（历史版本最新）     | 基础设施层的具体实现，主业务已迁移到 Domain 服务，实现仅保留用于对比与回归                              |
| `impl/DefaultColumnWiseAdjustmentAlgorithm.java`       | 多区域无权重分配算法默认实现（历史版本最新） | 对应 COLUMN_WISE 算法的历史实现，已在领域服务中复制并去掉基础设施依赖，用于结果一致性对比               |
| `impl/DefaultGroupSplittingDistributionAlgorithm.java` | 多区域带权重分配算法默认实现（历史版本最新） | 对应 GROUP_SPLITTING 算法的历史实现，仅用于与领域服务实现做回归测试和结果对比                           |

---

### 4.6 `config` 与 `monitor` 子层：基础设施配置与监控

物理路径：
- `config`：`src/main/java/org/example/infrastructure/config`
- `monitor`：`src/main/java/org/example/infrastructure/monitor`

| 文件名/子层                      | 职责定位                   | 主要功能简述                                                                                         |
|----------------------------------|----------------------------|------------------------------------------------------------------------------------------------------|
| `AsyncConfig.java`              | 异步执行配置               | 配置线程池/异步任务相关参数，支撑导入/分配等耗时任务                                                 |
| `encoding/*`                    | 编码规则相关配置           | 从 `encoding-rules.yml` 等配置文件加载编码规则，供领域编码规则使用                                   |
| `MeterRegistryConfig.java`      | 指标监控配置               | 配置监控指标上报（如 Micrometer），便于线上观测                                                       |
| `TransactionMonitor.java`       | 事务/操作监控切面          | 对关键事务或方法进行监控和日志记录，帮助排查问题                                                     |

---

## 五、Shared 层总体说明（跨层共享工具与基础能力）

Shared 层提供跨层复用的基础能力：常量、异常处理、工具方法、辅助服务等，  
不依赖具体业务上下文，尽量保持纯粹与通用。

物理路径：`src/main/java/org/example/shared`

### 5.1 Shared 层子层职责总表

| 子层（包名）                          | 角色定位                   | 说明                                                                                           |
|---------------------------------------|----------------------------|------------------------------------------------------------------------------------------------|
| `constants`                           | 业务/技术常量              | 定义表名、档位、业务编码等常量，避免魔法字符串                                                 |
| `exception`                           | 全局异常处理               | 提供统一的异常处理入口，统一返回格式                                                           |
| `helper`                              | 领域相关的辅助类           | 封装导入/写入/表管理等复用流程片段                                                             |
| `util`                                | 通用工具类                 | 提供字符串、集合、矩阵、校验等通用工具方法                                                     |
| `dto`                                 | 共享 DTO                   | 在多层之间共享的简单数据结构，如区域客户记录                                                   |

---

### 5.2 `constants` / `exception` 子层：常量与全局异常

物理路径：
- `constants`：`src/main/java/org/example/shared/constants`
- `exception`：`src/main/java/org/example/shared/exception`

| 文件名/子层                        | 职责定位                 | 主要功能简述                                                                                         |
|------------------------------------|--------------------------|------------------------------------------------------------------------------------------------------|
| `BusinessConstants.java`          | 业务常量                 | 定义与业务流程相关的固定值，如投放方式、标记位等                                                     |
| `GradeConstants.java`             | 档位常量                 | 定义 D1~D30 等档位相关常量，供算法/统计/展示共同使用                                                 |
| `TableConstants.java`             | 表名常量                 | 定义数据库表名等字符串常量，避免硬编码                                                               |
| `GlobalExceptionHandler.java`     | 全局异常处理器           | 拦截 Controller 层异常，统一封装成标准 API 响应结构                                                  |

---

### 5.3 `helper` / `util` / `dto` 子层：辅助类与工具方法

物理路径：
- `helper`：`src/main/java/org/example/shared/helper`
- `util`：`src/main/java/org/example/shared/util`
- `dto`：`src/main/java/org/example/shared/dto`

| 文件名/子层                            | 职责定位                     | 主要功能简述                                                                                         |
|----------------------------------------|------------------------------|------------------------------------------------------------------------------------------------------|
| `BaseCustomerTableManager.java`        | 基础客户表管理辅助类         | 封装对基础客户表/临时表的通用操作逻辑                                                                 |
| `CigaretteInfoWriter.java`             | 卷烟信息写入辅助类           | 封装将卷烟信息批量写入数据库的通用逻辑                                                               |
| `ExcelParseHelper.java`                | Excel 解析辅助类             | 封装 Excel 文件解析逻辑，供导入流程复用                                                             |
| `ImportValidationHelper.java`          | 导入校验辅助类               | 提供导入数据合法性校验的通用方法                                                                     |
| `IntegrityGroupMappingService.java`    | 诚信互助小组辅助服务         | 对诚信互助小组相关的共性操作进行封装                                                                |
| `ApiResponses.java`                    | API 响应构造工具             | 提供构造标准 API 响应结构的工具方法（如成功/失败包装）                                               |
| `CombinationStrategyAnalyzer.java`     | 组合策略分析工具             | 分析投放组合/策略字符串的结构，为上层编排提供辅助                                                   |
| `GradeParser.java`                     | 档位解析工具                 | 解析档位字符串到内部索引，供算法/统计使用                                                            |
| `KmpMatcher.java`                      | 字符串匹配工具               | 提供 KMP 等字符串匹配算法实现                                                                        |
| `MapValueExtractor.java`               | Map 值提取工具               | 简化从 Map 中安全取值的逻辑                                                                         |
| `OrderCycleMatrixCalculator.java`      | 订货周期矩阵计算工具         | 提供与订货周期相关的矩阵计算逻辑                                                                    |
| `PartitionTableManager.java`           | 分区表管理工具               | 封装分区表相关的操作逻辑                                                                            |
| `RegionNameBuilder.java`               | 区域名称构建工具             | 标准化区域名称的拼接/解析                                                                           |
| `RegionRecordBuilder.java`             | 区域记录构建工具             | 快速构建区域记录对象的辅助方法                                                                     |
| `RequestValidators.java`               | 请求参数校验工具             | 提供对请求参数统一的校验逻辑                                                                       |
| `UploadValidators.java`                | 上传文件校验工具             | 提供对上传文件（如 Excel）的校验逻辑                                                               |
| `dto/RegionCustomerRecord.java`        | 共享 DTO：区域客户记录       | 在多层之间传递的区域客户记录数据结构                                                               |


## 六、关键规则与运维观测（Rules & Operations）

本节从“排查问题”和“理解核心规则”的角度，对聚合规则、算法选择策略、算法日志以及常见异常排查入口做一个集中说明。

### 6.1 聚合规则要点（多区域聚合编码）

多区域聚合编码（即“将多条预测记录组合为一个聚合表达式”）的核心思路：

- **规则 1：同一批次 + 同一卷烟代码才参与聚合**
  - 聚合查询接口会按 `year/month/weekSeq` + `cigCode` 过滤出候选记录。

- **规则 2：关键业务字段一致才能聚合**
  - 如投放方式、扩展投放方式、标签过滤配置等字段必须相同，才能被视为同一组进行表达式合并。

- **规则 3：聚合只在“30 档分配结构相同”的记录之间发生**
  - 若两条记录的 D30~D1 结构完全一致（或满足一定的等价条件），才可以用“编码表达式”合并展示；
  - 否则应当保留为多条记录，避免误解投放含义。

- **规则 4：两层聚合顺序：先主扩展，再子扩展**
  - 先按主扩展投放类型（如“档位+区县”）聚合，再在每一组内部按子扩展维度（如市场类型、标签）进一步聚合；
  - 保证最终表达式既能体现主维度，又不会丢失子维度信息。

> 具体算法实现由 `application/service/encode` 与相关领域规则共同完成，上述规则是阅读代码时的“思维框架”。

---

### 6.2 算法选择策略（DistributionAlgorithmEngine）

在实际分配计算中，`DistributionAlgorithmEngine` 会根据上下文选择不同的领域算法服务进行调用。可以粗略理解为如下策略：

- **输入关键信息**：
  - 实际参与分配的区域集合（区域数量、区域名称列表）；
  - 是否存在分组 + 权重（如城网/农网比例、诚信互助小组比例等）；
  - 请求中传入的扩展投放类型、额外参数（ExtraInfo）等。

- **选择逻辑示意**（伪代码）：

```text
if (区域数 == 1 且无分组/权重) {
    使用 SINGLE_LEVEL 算法（SingleLevelDistributionService）
} else if (存在有效的分组 + 权重参数) {
    使用 GROUP_SPLITTING 算法（GroupSplittingDistributionService）
} else {
    使用 COLUMN_WISE 算法（ColumnWiseAdjustmentService）
}
```

- **决策原则**：
  - **简单场景用简单算法**：单区域直接用单层算法，保持可读性和性能。
  - **有明确分组权重时优先 GROUP_SPLITTING**：保证分组间比例符合业务要求。
  - **其余多区域情况用 COLUMN_WISE**：在多区域、无权重场景下寻找误差最优的分配方案。

---

### 6.3 `DistributionAlgorithmEngine` 日志观测点

算法执行相关的关键日志被集中放在 `DistributionAlgorithmEngine` 中，是排查分配问题的首选入口：

- **进入算法前/选择算法时**：
  - 记录卷烟代码、卷烟名称、投放方式、扩展投放方式、标签、区域数量等信息；
  - 记录被选中的算法类型（SINGLE_LEVEL / COLUMN_WISE / GROUP_SPLITTING）；
  - 若存在分组比例（如城网/农网、诚信互助小组），会记录各分组权重。

- **算法执行完成后**：
  - 统一记录一次“算法结果”日志，包含：
    - 算法类型；
    - 目标投放量（target）；
    - 实际投放量（actual）；
    - 误差（error = |target - actual|）；
    - 区域数量、矩阵维度等。

- **使用建议**：
  - 若线上反馈“分配不准”或“误差偏大”，可以先根据卷烟代码/批次在日志中搜索对应算法执行日志，查看：
    - 实际使用的算法类型是否符合预期；
    - target/actual/error 是否在可接受范围；
    - 分组比例是否传入/解析正确。

---

### 6.4 常见异常与排查入口

下面列出一些常见问题场景以及推荐的排查路径：

| 问题现象                                   | 可能原因示例                                         | 推荐排查入口                                                                                   |
|--------------------------------------------|------------------------------------------------------|------------------------------------------------------------------------------------------------|
| 实际投放量与目标量误差过大                 | 预测源数据异常、市场比例参数错误、算法选择不符合预期 | 查看 `DistributionAlgorithmEngine` 日志中的 target/actual/error 以及算法类型；检查输入参数   |
| 多区域聚合编码表达式“不符合直觉”          | 聚合规则匹配条件不满足、某些字段不一致导致未聚合     | 检查 `AggregatedEncodingQueryService` 相关日志和 SQL，核对参与聚合的记录字段是否完全一致     |
| 某些区域/卷烟“没有生成分配记录”           | 输入数据缺失、过滤规则（标签/组合）过严              | 查看生成分配方案的集成测试或日志，检查过滤规则、区域客户矩阵是否为空                         |
| 导入过程频繁失败                           | Excel 模板格式变更、字段校验不通过                   | 查看导入接口日志、`DataImportEventHandler` 日志，以及 `ImportValidationHelper` 的校验信息     |
| 价位段预测查询结果异常                     | 价位段预测表数据不完整或 SQL 条件不正确             | 检查 `CigaretteDistributionPredictionPriceMapper` 相关 SQL 与调用参数                          |

> 建议：遇到问题时，优先沿“Controller → Application Service → Orchestrator → AlgorithmEngine / Domain Service → Repository/Mapper”这条链路向下排查，并结合日志与数据库实际数据交叉验证。

---


