# 卷烟分配误差分析报告

**分析时间**: 2025-12-20  
**数据分区**: 2025年9月第3周  
**测试类型**: 全链路分配测试

> ⚠️ **重要说明**: 
> - **预期投放量**: 取自 `cigarette_distribution_info` 表的 `ADV` 字段
> - **实际投放量**: 取自 `cigarette_distribution_prediction` 表的 `ACTUAL_DELIVERY` 字段总和
> - 对于扩展投放类型，prediction表会有多条记录（每个子区域一条），需要求和后再与info表的ADV比较

---

## 📊 总体统计

| 指标 | 数值 |
|------|------|
| 总卷烟数 | 49种 |
| 总分配记录数 | 76条 |
| 预期投放总量 (ADV) | 2,137,728 |
| 实际投放总量 | 2,137,496 |
| 总体差异 | 232 (0.01%) |

---

## 🎯 误差统计

### 绝对误差
- **最大绝对误差**: **73条**
- **平均绝对误差**: **26条**

### 相对误差
- **最大相对误差**: **12.59%**
- **平均相对误差**: **0.82%**

---

## 📋 误差最大的TOP 10卷烟

| 排名 | 卷烟代码 | 卷烟名称 | 投放方法 | 预期投放量 | 实际投放量 | 绝对误差 | 相对误差% |
|------|---------|---------|---------|-----------|-----------|---------|-----------|
| 1 | 31020002 | 中华(硬) | 按档位投放 | 161,708 | 161,635 | 73 | 0.05% |
| 2 | 42020005 | 黄鹤楼(软红) | 按档位投放 | 67,551 | 67,480 | 71 | 0.11% |
| 3 | 42021111 | 黄楼(蓝) | 按档位投放 | 115,575 | 115,644 | 69 | 0.06% |
| 4 | 41010085 | 黄金叶(商鼎) | 按档位投放 | 18,560 | 18,496 | 64 | 0.34% |
| 5 | 51010126 | 娇子(宽窄锦上细支) | 按档位扩展投放 | 798 | 745 | 53 | 6.64% |
| 6 | 61020034 | 好猫(长乐九美) | 按档位统一投放 | 201,613 | 201,562 | 51 | 0.03% |
| 7 | 43500068 | 芙蓉王(沁爽细支) | 按档位投放 | 397 | 447 | 50 | 12.59% |
| 8 | 51010104 | 娇子(宽窄好运) | 按档位投放 | 125,000 | 125,050 | 50 | 0.04% |
| 9 | 42020128 | 黄鹤楼(硬8度) | 按档位投放 | 9,211 | 9,258 | 47 | 0.51% |
| 10 | 42020117 | 黄鹤楼(硬峡谷柔情) | 按档位投放 | 46,218 | 46,171 | 47 | 0.10% |

---

## 🔍 关键发现

### 1. 投放方法分析
- **按档位投放**: 误差极小（0.04%-0.51%）
- **按档位扩展投放**: 误差略大但仍在合理范围（6.64%）
- **按档位统一投放**: 误差极小（0.03%）

### 2. 误差特征分析

#### ✅ **超高精度（<1%）**
- **44种卷烟**的相对误差都在1%以内
- 绝对误差主要集中在50-73条之间
- 说明分配算法整体性能优秀

**典型案例**:
- **中华(硬)**: 0.05%误差，绝对误差73条（总量16万+）
- **黄鹤楼(软红)**: 0.11%误差，绝对误差71条（总量6.7万+）
- **好猫(长乐九美)**: 0.03%误差，绝对误差51条（总量20万+）

#### ⚠️ **中等误差（5%-15%）**
- **芙蓉王(沁爽细支)**: 12.59%误差，但绝对误差仅50条（总量397条，小批量卷烟）
- **娇子(宽窄锦上细支)**: 6.64%误差，绝对误差53条（总量798条，小批量卷烟）

**原因分析**:
1. 这些都是**小批量卷烟**（总量<1000条）
2. 小批量情况下，即使绝对误差很小（50条左右），相对误差也会被放大
3. 从绝对误差角度看，完全在可接受范围内

---

## 🎉 性能评估

### 精度等级分布

| 精度等级 | 误差范围 | 卷烟数量 | 占比 |
|---------|---------|---------|------|
| 🏆 极优 | < 0.5% | 42种 | 85.7% |
| ✅ 优秀 | 0.5% - 5% | 5种 | 10.2% |
| ⚠️ 良好 | 5% - 15% | 2种 | 4.1% |
| ❌ 需优化 | > 15% | 0种 | 0% |

---

## 💡 技术分析

### 1. 算法性能表现

#### ✨ **优势**
1. **高精度**: 85.7%的卷烟误差<0.5%
2. **稳定性**: 平均绝对误差仅26条
3. **覆盖率**: 100%成功分配率

#### 📌 **小批量卷烟处理**
- 对于投放量<1000条的卷烟，相对误差可能较大（6%-13%）
- 但绝对误差仍然很小（50条左右）
- 这是小批量分配的正常现象

### 2. 误差来源分析

1. **客户数取整**: 客户数必须是整数，导致无法完全精确匹配
2. **多区域分配**: 扩展投放涉及多个子区域，每个子区域的取整累积产生误差
3. **算法优化**: 算法优先保证整体误差最小，可能牺牲个别卷烟的精度

---

## 🔧 改进建议

### 针对小批量卷烟
1. **放宽误差容忍度**: 对投放量<1000条的卷烟，允许10%-15%的相对误差
2. **优化取整策略**: 考虑使用更智能的取整算法减少累积误差
3. **预警阈值调整**: 根据投放量动态调整预警阈值

### 针对扩展投放
1. **子区域平衡**: 优化多区域分配时的误差分散策略
2. **反向验证**: 分配后验证总量是否符合预期，必要时进行微调

### 针对超大批量卷烟
1. **精度提升**: 对投放量>10万的卷烟，尽可能降低相对误差到0.1%以内
2. **优先级调整**: 大批量卷烟优先分配，确保精度

---

## ✅ 测试结论

### 🎯 核心指标
- **成功率**: **100%** (49/49种卷烟全部完成分配)
- **平均相对误差**: **0.82%** (优秀)
- **最大相对误差**: **12.59%** (可接受)
- **总体精度**: **99.99%** (实际与预期总量仅差232条/213万+)

### 🏆 综合评价
**优秀** - 分配算法整体性能表现卓越！

✅ **优点**:
1. 高精度：95.9%的卷烟误差<5%
2. 高稳定性：所有卷烟均成功分配
3. 高效率：总体误差控制在0.01%以内

⚠️ **改进空间**:
1. 小批量卷烟的相对误差可以进一步优化
2. 可以考虑实施动态误差容忍策略

---

## 📝 误差计算说明

### ❌ **错误的计算方式（之前的版本）**
```sql
-- 错误：对info表的ADV进行了SUM，导致预期值被放大
SUM(i.ADV) as total_adv  -- 如果一个卷烟只有1条info记录，但被SUM了多次
```

### ✅ **正确的计算方式（当前版本）**
```sql
-- 正确：info表的ADV直接就是该卷烟的预期总投放量
i.ADV as expected_total,  -- 单条记录，无需SUM
SUM(p.ACTUAL_DELIVERY) as actual_total  -- prediction表需要SUM所有子区域
```

**关键区别**:
- `cigarette_distribution_info` 表：每个卷烟只有**1条记录**，`ADV`字段就是该卷烟的预期总投放量
- `cigarette_distribution_prediction` 表：每个卷烟可能有**多条记录**（每个子区域一条），需要对`ACTUAL_DELIVERY`求和得到实际总投放量

---

**报告生成时间**: 2025-12-20 22:05  
**分析工具**: MySQL + 全链路测试框架  
**数据来源**: 2025年9月第3周分配结果

