<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
  CigaretteDistributionInfoMapper XML
  作用：承载卷烟投放信息表的 UPSERT 与定点更新 SQL。
  约定：namespace 对应 org.example.infrastructure.persistence.mapper.CigaretteDistributionInfoMapper，方法名与接口保持一致。
-->
<mapper namespace="org.example.infrastructure.persistence.mapper.CigaretteDistributionInfoMapper">

    <!-- 单条 UPSERT -->
    <insert id="upsert" parameterType="org.example.infrastructure.persistence.po.CigaretteDistributionInfoPO">
        INSERT INTO `cigarette_distribution_info`
        (YEAR, MONTH, WEEK_SEQ, CIG_CODE, CIG_NAME, SUPPLY_ATTRIBUTE, URS, DELIVERY_METHOD, DELIVERY_ETYPE, TAG,
         ADV, DELIVERY_AREA, BZ, TAG_FILTER_CONFIG)
        VALUES (#{year}, #{month}, #{weekSeq}, #{cigCode}, #{cigName}, #{supplyAttribute}, #{urs},
                #{deliveryMethod}, #{deliveryEtype}, #{tag}, #{adv}, #{deliveryArea}, #{bz}, #{tagFilterConfig})
        ON DUPLICATE KEY UPDATE
            SUPPLY_ATTRIBUTE = VALUES(SUPPLY_ATTRIBUTE),
            URS              = VALUES(URS),
            DELIVERY_METHOD  = VALUES(DELIVERY_METHOD),
            DELIVERY_ETYPE   = VALUES(DELIVERY_ETYPE),
            TAG              = VALUES(TAG),
            ADV              = VALUES(ADV),
            DELIVERY_AREA    = VALUES(DELIVERY_AREA),
            BZ               = VALUES(BZ),
            TAG_FILTER_CONFIG= VALUES(TAG_FILTER_CONFIG),
            UPDATED_AT       = CURRENT_TIMESTAMP
    </insert>

    <!-- 批量 UPSERT -->
    <insert id="batchUpsert" parameterType="java.util.List">
        INSERT INTO `cigarette_distribution_info`
        (YEAR, MONTH, WEEK_SEQ, CIG_CODE, CIG_NAME, SUPPLY_ATTRIBUTE, URS, DELIVERY_METHOD, DELIVERY_ETYPE, TAG,
         ADV, DELIVERY_AREA, BZ, TAG_FILTER_CONFIG)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.year}, #{item.month}, #{item.weekSeq}, #{item.cigCode}, #{item.cigName}, #{item.supplyAttribute}, #{item.urs},
             #{item.deliveryMethod}, #{item.deliveryEtype}, #{item.tag}, #{item.adv}, #{item.deliveryArea}, #{item.bz}, #{item.tagFilterConfig})
        </foreach>
        ON DUPLICATE KEY UPDATE
            SUPPLY_ATTRIBUTE = VALUES(SUPPLY_ATTRIBUTE),
            URS              = VALUES(URS),
            DELIVERY_METHOD  = VALUES(DELIVERY_METHOD),
            DELIVERY_ETYPE   = VALUES(DELIVERY_ETYPE),
            TAG              = VALUES(TAG),
            ADV              = VALUES(ADV),
            DELIVERY_AREA    = VALUES(DELIVERY_AREA),
            BZ               = VALUES(BZ),
            TAG_FILTER_CONFIG= VALUES(TAG_FILTER_CONFIG),
            UPDATED_AT       = CURRENT_TIMESTAMP
    </insert>

    <!-- 按主键（年月周 + CIG_CODE/CIG_NAME）定点更新 -->
    <update id="updateOne" parameterType="org.example.infrastructure.persistence.po.CigaretteDistributionInfoPO">
        UPDATE `cigarette_distribution_info`
        SET SUPPLY_ATTRIBUTE = #{supplyAttribute},
            URS              = #{urs},
            DELIVERY_METHOD  = #{deliveryMethod},
            DELIVERY_ETYPE   = #{deliveryEtype},
            TAG              = #{tag},
            ADV              = #{adv},
            DELIVERY_AREA    = #{deliveryArea},
            BZ               = #{bz},
            TAG_FILTER_CONFIG= #{tagFilterConfig},
            UPDATED_AT       = CURRENT_TIMESTAMP
        WHERE YEAR = #{year}
          AND MONTH = #{month}
          AND WEEK_SEQ = #{weekSeq}
          AND CIG_CODE = #{cigCode}
          AND CIG_NAME = #{cigName}
    </update>

    <!-- 查询不重复投放组合 -->
    <select id="findDistinctCombinations" resultType="java.util.LinkedHashMap">
        SELECT DISTINCT DELIVERY_METHOD, DELIVERY_ETYPE, TAG
        FROM `cigarette_distribution_info`
        WHERE YEAR = #{year} AND MONTH = #{month} AND WEEK_SEQ = #{weekSeq}
    </select>

    <!-- 查询指定分区内"按价位段自选投放"卷烟的候选列表（含批发价） -->
    <!-- 注意：按价位段自选投放的卷烟投放区域应该都是"全市"，每条卷烟只返回一条记录 -->
    <!-- 如果同一条卷烟有多条记录（不同DELIVERY_ETYPE、TAG等），只取第一条 -->
    <select id="findPriceBandCandidates" resultType="java.util.LinkedHashMap">
        SELECT
            i.YEAR,
            i.MONTH,
            i.WEEK_SEQ,
            i.CIG_CODE,
            i.CIG_NAME,
            '全市' AS DELIVERY_AREA,
            i.DELIVERY_METHOD,
            NULL AS DELIVERY_ETYPE,
            MAX(i.ADV) AS ADV,
            p.WHOLESALE_PRICE
        FROM `cigarette_distribution_info` i
        JOIN `base_cigarette_price` p
          ON i.CIG_CODE = p.CIG_CODE
        WHERE i.YEAR = #{year}
          AND i.MONTH = #{month}
          AND i.WEEK_SEQ = #{weekSeq}
          AND i.DELIVERY_METHOD = '按价位段自选投放'
        GROUP BY i.CIG_CODE, i.CIG_NAME, i.YEAR, i.MONTH, i.WEEK_SEQ, i.DELIVERY_METHOD, p.WHOLESALE_PRICE
    </select>

</mapper>

