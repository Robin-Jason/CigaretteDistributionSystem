## 📋 文档目的

本说明文档用于**汇总与细化**当前卷烟分配系统中，基于 Spring Event 的事件驱动改造后续工作计划。  
目标是在**不引入 MQ** 的前提下，先把**应用内事件模型、监控与可观测性、测试与文档**打牢，并为未来平滑演进到 RocketMQ 等消息中间件预留空间。

---

## 🎯 总体目标

- **统一事件模型**：导入与分配相关事件拥有统一、稳定的批次标识（`batchId`）和可选的请求追踪标识（`requestId`），便于串联全链路。
- **增强可观测性**：对“一键生成分配方案”和“数据导入”构建批次级、流程级监控视图，支撑性能分析与误差分析。
- **控制复杂度**：在仅使用 Spring Event 的前提下，避免过度事件化导致的调试困难和潜在死锁问题，保持主交易写入路径清晰、可控。
- **平滑可演进**：通过抽象层与约定，为未来接入 MQ（如 RocketMQ）提前设计好事件模型和扩展点，减少二次重构成本。

---

## 1️⃣ 事件模型的轻量统一

### 1.1 统一事件字段与命名规范

- **统一字段（已初步完成，后续需要文档固化与代码巡检）**
  - **`year` / `month` / `weekSeq`**：批次时间维度的三元组，导入与分配事件中保持一致含义。
  - **`batchId`**：  
    - 含义：本次导入 / 分配批次的统一标识，用于串联同一时间维度下的事件。  
    - 生成规则：`year-month-weekSeq`，例如：`2025-9-3`。  
    - 范围：目前已在以下事件类中统一：
      - `DistributionPlanGenerationStartedEvent`
      - `DistributionPlanGenerationCompletedEvent`
      - `ExistingDataDeletedEvent`
      - `DataImportStartedEvent`
      - `DataImportCompletedEvent`
      - `DataImportFailedEvent`
  - **`requestId`（预留，可选）**：
    - 含义：一次 HTTP 请求或上游系统调用的全局追踪 ID。  
    - 建议来源：后续可结合 MDC（例如 `X-Request-Id` 头）透传。

- **待办工作**
  - **[ ] 文档化事件字段规范**
    - 在 `DDD分层完整目录结构.md` / 本文中增加「事件字段规范」小节，说明各字段语义与使用场景。
  - **[ ] 巡检所有事件类**
    - 确认所有保留的事件都已具备 `batchId` 字段，构造函数中统一通过内部方法 `buildBatchId(year, month, weekSeq)` 生成。
  - **[ ] 监听器日志优化**
    - 在 `DataImportEventHandler` / `DistributionPlanMonitorHandler` 中的日志输出中显式打印 `batchId`，便于后续按批次检索。

### 1.2 事件与外部接口的约定

- **API 层（VO）与应用层（DTO）的字段对齐**
  - 当前 VO/DTO 已包含 `year` / `month` / `weekSeq` 字段，事件类通过这些字段构造 `batchId`，无需 API 改动即可统一批次。
  - **后续可选工作：**
    - **[ ] 在 API 文档中补充说明**：  
      “同一批次的导入与分配请求应使用相同的年 / 月 / 周序号，以便形成统一的 `batchId` 并支持后续链路追踪与误差分析。”

---

## 2️⃣ 监控与可观测性增强

### 2.1 批次级监控指标设计

- **目标**：将“数据导入”和“一键生成分配方案”两条链路做成**可观测的批次任务**。
- **设计要点**
  - 以 `batchId` 为主键，对一次导入 / 分配任务的以下指标进行采集：
    - 开始时间 / 结束时间 / 耗时（ms）
    - 成功标记（`success`）与失败原因（错误码、错误信息）
    - 行数/条数统计（导入行数、成功分配的卷烟种类数、写回记录条数等）
  - 通过现有事件：
    - 导入：`DataImportStartedEvent` / `DataImportCompletedEvent` / `DataImportFailedEvent`
    - 分配：`DistributionPlanGenerationStartedEvent` / `ExistingDataDeletedEvent` / `DistributionPlanGenerationCompletedEvent`

- **待办工作**
  - **[ ] 在监听器中增加结构化日志**
    - 以 JSON 风格或 key-value 风格输出，至少包含：`batchId`、时间戳、耗时、success、message。
  - **[ ] 预留接入监控系统的接口**
    - 在 `DistributionPlanMonitorHandler` / `DataImportEventHandler` 中添加 TODO 或简单的 `metricsService` 调用接口（当前可空实现），为未来集成 Micrometer / Prometheus 做准备。

### 2.2 统一监控视图构想（文档层）

- **暂不实现 UI / 报表，只在文档中明确结构：**
  - **导入监控视图**
    - 维度：`batchId`、导入日期、文件类型（客户表/卷烟表）、成功/失败、耗时。
  - **分配监控视图**
    - 维度：`batchId`、耗时、成功卷烟种类数 / 总种类数、生成记录数、误差统计指标（预留）。
  - **统一入口**
    - 将导入 + 分配的批次视为一个“业务批次任务”，通过 `batchId` 从两个视图中联动查询。

---

## 3️⃣ 事件驱动向 MQ 的平滑演进设计（仅设计，不实施）

> 前提：**当前阶段不引入 MQ，仅做文档与抽象层设计**。

### 3.1 抽象层设计思路

- **目标**：未来接入 RocketMQ 时，不需要大面积修改应用服务和领域服务，只在事件“发布/订阅”边界引入适配层。
- **建议方案**
  - **应用内事件接口层**
    - 定义统一的事件发布接口 `DomainEventPublisher`，内部默认实现基于 Spring Event。
  - **MQ 适配层（未来）**
    - 新增实现 `MqDomainEventPublisher`，在统一的事件模型上，将关键事件转换为 MQ 消息发送。
  - **事件模型稳定性**
    - 通过本轮的 `batchId` + 时间维度统一，与 MQ 消息的 Topic/Tag 设计保持一致。

- **待办工作（仅文档级别）**
  - **[ ] 在本文中补充“发布接口抽象”设计示意**
  - **[ ] 标注首批适合上 MQ 的事件候选**
    - 如：跨系统通知型事件（而非本系统内部写回事务）。

---

## 4️⃣ 测试与回归策略补充

### 4.1 事件链路测试策略

- **集成测试**
  - 通过 MockMvc 或服务层集成测试：
    - 触发数据导入 / 一键分配接口。
    - 验证关键事件是否被正确发布（可以通过注入测试用监听器或使用 Spring 的 `ApplicationEventPublisher` / `ApplicationListener` 机制捕获）。
  - **待办：**
    - **[ ] 为导入流程增加事件链路集成测试用例**
    - **[ ] 为分配流程增加事件链路集成测试用例**

- **并发与死锁回归测试**
  - 背景：曾经出现过 `DeadlockLoserDataAccessException`，原因是过细粒度的异步写回与主事务竞争锁。
  - 策略：
    - 保持当前“**分配写回仍在主线程事务中同步执行，仅将高层流程状态事件异步/解耦**”的策略。
    - 在并发测试脚本中重点覆盖：
      - 多批次并发触发“一键分配”。
      - 导入与分配交错执行的场景。
  - **待办：**
    - **[ ] 设计并发测试场景清单（文档级）**
    - **[ ] 在可行范围内补充 1~2 个关键并发集成测试用例**

---

## 5️⃣ 与架构文档的联动更新

### 5.1 更新 `DDD分层完整目录结构.md`

- **待办工作**
  - **[ ] 在领域层 `domain/event` 小节中，补充 `batchId` 字段说明**，标注事件的统一批次标识设计。
  - **[ ] 在应用层事件监听小节中，说明监控/统计主要依赖事件实现，而非侵入主服务代码。**

### 5.2 更新《高内聚低耦合优化措施分析》

- **补充内容方向**
  - 说明事件驱动带来的高内聚低耦合收益：
    - 主流程只关注“做成这件事”，监控/统计/审计通过事件扩展。
  - 明确当前阶段的边界：
    - 不对核心写回路径做异步拆分，优先保证一致性与可控性。
  - 把本文件中的“后续事件化与 MQ 演进计划”以摘要形式同步进去。

---

## ✅ 小结

- 当前系统已完成**基础 Spring Event 集成**，并在导入与分配流程中发布了关键过程事件。
- 本文梳理了**后续工作方向**：  
  - 事件模型轻量统一（以 `batchId` 为核心）。  
  - 批次级监控与可观测性增强。  
  - 事件驱动向 MQ 的平滑演进设计（暂不落地）。  
  - 事件链路与并发场景的测试补充。  
  - 与 DDD 架构与高内聚低耦合文档的联动更新。  
- 以上工作可以**按优先级与时间拆分逐步实施**，不会对现有主流程造成大规模侵入式改动，适合在项目演进过程中逐步落地。


