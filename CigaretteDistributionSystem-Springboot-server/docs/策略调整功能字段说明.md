# 策略调整功能字段说明

## 修改日期
2025-12-23

## 功能概述

策略调整与重算功能允许用户修改某个卷烟的投放策略（投放类型、投放区域、标签、投放量等），并重新执行分配算法生成新的分配方案。

## 完整字段列表

### 1. 必填字段

#### 1.1 时间维度
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `year` | Integer | 年份 | 2025 |
| `month` | Integer | 月份（1-12） | 9 |
| `weekSeq` | Integer | 周序号（1-5） | 3 |

#### 1.2 卷烟标识
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `cigCode` | String | 卷烟代码 | "42010020" |
| `cigName` | String | 卷烟名称 | "红金龙(硬神州腾龙)" |

#### 1.3 新投放策略
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `newDeliveryMethod` | String | 新投放类型 | "按档位投放"、"按档位扩展投放" |
| `newAdvAmount` | BigDecimal | 新建议投放量（条） | 1000 |
| `newDeliveryAreas` | List<String> | 新投放区域列表（笛卡尔积后） | ["丹江（城网）", "丹江（农网）"] |

**`newDeliveryAreas` 字段说明：**
- 用户需要传入笛卡尔积后的完整区域列表
- 每个区域对应分配矩阵的一行
- 区域顺序会影响分配结果的顺序
- 如果是双扩展，建议主扩展写在括号外，子扩展写在括号内

**格式示例：**
```json
// 单扩展单区域
["全市"]

// 单扩展多区域
["丹江", "郧西", "竹山"]

// 双扩展（区县+市场类型）
["丹江（城网）", "丹江（农网）", "郧西（城网）", "郧西（农网）"]

// 双扩展（市场类型+区县）
["城网（丹江）", "城网（郧西）", "农网（丹江）", "农网（郧西）"]
```

### 2. 可选字段

#### 2.1 扩展投放类型
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `newDeliveryEtype` | String | 新扩展投放类型 | "市场类型"、"区县"、"诚信互助小组" |

#### 2.2 标签过滤
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `newTag` | String | 新标签（最多1个） | "优质数据共享客户"、"优质客户" |
| `newTagFilterValue` | String | 新标签过滤值（与 newTag 配套使用） | "是" |

**注意：** 如果指定了 `newTag`，必须同时指定 `newTagFilterValue`。

#### 2.3 档位范围
| 字段名 | 类型 | 说明 | 默认值 | 示例 |
|--------|------|------|--------|------|
| `newHighestGrade` | String | 新最高档位（HG） | "D30" | "D30"、"D25" |
| `newLowestGrade` | String | 新最低档位（LG） | "D1" | "D1"、"D15" |

**说明：**
- 指定分配算法的档位范围
- 如果不指定，默认使用 D30-D1（全档位）
- 可以限制分配范围，例如只分配到 D25-D15

#### 2.4 市场类型比例
| 字段名 | 类型 | 说明 | 默认值 | 示例 |
|--------|------|------|--------|------|
| `urbanRatio` | BigDecimal | 城网比例 | 0.4 | 0.6 |
| `ruralRatio` | BigDecimal | 农网比例 | 0.6 | 0.4 |

**说明：**
- 仅当投放类型包含"市场类型"扩展时有效
- `urbanRatio` 和 `ruralRatio` 必须同时指定或同时不指定
- 如果不指定，使用默认比例 0.4（城网）: 0.6（农网）

#### 2.5 备注
| 字段名 | 类型 | 说明 | 默认值 | 示例 |
|--------|------|------|--------|------|
| `newRemark` | String | 新备注（用于 Info 表） | 自动生成 | "人工调整-特殊需求" |

**说明：**
- 用于更新 Info 表的 `BZ` 字段
- 如果不指定，系统会自动生成备注："已人工调整策略{投放类型}（标签）"
- 预测表（prediction/prediction_price）的备注固定为"人工已确认投放组合与投放区域修改"，不受此字段影响

## 请求示例

### 示例1：单扩展单区域（按档位投放）

```json
{
  "year": 2025,
  "month": 9,
  "weekSeq": 3,
  "cigCode": "42010020",
  "cigName": "红金龙(硬神州腾龙)",
  "newDeliveryMethod": "按档位投放",
  "newAdvAmount": 1000,
  "newDeliveryAreas": ["全市"]
}
```

### 示例2：单扩展多区域（按档位+区县）

```json
{
  "year": 2025,
  "month": 9,
  "weekSeq": 3,
  "cigCode": "42010020",
  "cigName": "红金龙(硬神州腾龙)",
  "newDeliveryMethod": "按档位扩展投放",
  "newDeliveryEtype": "区县",
  "newAdvAmount": 1000,
  "newDeliveryAreas": ["丹江", "郧西", "竹山"]
}
```

### 示例3：双扩展+标签+档位范围（按档位+区县+市场类型）

```json
{
  "year": 2025,
  "month": 9,
  "weekSeq": 3,
  "cigCode": "42010020",
  "cigName": "红金龙(硬神州腾龙)",
  "newDeliveryMethod": "按档位扩展投放",
  "newDeliveryEtype": "区县+市场类型",
  "newTag": "优质数据共享客户",
  "newTagFilterValue": "是",
  "newAdvAmount": 1000,
  "newDeliveryAreas": [
    "丹江（城网）",
    "丹江（农网）",
    "郧西（城网）",
    "郧西（农网）"
  ],
  "newHighestGrade": "D25",
  "newLowestGrade": "D15",
  "urbanRatio": 0.6,
  "ruralRatio": 0.4,
  "newRemark": "人工调整-优质客户专项"
}
```

### 示例4：市场类型扩展+自定义比例

```json
{
  "year": 2025,
  "month": 9,
  "weekSeq": 3,
  "cigCode": "42010020",
  "cigName": "红金龙(硬神州腾龙)",
  "newDeliveryMethod": "按档位扩展投放",
  "newDeliveryEtype": "市场类型",
  "newAdvAmount": 1000,
  "newDeliveryAreas": ["城网", "农网"],
  "urbanRatio": 0.7,
  "ruralRatio": 0.3
}
```

## 字段校验规则

### 必填字段校验
1. `year`：2020-2100之间的整数
2. `month`：1-12之间的整数
3. `weekSeq`：1-5之间的整数
4. `cigCode`、`cigName`：不能为空
5. `newDeliveryMethod`：不能为空
6. `newAdvAmount`：必须大于0
7. `newDeliveryAreas`：不能为空，至少包含1个区域

### 可选字段校验
1. `newTag` 和 `newTagFilterValue`：如果指定了 `newTag`，必须同时指定 `newTagFilterValue`
2. `urbanRatio` 和 `ruralRatio`：必须同时指定或同时不指定
3. `newHighestGrade` 和 `newLowestGrade`：必须是有效的档位格式（如 "D30"、"D1"）

### 业务校验
1. **卷烟存在性**：指定的卷烟必须在 Info 表中存在
2. **标签存在性**：如果指定了标签，必须在 `customer_filter` 表中存在（固定标签或动态标签）
3. **区域有效性**：指定的投放区域必须在 `region_customer_statistics` 表中有对应的客户数据

## 数据流说明

### 1. Info 表更新
- 更新字段：`BZ`（备注）
- 备注内容：使用 `newRemark`（如果指定），否则自动生成

### 2. 预测表写入
- 根据 `newDeliveryMethod` 判断写入哪个表：
  - "按价位段自选投放" → `cigarette_distribution_prediction_price` 表
  - 其他投放类型 → `cigarette_distribution_prediction` 表
- 预测表的备注固定为："人工已确认投放组合与投放区域修改"

### 3. 分配算法执行
- 使用 `newDeliveryAreas` 构建客户矩阵
- 使用 `newHighestGrade` 和 `newLowestGrade` 限制档位范围
- 使用 `urbanRatio` 和 `ruralRatio` 设置市场类型比例
- 使用 `newTag` 和 `newTagFilterValue` 过滤客户

## 注意事项

1. **投放区域列表的重要性**：
   - 必须传入笛卡尔积后的完整区域列表
   - 区域顺序会影响分配结果在数据库中的存储顺序
   - 如果是双扩展，建议主扩展写在括号外

2. **档位范围的影响**：
   - 限制档位范围会影响分配算法的计算结果
   - 例如只分配到 D25-D15，则 D30-D26 和 D14-D1 的分配值为0

3. **市场类型比例的生效条件**：
   - 只在投放类型包含"市场类型"扩展时生效
   - 必须同时指定 `urbanRatio` 和 `ruralRatio`
   - 比例不需要总和为1，系统会自动归一化

4. **备注字段的双重用途**：
   - Info 表的备注：使用 `newRemark` 或自动生成
   - 预测表的备注：固定为"人工已确认投放组合与投放区域修改"

## 相关文件

- DTO：`AdjustCigaretteStrategyRequestDto.java`
- Service：`CigaretteStrategyAdjustServiceImpl.java`
- Controller：`DistributionCalculateController.java`
- API 端点：`POST /api/calculate/adjust-strategy`
