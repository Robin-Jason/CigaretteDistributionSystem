# 获取可用投放区域列表功能说明

## 功能概述

本功能为策略调整功能提供辅助接口，根据投放类型和扩展类型返回可选的区域列表。如果某些区域在 `region_customer_statistics` 表中不存在，系统会自动追加构建这些区域的客户数据，然后返回完整的区域列表。

## 业务场景

在策略调整功能中，用户需要选择新的投放区域。为了提供准确的区域选项，前端需要：

1. 获取该投放组合（投放类型 + 扩展类型）对应的所有可能区域
2. 确保这些区域的客户数据已经构建完成
3. 将区域列表展示给用户选择

## 接口定义

### 请求端点

```
POST /api/calculate/available-regions
```

### 请求参数

| 字段名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| year | Integer | 是 | 年份 | 2025 |
| month | Integer | 是 | 月份（1-12） | 9 |
| weekSeq | Integer | 是 | 周序号（1-5） | 3 |
| deliveryMethod | String | 是 | 投放类型 | "按档位投放" |
| deliveryEtype | String | 否 | 扩展类型 | "区县公司+市场类型" |

### 请求示例

```json
{
  "year": 2025,
  "month": 9,
  "weekSeq": 3,
  "deliveryMethod": "按档位投放",
  "deliveryEtype": "区县公司+市场类型"
}
```

### 响应参数

| 字段名 | 类型 | 说明 |
|--------|------|------|
| success | Boolean | 是否成功 |
| message | String | 消息 |
| availableRegions | List<String> | 可用区域列表 |
| hasBuiltNewData | Boolean | 是否构建了新数据 |
| builtRegions | List<String> | 构建的区域列表 |

### 响应示例

#### 场景1：所有区域数据已存在

```json
{
  "code": "SUCCESS",
  "message": "所有区域数据已存在",
  "data": {
    "success": true,
    "message": "所有区域数据已存在",
    "availableRegions": [
      "丹江（城网）",
      "丹江（农网）",
      "郧西（城网）",
      "郧西（农网）"
    ],
    "hasBuiltNewData": false,
    "builtRegions": []
  }
}
```

#### 场景2：追加构建了新区域数据

```json
{
  "code": "SUCCESS",
  "message": "成功追加构建 2 个区域的客户数据",
  "data": {
    "success": true,
    "message": "成功追加构建 2 个区域的客户数据",
    "availableRegions": [
      "丹江（城网）",
      "丹江（农网）",
      "郧西（城网）",
      "郧西（农网）"
    ],
    "hasBuiltNewData": true,
    "builtRegions": [
      "郧西（城网）",
      "郧西（农网）"
    ]
  }
}
```

## 实现逻辑

### 核心流程

1. **解析理论区域**
   - 根据投放类型（`deliveryMethod`）和扩展类型（`deliveryEtype`）
   - 使用 `RegionRecordBuilder.buildRecordsForCombination()` 构建所有理论区域的客户数据
   - 提取区域名称列表

2. **检查已存在区域**
   - 查询 `region_customer_statistics` 表，获取该分区（year/month/weekSeq）中已存在的区域
   - 对比理论区域列表，找出缺失的区域

3. **追加构建缺失区域**
   - 如果有缺失区域，将这些区域的客户数据批量插入到 `region_customer_statistics` 表
   - 记录构建的区域列表

4. **返回完整区域列表**
   - 返回所有理论区域（包括原有的和新构建的）
   - 返回构建信息（是否构建了新数据、构建的区域列表）

### 关键特性

1. **增量追加**：只构建缺失的区域，不影响已存在的数据
2. **事务保证**：使用 `@Transactional` 确保数据一致性
3. **自动补全**：前端无需关心数据是否存在，接口自动补全

## 投放类型与区域的对应关系

### 1. 按档位投放（全市）

- **投放类型**：`按档位投放`
- **扩展类型**：`null` 或空
- **区域列表**：`["全市"]`

### 2. 按档位扩展投放（单扩展）

- **投放类型**：`按档位投放`
- **扩展类型**：`区县公司`
- **区域列表**：`["丹江", "郧西", "郧阳", ...]`（从 encoding-rules.yml 获取）

### 3. 按档位扩展投放（双扩展）

- **投放类型**：`按档位投放`
- **扩展类型**：`区县公司+市场类型`
- **区域列表**：笛卡尔积，例如：
  ```
  ["丹江（城网）", "丹江（农网）", "郧西（城网）", "郧西（农网）", ...]
  ```

### 4. 按价位段自选投放

- **投放类型**：`按价位段自选投放`
- **扩展类型**：`null` 或空
- **区域列表**：`["全市"]`

## 使用示例

### 前端调用流程

```javascript
// 1. 用户选择新的投放类型和扩展类型
const deliveryMethod = "按档位投放";
const deliveryEtype = "区县公司+市场类型";

// 2. 调用接口获取可用区域列表
const response = await fetch('/api/calculate/available-regions', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    year: 2025,
    month: 9,
    weekSeq: 3,
    deliveryMethod: deliveryMethod,
    deliveryEtype: deliveryEtype
  })
});

const result = await response.json();

// 3. 展示区域列表供用户选择
if (result.data.success) {
  const regions = result.data.availableRegions;
  // 渲染下拉框或多选框
  renderRegionSelector(regions);
  
  // 如果构建了新数据，可以提示用户
  if (result.data.hasBuiltNewData) {
    console.log('已自动构建以下区域的客户数据:', result.data.builtRegions);
  }
}
```

## 注意事项

1. **区域顺序**：返回的区域列表顺序由系统决定，前端无需关心顺序
2. **数据一致性**：接口使用事务保证，要么全部成功，要么全部失败
3. **性能考虑**：如果缺失区域较多，构建过程可能需要一定时间
4. **错误处理**：如果构建失败，接口会返回错误信息，前端应提示用户

## 相关文件

### Service层
- `GetAvailableRegionsService.java` - 服务接口
- `GetAvailableRegionsServiceImpl.java` - 服务实现

### DTO层
- `GetAvailableRegionsRequestDto.java` - 请求DTO
- `GetAvailableRegionsResponseDto.java` - 响应DTO

### Controller层
- `DistributionCalculateController.java` - 控制器（新增 `/available-regions` 端点）

### VO层
- `GetAvailableRegionsRequestVo.java` - 请求VO
- `GetAvailableRegionsResponseVo.java` - 响应VO

### Converter层
- `GetAvailableRegionsConverter.java` - VO/DTO转换器

## 测试建议

### 单元测试

1. 测试全市投放场景
2. 测试单扩展投放场景
3. 测试双扩展投放场景
4. 测试所有区域已存在的场景
5. 测试部分区域缺失的场景
6. 测试所有区域缺失的场景

### 集成测试

1. 测试与策略调整功能的集成
2. 测试事务回滚场景
3. 测试并发调用场景

## 版本历史

- **v1.0** (2025-12-23)
  - 初始版本
  - 支持根据投放类型和扩展类型获取可用区域列表
  - 支持自动追加构建缺失的区域数据
