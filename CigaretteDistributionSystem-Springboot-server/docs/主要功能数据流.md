## 一、文档目的与阅读指引

本文件从"数据是如何流动的"角度，说明本项目中几条最重要的业务链路：

- 分配方案生成 & 写回（包含 `2025/9/3` 分配写回测试链路）
- 区域客户统计构建（使用 `customer_filter` 分区表）
- 价位段自选投放分配 & 写回
- 预测编码查询 & 聚合懒加载
- Excel 数据导入 & 导入合法性校验（全市占比 + 货源属性规则）

目标是让刚接触项目的同学，能够按照“请求 → 控制器 → 应用服务 → 编排器/算法 → 仓储/数据库 → 返回”的顺序，快速定位到每一步对应的代码文件，并理解该步骤大致做了什么。

## 二、名词与缩写约定

在后续的数据流描述中，会频繁出现以下名词/缩写：

| 名词/缩写           | 含义说明                                                                 |
|---------------------|--------------------------------------------------------------------------|
| 批次（Batch）       | 一组按时间分区的预测/分配数据，通常由 `year` + `month` + `weekSeq` 标识 |
| ADV / 预投放量      | 预测要投放的总量（ADV，Advance），是分配算法的目标值                    |
| 区域客户矩阵        | 以区域为行、档位 D30~D1 为列的矩阵，单元格为“客户数量”                   |
| 分配矩阵            | 与区域客户矩阵同维度的矩阵，单元格为“每位客户分配的条数”或类似单位       |
| D30~D1 / 档位       | 代表 30 个价格/等级档位，从高到低（D30 为最高档）                        |
| 组合 / 投放组合     | 投放方式 + 扩展投放方式 + 标签等组合，用于决定策略与算法                 |
| 聚合编码表达式      | 将多条记录按业务规则合并后形成的表达式，如“城区A+城区B(同档结构)”        |
| 主流程 / 主链路     | 从前端操作到最终落库/返回的完整调用链                                   |

> 说明：后续章节会以“**步骤表 + 调用顺序表**”的形式，分别对“分配方案生成 & 写回”和“预测编码 & 聚合懒加载”进行拆解。

---

## 三、分配方案生成 & 写回（统一分配服务）——整体鸟瞰

本节说明"一键生成分配方案"的主流程。该流程已升级为**统一分配服务**，能够同时处理标准分配（按档位投放、按档位扩展投放）和价位段分配（按价位段自选投放）。

### 3.1 高层步骤概览

从"前端点击一键生成分配方案"到"预测表写回分配结果"，可以概括为以下几个阶段：

| 阶段序号 | 阶段名称                 | 关键参与层级/模块                  | 高层说明                                                         |
|----------|--------------------------|-------------------------------------|------------------------------------------------------------------|
| ①        | 接收请求与参数校验       | API (`DistributionCalculateController`) | 接收 `year/month/weekSeq`、`urbanRatio`、`ruralRatio` 等参数，记录访问日志并做基础校验 |
| ②        | 统一分配入口             | Application Service (`UnifiedAllocationService`) | 查询 info 表获取所有待分配卷烟，按 `delivery_method` 分流为标准分配和价位段分配两个集合 |
| ③        | 标准分配流程             | Application Service (`StandardAllocationService`) | 处理按档位投放、按档位扩展投放类型的卷烟，调用算法选择器和写回服务 |
| ④        | 价位段分配流程           | Application Service (`PriceBandAllocationService`) | 处理按价位段自选投放类型的卷烟，查询候选卷烟、初分配、截断微调、写回 |
| ⑤        | 客户矩阵构建             | Application (`CustomerMatrixBuilder`) | 从 `region_customer_statistics` 表构建区域客户矩阵，支持双周上浮处理 |
| ⑥        | 算法选择与执行           | Application (`AllocationAlgorithmSelector`) + Domain Service | 根据区域数、分组比例选择算法（SINGLE_LEVEL / COLUMN_WISE / GROUP_SPLITTING），调用领域算法服务 |
| ⑦        | 分配结果写回             | Application (`StandardDistributionWriteBackService` / `PriceBandDistributionWriteBackService`) | 标准分配写回 `cigarette_distribution_prediction` 表，价位段分配写回 `cigarette_distribution_prediction_price` 表 |
| ⑧        | 事件发布与统计监控       | Domain Event + Application Event Handler | 发布"分配生成开始/完成"等事件，由应用层 Handler 做统计/监控     |
| ⑨        | 汇总结果返回前端         | Application DTO + API VO/Converter | 汇总标准分配和价位段分配的处理结果，转换为 VO 并返回给前端 |

### 3.2 统一分配服务的设计理念

**设计目标**：将标准分配和价位段分配统一到一个入口，简化前端调用，提高系统可维护性。

**核心设计**：

1. **统一入口**: `UnifiedAllocationService.generateDistributionPlan()` 作为唯一入口
2. **自动分流**: 根据 `delivery_method` 字段自动识别并分流:
   - `按档位投放` / `按档位扩展投放` → `StandardAllocationService`
   - `按价位段自选投放` → `PriceBandAllocationService`
3. **结果合并**: 统一汇总两种分配的处理结果，统一返回给前端
4. **独立写回**: 标准分配和价位段分配分别写入不同的预测表，互不影响

**优势**：
- 前端只需调用一个接口，无需关心分配类型
- 新增分配类型时只需扩展 `UnifiedAllocationService`，无需修改前端
- 各分配类型独立实现，互不干扰

> 下一步：在"详细版"中，我们会把上述 ①～⑨ 阶段展开到具体类和方法，逐步说明"输入是什么、做了什么、输出给谁"。 

---

## 四、分配方案生成 & 写回——逐层逐类数据流（详细版）

本节按调用顺序，逐步列出关键代码文件和大致行为，帮助你从日志/调用栈快速定位到具体实现。

### 4.1 从 Controller 到 Application Service

| 步骤 | 代码位置                              | 输入数据                               | 本步主要动作                                                                                  | 输出/流向                                   |
|------|---------------------------------------|----------------------------------------|-----------------------------------------------------------------------------------------------|--------------------------------------------|
| 1    | `api/web/controller/DistributionCalculateController.generateDistributionPlan` | HTTP Body：`GenerateDistributionPlanRequestVo`（year/month/weekSeq、urbanRatio、ruralRatio 等） | 记录请求日志；使用 `@Valid` 做基础校验；调用 Converter 进行 VO→DTO 转换                      | DTO：`GenerateDistributionPlanRequestDto`  |
| 2    | `api/web/converter/DistributionCalculateConverter.toDto` | Request VO                            | 将前端字段映射为应用层 DTO 字段（包括批次信息、比例参数等）                                  | `GenerateDistributionPlanRequestDto` 传给 Service |
| 3    | `application/service/calculate/DistributionCalculateServiceImpl.generateDistributionPlan` | Request DTO                           | 作为“一键生成分配方案”的用例入口：根据批次加载需要处理的卷烟/区域，循环调用编排器进行计算，并汇总结果 | 调用 `DistributionAllocationOrchestrator`，最终得到每支卷烟的分配结果集合 |

### 4.2 Application Orchestrator：组装策略请求并调用策略管理器

| 步骤 | 代码位置                              | 输入数据                                         | 本步主要动作                                                                                         | 输出/流向                                           |
|------|---------------------------------------|--------------------------------------------------|------------------------------------------------------------------------------------------------------|----------------------------------------------------|
| 4    | `application/orchestrator/allocation/DistributionAllocationOrchestrator.calculateAllocationMatrix` | 当前卷烟的业务字段：cigCode/cigName/deliveryMethod/deliveryEtype/tag/deliveryArea/ADV/year/month/weekSeq/marketRatios/remark + 原始 ADV 行数据 | 记录“算法分配开始”日志；构造业务语义的 `DistributionStrategyCommand`（填充投放方式、扩展方式、标签、批次、档位范围、附加信息等） | `DistributionStrategyCommand` 传给 `DistributionStrategyManager` |
| 5    | `application/facade/DefaultDistributionStrategyManager.executeDistributionStrategy` | `DistributionStrategyCommand`                  | 作为 Facade 统一入口：在此完成基础校验、默认值处理，以及 Command → `StrategyExecutionRequest` 的转换，然后委托 `StrategyOrchestrator` 执行策略 | 调用 `StrategyOrchestrator.execute`                |
| 6    | `application/orchestrator/strategy/StrategyOrchestrator.execute` | `StrategyExecutionRequest`                      | 基于投放组合/标签等信息，解析出投放策略；准备 `StrategyContext`（构建区域客户矩阵、目标量、扩展参数等）；然后调用 `DistributionAlgorithmEngine.execute` | `StrategyContext` + `StrategyExecutionRequest` 进入算法引擎 |

### 4.3 AlgorithmEngine & Domain Service：算法选择与执行

| 步骤 | 代码位置                              | 输入数据                                         | 本步主要动作                                                                                                          | 输出/流向                                              |
|------|---------------------------------------|--------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------|
| 7    | `application/orchestrator/allocation/DistributionAlgorithmEngine.execute` | `StrategyContext`（含 RegionCustomerMatrix、targetAmount、档位范围）+ `StrategyExecutionRequest` | 从 RegionCustomerMatrix 提取区域列表与原始客户矩阵；根据 max/min grade 裁剪矩阵；计算分组比例和区域分组映射；根据区域数、分组/权重情况决定算法类型（SINGLE_LEVEL / COLUMN_WISE / GROUP_SPLITTING）；执行对应的 `run*` 方法 | 得到“紧凑档位区间”的分配矩阵 allocationCompact，并记录 target/actual/error 日志 |
| 8    | `runSingleLevel` / `runColumnWise` / `runGroupSplitting`（内部私有方法） | 区域列表 + 紧凑客户矩阵 + 目标量 +（可选）自定义顺序/分组比例 | 直接调用 Domain 层算法服务：`SingleLevelDistributionService` / `ColumnWiseAdjustmentService` / `GroupSplittingDistributionService`，执行纯领域算法逻辑 | 返回算法输出矩阵；交给引擎做档位反向展开/补齐并封装到 `StrategyExecutionResult` |
| 9    | `domain/service/algorithm/*ServiceImpl` | 区域列表、客户矩阵、目标量、分组信息等          | 执行具体分配算法（粗调 + 微调 + 约束修正等），不关心日志和技术细节，只产出分配矩阵                                  | 分配矩阵返回给 AlgorithmEngine                        |
| 10   | `StrategyExecutionResult`（回到 StrategyOrchestrator） | 分配矩阵 + 客户矩阵 + 目标区域列表              | 封装本次策略执行结果（成功/失败标志、消息、矩阵结果等），返回给 `DistributionAllocationOrchestrator`                 | `AllocationCalculationResult` 构造的输入               |

### 4.4 写回预测表与汇总结果

| 步骤 | 代码位置                              | 输入数据                                         | 本步主要动作                                                                                               | 输出/流向                                             |
|------|---------------------------------------|--------------------------------------------------|------------------------------------------------------------------------------------------------------------|------------------------------------------------------|
| 11   | `application/orchestrator/allocation/DistributionAllocationOrchestrator`（继续） | `StrategyExecutionResult`                       | 将目标区域列表、分配矩阵、客户矩阵封装为 `AllocationCalculationResult`，包含来源信息（例如使用的策略/算法） | 返回给 `DistributionCalculateServiceImpl`            |
| 12   | `application/service/calculate/DistributionCalculateServiceImpl` | 单支或多支卷烟的 `AllocationCalculationResult` 集合 | 对每支卷烟执行写回逻辑：调用 `DistributionWriteBackService`，同时统计成功/失败条数、误差等                   | 写回结果统计信息（DTO）                              |
| 13   | `application/service/calculate/impl/DistributionWriteBackService` | 区域客户矩阵、分配矩阵、批次信息等             | 将分配矩阵与原始预测记录关联起来，转换为持久化对象；通过 Domain Repository 调用 Infrastructure 仓储实现写回预测表 | 预测表（及相关统计表）中的记录被更新/插入             |
| 14   | `domain/repository/*` + `infrastructure/repository/impl/*` + `infrastructure/persistence/mapper/*` | 写回所需的领域对象/PO                          | RepositoryImpl 调用 Mapper 执行 SQL，将新的分配结果落地到数据库                                           | 数据库持久化完成                                     |

### 4.5 结果封装与返回前端 / 测试断言

| 步骤 | 代码位置                              | 输入数据                                         | 本步主要动作                                                                                                   | 输出/流向                                                  |
|------|---------------------------------------|--------------------------------------------------|----------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------|
| 15   | `application/service/calculate/DistributionCalculateServiceImpl` | 写回完成的统计信息 DTO                         | 汇总整体批次的处理结果（总条数、成功/失败数量、错误信息、最大误差等）                                         | `GenerateDistributionPlanResponseDto`                    |
| 16   | `api/web/converter/DistributionCalculateConverter.toVo` | Response DTO                                   | 将 DTO 映射为 `GenerateDistributionPlanResponseVo`，面向前端展示                                               | Response VO                                               |
| 17   | `api/web/controller/DistributionCalculateController.generateDistributionPlan` | Response VO + 结果状态                         | 将 VO 包装为 `ApiResponseVo`，返回 HTTP 200，`success=true/false` 及提示信息                                   | 前端收到一键生成分配方案的结果                           |
| 18   | `GenerateDistributionPlanIntegrationTest`               | 直接调用 `DistributionCalculateService` 或相关方法 | 在测试环境下构造与 2025/9/3 一致的批次参数，执行完整链路；对最大误差、写回条数、关键 SQL 结果进行断言         | 确认分配方案生成 & 写回链路在该批次上的正确性与稳定性     |

---

## 五、价位段自选投放分配 & 写回——整体鸟瞰

本节描述"按价位段自选投放（全市默认策略）"的完整分配流程，包括候选卷烟查询、初分配、价位段矩阵截断与微调、写回价位段预测表等步骤。

### 5.1 高层步骤概览

| 阶段序号 | 阶段名称                 | 关键参与层级/模块                                     | 高层说明                                                                 |
|----------|--------------------------|--------------------------------------------------------|--------------------------------------------------------------------------|
| ①        | 候选卷烟查询             | Application Service (`PriceBandCandidateQueryService`) | 基于投放信息分区表和价目表，查询指定分区下"按价位段自选投放"的候选卷烟，按价位段升序、组内批发价降序排序 |
| ②        | 构建全市客户矩阵         | Domain Repository (`RegionCustomerStatisticsRepository`) | 从区域客户统计表构建"全市"区域的客户矩阵（单行矩阵，30个档位）           |
| ③        | 单支卷烟初分配           | Domain Service (`SingleLevelDistributionService`)      | 为每支候选卷烟执行 SingleLevel 算法进行初分配，得到30档位的分配结果     |
| ④        | 价位段分组与截断微调     | Application Service (`PriceBandAllocationServiceImpl`) | 按价位段分组，对每组内多支卷烟执行"LG→HG 扫描找到首个列上≥2非0元素并清零更低档位"的截断操作，然后进行误差微调 |
| ⑤        | 分配结果写回             | Application Service (`PriceBandDistributionWriteBackServiceImpl`) + Domain Repository + Infra Mapper | 将分配结果批量写回 `cigarette_distribution_prediction_price` 分区表      |
| ⑥        | 完成返回                 | Application Service                                  | 记录完成日志，返回分配结果统计信息                                       |

---

## 六、价位段自选投放分配 & 写回——逐层逐类数据流（详细版）

### 6.1 候选卷烟查询与全市客户矩阵构建

| 步骤 | 代码位置                                      | 输入数据                                     | 本步主要动作                                                                                   | 输出/流向                                      |
|------|-----------------------------------------------|----------------------------------------------|------------------------------------------------------------------------------------------------|-----------------------------------------------|
| 1    | `application/service/coordinator/PriceBandCandidateQueryServiceImpl.listOrderedPriceBandCandidates` | year/month/weekSeq                           | 从投放信息分区表和价目表查询候选卷烟，按价位段升序、组内批发价降序排序                         | 返回候选卷烟列表（包含 CIG_CODE、CIG_NAME、ADV、PRICE_BAND、WHOLESALE_PRICE 等字段） |
| 2    | `application/service/calculate/impl/PriceBandAllocationServiceImpl.buildCityWideCustomerMatrix` | year/month/weekSeq                           | 调用 `RegionCustomerStatisticsRepository` 查询"全市"区域的客户统计信息，构建单行客户矩阵     | 返回 `RegionCustomerMatrix`（全市区域，30个档位） |

### 6.2 单支卷烟初分配

| 步骤 | 代码位置                                      | 输入数据                                     | 本步主要动作                                                                                   | 输出/流向                                      |
|------|-----------------------------------------------|----------------------------------------------|------------------------------------------------------------------------------------------------|-----------------------------------------------|
| 3    | `application/service/calculate/impl/PriceBandAllocationServiceImpl.allocateForPriceBand` | 候选卷烟列表 + 全市客户矩阵                  | 遍历每支候选卷烟，调用 `SingleLevelDistributionService.distribute` 进行初分配                | 将分配结果（30档位数组）挂载到候选记录的 `GRADES` 字段 |
| 4    | `domain/service/algorithm/SingleLevelDistributionServiceImpl.distribute` | 目标区域列表（["全市"]）、客户矩阵、ADV      | 执行单层分配算法，计算30个档位的分配量                                                         | 返回分配矩阵（单行，30列）                     |

### 6.3 价位段分组、截断与微调

| 步骤 | 代码位置                                      | 输入数据                                     | 本步主要动作                                                                                   | 输出/流向                                      |
|------|-----------------------------------------------|----------------------------------------------|------------------------------------------------------------------------------------------------|-----------------------------------------------|
| 5    | `application/service/calculate/impl/PriceBandAllocationServiceImpl.allocateForPriceBand` | 候选卷烟列表（已包含 GRADES 字段）           | 按 PRICE_BAND 字段对候选卷烟进行分组，识别需要截断的价位段（组内卷烟数≥2）                    | 价位段分组映射（Map<Integer, List<Map>>）     |
| 6    | `application/service/calculate/impl/PriceBandAllocationServiceImpl.truncateAndAdjustBands` | 需要截断的价位段分组 + 全市客户数数组        | 对每个价位段：从低档位向高档位扫描，找到首个列上≥2个非0元素的档位，将该档位以下的所有档位清零；然后进行误差微调，确保实际投放量接近目标量 | 更新候选记录的 GRADES 字段（截断后的分配结果） |

### 6.4 分配结果写回

| 步骤 | 代码位置                                      | 输入数据                                     | 本步主要动作                                                                                   | 输出/流向                                      |
|------|-----------------------------------------------|----------------------------------------------|------------------------------------------------------------------------------------------------|-----------------------------------------------|
| 7    | `application/service/writeback/impl/PriceBandDistributionWriteBackServiceImpl.writeBackPriceBandAllocations` | 候选卷烟列表（含 GRADES）+ year/month/weekSeq + 全市客户数数组 | 将分配结果转换为 `CigaretteDistributionPredictionPricePO` 持久化对象，调用 `EncodeService.encodeForSpecificArea` 生成编码表达式，批量写入 `cigarette_distribution_prediction_price` 分区表，计算实际投放量 | 数据库持久化完成                               |
| 8    | `domain/repository/CigaretteDistributionPredictionPriceRepository` + `infrastructure/repository/impl/*` + `infrastructure/persistence/mapper/*` | 写回所需的领域对象/PO                        | RepositoryImpl 调用 Mapper 执行 SQL，将价位段分配结果落地到数据库                              | 数据库持久化完成                               |

---

## 七、预测编码查询——整体鸟瞰

本节描述的是“查询预测分区/价位段预测数据”的主流程，不包含聚合懒加载；聚合懒加载在下一章单独说明。

### 5.1 高层步骤概览

| 阶段序号 | 阶段名称                 | 关键参与层级/模块                                     | 高层说明                                                                 |
|----------|--------------------------|--------------------------------------------------------|--------------------------------------------------------------------------|
| ①        | 接收查询请求             | API (`PredictionQueryController`)                     | 接收按时间分区或价位段的查询请求参数（year/month/weekSeq）              |
| ②        | 查询用例编排             | Application Service (`PredictionQueryService`)        | 作为查询用例入口，调用领域仓储获取原始记录                               |
| ③        | 数据访问与组装           | Domain Repository + Infra RepositoryImpl + Mapper/PO  | 通过 MyBatis 从预测表/价位段预测表加载数据，转换为 Map/List 结构        |
| ④        | 结果转换与封装           | API Converter (`PredictionQueryConverter`)            | 将 Map/List 转为结构化的 Response VO，便于前端展示                       |
| ⑤        | 响应返回                 | API Controller + `ApiResponseVo`                      | 封装为统一响应结构返回前端                                               |

---

## 八、预测编码查询——逐层逐类数据流（详细版）

### 6.1 从 Controller 到 Application Service

| 步骤 | 代码位置                                      | 输入数据                                     | 本步主要动作                                                                                   | 输出/流向                                      |
|------|-----------------------------------------------|----------------------------------------------|------------------------------------------------------------------------------------------------|-----------------------------------------------|
| 1    | `api/web/controller/PredictionQueryController.listByTime` | 查询参数：`year`、`month`、`weekSeq` | 记录查询日志；接收时间分区参数；调用 `PredictionQueryService.listByTime`                     | 调用 Application Service                      |
| 2    | `api/web/controller/PredictionQueryController.listPriceByTime` | 查询参数：`year`、`month`、`weekSeq` | 记录价位段查询日志；调用 `PredictionQueryService.listPriceByTime`                            | 调用 Application Service                      |
| 3    | `application/service/query/PredictionQueryServiceImpl.listByTime` | year/month/weekSeq DTO 参数             | 调用 Domain Repository 获取普通预测分区数据；不关心具体 SQL 与表结构                         | 返回 `List<Map<String,Object>>` 数据列表      |
| 4    | `application/service/query/PredictionQueryServiceImpl.listPriceByTime` | year/month/weekSeq DTO 参数          | 调用 Domain Repository 获取价位段预测数据                                                     | 返回 `List<Map<String,Object>>` 数据列表      |

### 6.2 Domain Repository & Infrastructure：从数据库加载预测数据

| 步骤 | 代码位置                                      | 输入数据                                     | 本步主要动作                                                                                         | 输出/流向                                         |
|------|-----------------------------------------------|----------------------------------------------|------------------------------------------------------------------------------------------------------|--------------------------------------------------|
| 5    | `domain/repository/CigaretteDistributionPredictionRepository` | year/month/weekSeq 等查询条件        | 定义按时间分区查询预测分区数据的接口抽象                                                             | 由 Infra 实现                                   |
| 6    | `domain/repository/CigaretteDistributionPredictionPriceRepository` | year/month/weekSeq 条件           | 定义按时间分区查询价位段预测数据的接口抽象                                                           | 由 Infra 实现                                   |
| 7    | `infrastructure/repository/impl/CigaretteDistributionPredictionRepositoryImpl` | 查询条件                         | 调用 `CigaretteDistributionPredictionMapper` 对应方法（如 `listByTime`），执行 SQL 查询             | 返回 Mapper 查询结果（通常为 List<PO> 或 List<Map>） |
| 8    | `infrastructure/repository/impl/CigaretteDistributionPredictionPriceRepositoryImpl` | 查询条件                     | 调用 `CigaretteDistributionPredictionPriceMapper` 执行价位段预测数据查询                             | 返回 Mapper 查询结果                             |
| 9    | `infrastructure/persistence/mapper/*Mapper.java` + XML | year/month/weekSeq 参数       | 使用 MyBatis 将参数绑定到 SQL，映射结果为 PO 或 Map                                                 | 将原始数据交给 RepositoryImpl                    |

### 6.3 Converter 与响应封装

| 步骤 | 代码位置                                      | 输入数据                                     | 本步主要动作                                                                                             | 输出/流向                                             |
|------|-----------------------------------------------|----------------------------------------------|----------------------------------------------------------------------------------------------------------|------------------------------------------------------|
| 10   | `api/web/converter/PredictionQueryConverter.toVo` | `List<Map<String,Object>>`                 | 根据固定字段顺序（卷烟代码、名称、编码、投放方式、扩展方式、区域、标签、D30~D1、备注等）组装 `PredictionQueryResponseVo` | 返回给 Controller                                    |
| 11   | `api/web/controller/PredictionQueryController.listByTime` / `listPriceByTime` | Response VO                                | 将 VO 包装为 `ApiResponseVo`，填充成功/失败消息，并返回 HTTP 200                                         | 前端收到预测数据或价位段预测数据，用于展示和校验     |

---

## 九、聚合懒加载——整体鸟瞰

本节描述“前端在列表中按需加载某支卷烟的多区域聚合编码表达式”的主流程，即 `/api/prediction/aggregated-encodings` 接口的数据流。

### 7.1 高层步骤概览

| 阶段序号 | 阶段名称                 | 关键参与层级/模块                                                        | 高层说明                                                                 |
|----------|--------------------------|---------------------------------------------------------------------------|--------------------------------------------------------------------------|
| ①        | 接收懒加载查询请求       | API (`PredictionQueryController.aggregatedEncodings`)                    | 前端在行内点击“查看聚合表达式”，传入 year/month/weekSeq/cigCode 等参数  |
| ②        | 应用服务查询与聚合       | Application Service (`AggregatedEncodingQueryService` + Impl)           | 根据批次和卷烟代码，从预测表中按需拉取该卷烟的记录，并按业务规则做聚合   |
| ③        | 数据访问                 | Domain Repository + Infra RepositoryImpl + Mapper                        | 使用专门的查询（如 `findByCigCode`）高效获取该卷烟相关的预测记录         |
| ④        | 业务聚合与表达式生成     | Application Service + Domain 规则/工具                                   | 按组合/区域/档位结构等规则，将多条记录聚合为一组编码表达式字符串         |
| ⑤        | 响应封装与返回           | API Controller + `ApiResponseVo`                                         | 将字符串列表直接封装为统一响应，返回给前端，供懒加载展示使用             |

---

## 十、聚合懒加载——逐层逐类数据流（详细版）

### 8.1 从 Controller 到 Application Service

| 步骤 | 代码位置                                      | 输入数据                                            | 本步主要动作                                                                                         | 输出/流向                                     |
|------|-----------------------------------------------|-----------------------------------------------------|------------------------------------------------------------------------------------------------------|----------------------------------------------|
| 1    | `api/web/controller/PredictionQueryController.aggregatedEncodings` | 查询参数：`year`、`month`、`weekSeq`、`cigCode` | 记录聚合表达式查询日志；接收批次和卷烟代码参数；调用 `AggregatedEncodingQueryService.listAggregatedEncodings` | 调用 Application Service                     |
| 2    | `application/service/encode/AggregatedEncodingQueryServiceImpl.listAggregatedEncodings` | year/month/weekSeq/cigCode                     | 作为懒加载用例入口：调用 `CigaretteDistributionPredictionRepository` 查询指定卷烟在该批次的预测记录；在内存中按业务规则聚合 | 需要聚合的原始记录集合 → 进入聚合逻辑        |

### 8.2 Domain Repository & Infrastructure：按卷烟代码拉取预测记录

| 步骤 | 代码位置                                      | 输入数据                                            | 本步主要动作                                                                                           | 输出/流向                                         |
|------|-----------------------------------------------|-----------------------------------------------------|--------------------------------------------------------------------------------------------------------|--------------------------------------------------|
| 3    | `domain/repository/CigaretteDistributionPredictionRepository` | year/month/weekSeq/cigCode                     | 定义“按批次 + 卷烟代码查询预测记录”的仓储接口（如 `findByCigCode`）                                   | 由 Infra 实现                                   |
| 4    | `infrastructure/repository/impl/CigaretteDistributionPredictionRepositoryImpl` | 查询条件（含 cigCode）                       | 调用 `CigaretteDistributionPredictionMapper.findByCigCode` 等方法，执行针对性的 SQL 查询               | 返回仅包含该卷烟的预测记录列表（PO 或 Map）     |
| 5    | `infrastructure/persistence/mapper/CigaretteDistributionPredictionMapper` + XML | year/month/weekSeq/cigCode 参数             | 定义按卷烟代码过滤的 SQL；只命中相关记录，避免一次性加载整批次所有卷烟                               | 将原始数据交给 RepositoryImpl                    |

### 8.3 业务聚合与编码表达式生成

> 具体实现细节在 Application Service 中，下面是逻辑视角的拆解。

| 步骤 | 代码位置                                      | 输入数据                                            | 本步主要动作                                                                                               | 输出/流向                                         |
|------|-----------------------------------------------|-----------------------------------------------------|------------------------------------------------------------------------------------------------------------|--------------------------------------------------|
| 6    | `AggregatedEncodingQueryServiceImpl` 内部聚合逻辑 | 单支卷烟在该批次下的预测记录列表                 | 按以下规则对记录进行分组与聚合：<br/>- 只聚合同一批次 + 同一卷烟代码的记录；<br/>- 要求投放方式/扩展方式/标签等关键字段一致；<br/>- 仅当 D30~D1 档位结构等价时才可聚合；<br/>- 先按主扩展维度聚合，再在组内按子扩展维度合并 | 得到一组“聚合编码表达式”（字符串）                |
| 7    | 领域规则/工具（如编码规则实现、表达式拼接工具） | 聚合分组后的记录子集                               | 根据业务定义的编码规则，将一组区域/组合信息转换为可读的表达式字符串（例如区域名拼接、条件说明等）         | 表达式字符串列表                                  |

### 8.4 响应封装与返回前端

| 步骤 | 代码位置                                      | 输入数据                                            | 本步主要动作                                                                                 | 输出/流向                              |
|------|-----------------------------------------------|-----------------------------------------------------|----------------------------------------------------------------------------------------------|---------------------------------------|
| 8    | `application/service/encode/AggregatedEncodingQueryServiceImpl.listAggregatedEncodings` | 表达式字符串列表                                  | 直接返回字符串列表给 Controller，作为本用例的最终结果                                       | `List<String>` 聚合编码表达式         |
| 9    | `api/web/controller/PredictionQueryController.aggregatedEncodings` | `List<String>` 表达式列表                        | 将表达式列表封装为 `ApiResponseVo`，填入 success/message/code 等字段，并返回 HTTP 200       | 前端懒加载收到该卷烟的聚合编码表达式 |

---

## 十一、图形化总览（文字版时序图）

本节用简化的“文字版时序图”帮助快速建立整体印象。

### 9.1 分配方案生成 & 写回（核心链路）

```text
前端
  │  POST /api/calculate/generate-distribution-plan
  ▼
DistributionCalculateController
  │  VO → DTO
  ▼
DistributionCalculateServiceImpl
  │  遍历卷烟/区域，调用编排器
  ▼
DistributionAllocationOrchestrator
  │  组装 DistributionStrategyCommand
  ▼
DistributionStrategyManager / DefaultDistributionStrategyManager (Facade)
  │
  ▼
StrategyOrchestrator
  │  构建 StrategyContext（客户矩阵、target 等）
  ▼
DistributionAlgorithmEngine
  │  选择算法：SINGLE_LEVEL / COLUMN_WISE / GROUP_SPLITTING
  │  调用 Domain 算法服务
  ▼
Domain Algorithm Services
  │  计算分配矩阵
  ▼
DistributionWriteBackService
  │  调用 RepositoryImpl + Mapper
  ▼
数据库（预测表 / 统计表）
  │
  ▼
Controller 封装响应 → 前端
```

### 9.2 预测编码查询 & 聚合懒加载

```text
前端
  │  GET /api/prediction/list-by-time
  ▼
PredictionQueryController.listByTime
  │
  ▼
PredictionQueryServiceImpl
  │
  ▼
Domain Repository (Prediction)
  │
  ▼
RepositoryImpl + Mapper + SQL
  │
  ▼
PredictionQueryConverter.toVo
  │
  ▼
Controller 封装响应 → 前端（预测数据）

（懒加载聚合表达式）

前端
  │  GET /api/prediction/aggregated-encodings
  ▼
PredictionQueryController.aggregatedEncodings
  │
  ▼
AggregatedEncodingQueryServiceImpl
  │  调用 PredictionRepository.findByCigCode
  ▼
RepositoryImpl + Mapper + SQL
  │  返回该卷烟相关预测记录
  ▼
AggregatedEncodingQueryServiceImpl
  │  按聚合规则生成编码表达式 List<String>
  ▼
Controller 封装响应 → 前端（聚合编码表达式）
```

### 11.3 价位段自选投放分配 & 写回

```text
PriceBandAllocationService
  │  allocateForPriceBand(year, month, weekSeq)
  ▼
PriceBandCandidateQueryService
  │  查询候选卷烟（按价位段升序、组内批发价降序）
  ▼
RegionCustomerStatisticsRepository
  │  构建全市客户矩阵
  ▼
SingleLevelDistributionService
  │  为每支候选卷烟执行初分配
  ▼
PriceBandAllocationServiceImpl
  │  按价位段分组、截断与微调
  ▼
PriceBandDistributionWriteBackServiceImpl
  │  批量写回 cigarette_distribution_prediction_price
  ▼
数据库（价位段预测表）
```

### 11.4 Excel 导入 & 导入合法性校验（已升级为双表独立导入）

```text
【客户基础信息表导入】
前端
  │  POST /api/import/base-customer (multipart/form-data)
  │  参数: file (Excel文件)
  ▼
ExcelImportController.importBaseCustomerInfo
  │  文件校验（大小≤10MB、格式为.xls/.xlsx）
  ▼
ExcelImportServiceImpl.importBaseCustomerInfo
  │  1. 解析 Excel 文件
  │  2. 清空 base_customer_info 表（全量覆盖）
  │  3. 批量插入新数据
  │  4. 刷新诚信互助小组编码映射表 (integrity_group_mapping)
  │  5. 返回诚信互助小组映射信息
  ▼
数据库（base_customer_info、integrity_group_mapping）
  │
  ▼
Controller 封装响应 → 前端（显示导入成功记录数、诚信互助小组映射）

【卷烟投放基础信息表导入】
前端
  │  POST /api/import/cigarette (multipart/form-data)
  │  参数: file (Excel文件)、year、month、weekSeq
  ▼
ExcelImportController.importCigaretteDistributionInfo
  │  文件校验（大小≤10MB、格式为.xls/.xlsx）
  ▼
ExcelImportServiceImpl.importCigaretteDistributionInfo
  │  1. 解析 Excel 文件
  │  2. 执行业务合法性校验（调用 CigaretteImportValidator）
  │     - 全市占比校验: 检查投放区域为"全市"的卷烟数量占比是否达到配置阈值
  │     - 货源属性校验: 校验 货源属性 + 投放方式 + 标签 组合的合法性
  │       示例: 紧俏烟只能用"按档位投放"且不允许设置标签
  │  3. 校验通过: 删除指定分区旧数据，插入新数据到 cigarette_distribution_info 分区表
  │  4. 校验失败: 抛出异常，前端显示具体错误信息（如"全市占比30%低于50%阈值"）
  ▼
数据库（cigarette_distribution_info 分区表）
  │
  ▼
Controller 封装响应 → 前端（显示导入成功或校验失败的详细信息）
```

**关键改进点**:
1. **双表独立导入**: 客户表和卷烟表分别通过独立接口导入，互不影响
2. **业务校验增强**: 新增全市占比校验和货源属性规则校验，确保数据合法性
3. **配置化规则**: 校验规则定义在 `import-validation-rules.yml` 文件中，便于维护
4. **详细错误提示**: 校验失败时返回具体的错误原因，帮助用户快速定位问题

### 11.5 区域客户统计构建（使用 customer_filter 分区表）

```text
RegionCustomerStatisticsBuildService
  │  buildRegionCustomerStatistics(year, month, weekSeq)
  ▼
FilterCustomerTableRepository
  │  确保分区存在并插入数据到 customer_filter 分区表
  │  ensurePartitionAndInsertData(year, month, weekSeq, whereClause)
  ▼
FilterCustomerTableRepositoryImpl
  │  调用 FilterCustomerTableMapper 执行 SQL
  │  同步表结构、确保分区存在、截断旧数据、插入新数据
  ▼
RegionRecordBuilder
  │  根据投放组合策略构建区域客户数统计记录
  │  调用 FilterCustomerTableRepository 查询分区数据
  │  - 按扩展维度组合查询（如区县+市场类型）
  │  - 按标签规则过滤客户
  │  - 统计各档位客户数
  ▼
RegionCustomerStatisticsRepository
  │  批量写入 region_customer_statistics 分区表
  ▼
数据库（region_customer_statistics 分区表）
```

## 十二、区域客户统计构建——整体鸟瞰

本节描述"根据投放组合信息，从 `customer_filter` 分区表中构建区域客户数统计"的主流程，这是分配算法执行的前置步骤。

### 12.1 高层步骤概览

| 阶段序号 | 阶段名称                 | 关键参与层级/模块                                     | 高层说明                                                                 |
|----------|--------------------------|--------------------------------------------------------|--------------------------------------------------------------------------|
| ①        | 准备分区数据             | Domain Repository (`FilterCustomerTableRepository`) | 确保 `customer_filter` 分区存在，从 `base_customer_info` 同步数据到分区表，支持动态字段同步 |
| ②        | 扫描投放组合             | Domain Repository (`CigaretteDistributionInfoRepository`) | 从 `cigarette_distribution_info` 表扫描所有不重复的投放组合             |
| ③        | 构建区域客户统计         | Application Service (`RegionRecordBuilder`) | 对每个投放组合，根据扩展维度、标签规则等构建区域客户数统计记录         |
| ④        | 查询分区数据             | Domain Repository (`FilterCustomerTableRepository`) | 从 `customer_filter` 分区表查询符合条件的客户数据，统计各档位客户数     |
| ⑤        | 批量写入统计表           | Domain Repository (`RegionCustomerStatisticsRepository`) | 将构建的区域客户统计记录批量写入 `region_customer_statistics` 分区表     |

---

## 十三、区域客户统计构建——逐层逐类数据流（详细版）

### 13.1 准备分区数据

| 步骤 | 代码位置                                      | 输入数据                                     | 本步主要动作                                                                                   | 输出/流向                                      |
|------|-----------------------------------------------|----------------------------------------------|------------------------------------------------------------------------------------------------|-----------------------------------------------|
| 1    | `application/service/coordinator/RegionCustomerStatisticsBuildServiceImpl.buildRegionCustomerStatistics` | year/month/weekSeq                           | 作为区域客户统计构建的用例入口，先准备分区数据                                                 | 调用 `FilterCustomerTableRepository`           |
| 2    | `domain/repository/FilterCustomerTableRepository.ensurePartitionAndInsertData` | year/month/weekSeq/whereClause               | 定义分区数据准备的抽象接口                                                                     | 由 Infra 实现                                  |
| 3    | `infrastructure/repository/impl/FilterCustomerTableRepositoryImpl.ensurePartitionAndInsertData` | year/month/weekSeq/whereClause               | 同步表结构、确保分区存在、截断旧数据、插入新数据                                               | 调用 `FilterCustomerTableMapper`               |
| 4    | `infrastructure/persistence/mapper/FilterCustomerTableMapper` + XML | year/month/weekSeq/whereClause/columns        | 执行动态字段插入 SQL，从 `base_customer_info` 同步数据到 `customer_filter` 分区表              | 分区数据准备完成                               |

### 13.2 扫描投放组合与构建区域客户统计

| 步骤 | 代码位置                                      | 输入数据                                     | 本步主要动作                                                                                   | 输出/流向                                      |
|------|-----------------------------------------------|----------------------------------------------|------------------------------------------------------------------------------------------------|-----------------------------------------------|
| 5    | `application/service/coordinator/impl/RegionCustomerStatisticsBuildServiceImpl` | year/month/weekSeq                           | 调用 `CigaretteDistributionInfoRepository.findDistinctCombinations` 扫描投放组合               | 返回不重复的投放组合列表                       |
| 6    | `shared/util/RegionRecordBuilder.buildRecordsForCombination` | deliveryMethod/deliveryEtype/tagRules/year/month/weekSeq | 根据投放组合策略构建区域客户数统计记录，调用 `FilterCustomerTableRepository` 查询分区数据       | 返回区域客户统计记录列表                       |
| 7    | `domain/repository/FilterCustomerTableRepository.listDistinctCombinationsPartition` | year/month/weekSeq/columns                   | 查询分区表中指定列的去重组合（如区县+市场类型）                                                | 返回扩展维度组合列表                           |
| 8    | `domain/repository/FilterCustomerTableRepository.statGradesPartition` | year/month/weekSeq/filters/tagColumn/tagOperator/tagValue | 按条件统计各档位的客户数，支持固定标签字段和动态标签字段（JSON）查询                           | 返回档位统计结果                               |

### 13.3 批量写入统计表

| 步骤 | 代码位置                                      | 输入数据                                     | 本步主要动作                                                                                   | 输出/流向                                      |
|------|-----------------------------------------------|----------------------------------------------|------------------------------------------------------------------------------------------------|-----------------------------------------------|
| 9    | `application/service/coordinator/impl/RegionCustomerStatisticsBuildServiceImpl` | 区域客户统计记录列表                         | 将构建的区域客户统计记录批量写入统计表                                                         | 调用 `RegionCustomerStatisticsRepository`      |
| 10   | `domain/repository/RegionCustomerStatisticsRepository.batchUpsert` | year/month/weekSeq/records                  | 定义批量写入区域客户统计的抽象接口                                                             | 由 Infra 实现                                  |
| 11   | `infrastructure/repository/impl/RegionCustomerStatisticsRepositoryImpl` + Mapper | year/month/weekSeq/records                   | 执行批量插入/更新 SQL，将区域客户统计记录写入 `region_customer_statistics` 分区表              | 数据库持久化完成                               |







