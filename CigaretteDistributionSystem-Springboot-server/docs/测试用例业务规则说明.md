# 测试用例业务规则说明

## 一、核心业务规则

### 1.1 标签规则

- **标签数量限制**：最多叠加1个标签
- **当前标签类型**：只有"优质数据共享客户"一种
- **标签过滤值**：固定为0

### 1.2 投放区域规则

| 投放方式 | 扩展类型要求 | 投放区域默认值 | 说明 |
|---------|------------|--------------|------|
| **按档位投放** | 不允许扩展类型（0个） | **固定为"全市"** | 无论预投放量大小，都固定为"全市" |
| **按档位扩展投放** | 必须有1-2个扩展类型 | **根据预投放量动态计算** | 小投放量少区域，大投放量多区域 |
| **按价位段自选投放** | 可以有0-2个扩展类型 | **固定为"全市"** | 即使有扩展类型，投放区域也固定为"全市" |

### 1.3 扩展类型规则

根据 `DeliveryMethodType` 枚举定义：

- **按档位投放**：
  - `allowsExtensions = false`
  - `minExtensions = 0`
  - `maxExtensions = 0`
  - **结论**：不允许任何扩展类型

- **按档位扩展投放**：
  - `allowsExtensions = true`
  - `minExtensions = 1`
  - `maxExtensions = 2`
  - **结论**：必须有1-2个扩展类型

- **按价位段自选投放**：
  - `allowsExtensions = true`
  - `minExtensions = 0`
  - `maxExtensions = 2`
  - **结论**：可以有0-2个扩展类型，但投放区域固定为"全市"

## 二、测试用例生成修正

### 2.1 区域数量计算修正

**修正前**：所有投放方式都根据预投放量动态计算区域数量

**修正后**：
```java
// 按档位投放和按价位段自选投放：固定为"全市"（regionCount=0）
if ("按档位投放".equals(deliveryMethod) || "按价位段自选投放".equals(deliveryMethod)) {
    return 0; // 0表示"全市"
}

// 按档位扩展投放：根据预投放量动态计算
// regionCount > 0 表示具体区域数量
```

### 2.2 投放区域字符串构建修正

**修正前**：`regionCount` 直接映射为区域数量

**修正后**：
```java
// regionCount = 0：表示"全市"
if (regionCount <= 0 || "按档位投放".equals(deliveryMethod) || "按价位段自选投放".equals(deliveryMethod)) {
    return "全市";
}

// regionCount > 0：表示具体区域组合（逗号分隔）
// 例如：regionCount=3 → "城区,丹江口市,房县"
```

### 2.3 组合生成修正

**修正前**：只生成"按档位投放"和"按档位扩展投放"的组合

**修正后**：增加了"按价位段自选投放"的组合
```java
// 按价位段自选投放（可以有0-2个扩展类型，但默认全市）
for (String tag : TAGS) {
    // 无扩展类型
    combinations.add(new BaseCombination("按价位段自选投放", null, tag));
    // 单扩展类型（示例）
    combinations.add(new BaseCombination("按价位段自选投放", "档位+区县", tag));
}
```

## 三、测试用例示例

### 3.1 按档位投放示例

```sql
-- 投放区域固定为"全市"，无论预投放量大小
INSERT INTO cigarette_distribution_info
(YEAR, MONTH, WEEK_SEQ, CIG_CODE, CIG_NAME, DELIVERY_METHOD, DELIVERY_ETYPE, TAG, ADV, DELIVERY_AREA)
VALUES
(2099, 9, 1, 'TEST_001', '测试卷烟_按档位投放', '按档位投放', NULL, NULL, 500.00, '全市'),
(2099, 9, 1, 'TEST_002', '测试卷烟_按档位投放', '按档位投放', NULL, NULL, 50000.00, '全市'),
(2099, 9, 1, 'TEST_003', '测试卷烟_按档位投放_有标签', '按档位投放', NULL, '优质数据共享客户', 100000.00, '全市');
```

### 3.2 按档位扩展投放示例

```sql
-- 投放区域根据预投放量动态计算
INSERT INTO cigarette_distribution_info
(YEAR, MONTH, WEEK_SEQ, CIG_CODE, CIG_NAME, DELIVERY_METHOD, DELIVERY_ETYPE, TAG, ADV, DELIVERY_AREA)
VALUES
-- 小投放量：1个区域
(2099, 9, 1, 'TEST_101', '测试卷烟_按档位扩展投放', '按档位扩展投放', '档位+区县', NULL, 500.00, '城区'),
-- 中投放量：2-3个区域
(2099, 9, 1, 'TEST_102', '测试卷烟_按档位扩展投放', '按档位扩展投放', '档位+区县', NULL, 5000.00, '城区,丹江口市'),
-- 大投放量：5-7个区域
(2099, 9, 1, 'TEST_103', '测试卷烟_按档位扩展投放', '按档位扩展投放', '档位+区县+市场类型', '优质数据共享客户', 100000.00, '城区,丹江口市,房县,郧阳区,竹山县,郧西县,竹溪县');
```

### 3.3 按价位段自选投放示例

```sql
-- 投放区域固定为"全市"，即使有扩展类型
INSERT INTO cigarette_distribution_info
(YEAR, MONTH, WEEK_SEQ, CIG_CODE, CIG_NAME, DELIVERY_METHOD, DELIVERY_ETYPE, TAG, ADV, DELIVERY_AREA)
VALUES
-- 无扩展类型
(2099, 9, 1, 'TEST_201', '测试卷烟_按价位段自选投放', '按价位段自选投放', NULL, NULL, 50000.00, '全市'),
-- 有扩展类型（但投放区域仍为"全市"）
(2099, 9, 1, 'TEST_202', '测试卷烟_按价位段自选投放', '按价位段自选投放', '档位+区县', NULL, 100000.00, '全市');
```

## 四、编码规则表理解

### 4.1 投放方式编码

| 编码 | 投放方式 | 说明 |
|------|---------|------|
| A | 按档位统一投放 / 按档位投放 | 不允许扩展类型，默认全市 |
| B | 按档位扩展投放 / 按档位拓展投放 | 必须有1-2个扩展类型，区域动态 |
| C | 按价位段自选投放 | 可以有0-2个扩展类型，默认全市 |

### 4.2 扩展类型编码

| 编码 | 扩展类型 | 说明 |
|------|---------|------|
| 1 | 档位+区县 | 单扩展类型 |
| 2 | 档位+市场类型 | 单扩展类型 |
| 3 | 档位+城乡分类代码 | 单扩展类型 |
| 4 | 档位+业态 | 单扩展类型 |
| 5 | 档位+市场部 | 单扩展类型 |
| 6 | 档位+商圈类型 | 单扩展类型 |
| 7 | 档位+信用等级 | 单扩展类型 |
| 8 | 档位+诚信自律小组 | 单扩展类型 |

**双扩展类型**：由两个单扩展类型组合，例如：
- "档位+区县+市场类型" = 编码1 + 编码2
- "档位+区县+城乡分类代码" = 编码1 + 编码3

### 4.3 区域编码

| 类型 | 编码前缀 | 示例 |
|------|---------|------|
| 区县 | Q | Q1=城区, Q2=丹江口市, Q3=房县, ... |
| 市场类型 | M | M1=城网, M2=农网 |
| 城乡分类代码 | F | F1=主城区, F2=村庄, ... |
| 业态 | Y | Y1=便利店, Y2=其他, ... |
| 商圈类型 | S | S1=居民区, S2=集贸区, ... |
| 市场部 | B | B1=茅箭市场部, B2=白浪市场部, ... |
| 信用等级 | X | X1=AA, X2=C, ... |

### 4.4 标签编码

- "优质数据共享客户" → 编码后缀 `+a`
- 标签过滤值：0

## 五、测试用例生成策略更新

### 5.1 基础组合更新

**修正前**：16种基础组合
- 按档位投放 × 2种标签 = 2种
- 按档位扩展投放 × 5种单扩展 × 2种标签 = 10种
- 按档位扩展投放 × 2种双扩展 × 2种标签 = 4种

**修正后**：约20种基础组合
- 按档位投放 × 2种标签 = 2种
- 按档位扩展投放 × 5种单扩展 × 2种标签 = 10种
- 按档位扩展投放 × 2种双扩展 × 2种标签 = 4种
- 按价位段自选投放 × 2种扩展类型 × 2种标签 = 4种（新增）

### 5.2 区域数量分布更新

**修正前**：
- 所有投放方式都根据预投放量动态计算区域数量

**修正后**：
- **按档位投放**：100%为"全市"（regionCount=0）
- **按价位段自选投放**：100%为"全市"（regionCount=0）
- **按档位扩展投放**：根据预投放量动态计算（regionCount=1-7）

### 5.3 总用例数量

- **基础组合用例**：约20种组合 × 41个投放量样本 = **820个用例**
- **边界值用例**：7个
- **特殊场景用例**：5个（新增按价位段自选投放场景）

**总计**：约 **832个用例**

## 六、验证要点

### 6.1 数据验证SQL

```sql
-- 验证按档位投放的投放区域是否全部为"全市"
SELECT COUNT(*) AS total,
       COUNT(CASE WHEN DELIVERY_AREA = '全市' THEN 1 END) AS city_wide_count
FROM cigarette_distribution_info
WHERE YEAR = 2099 AND MONTH = 9 AND WEEK_SEQ = 1
  AND DELIVERY_METHOD = '按档位投放';

-- 验证按价位段自选投放的投放区域是否全部为"全市"
SELECT COUNT(*) AS total,
       COUNT(CASE WHEN DELIVERY_AREA = '全市' THEN 1 END) AS city_wide_count
FROM cigarette_distribution_info
WHERE YEAR = 2099 AND MONTH = 9 AND WEEK_SEQ = 1
  AND DELIVERY_METHOD = '按价位段自选投放';

-- 验证按档位扩展投放是否有扩展类型
SELECT COUNT(*) AS total,
       COUNT(CASE WHEN DELIVERY_ETYPE IS NOT NULL THEN 1 END) AS has_extension_count
FROM cigarette_distribution_info
WHERE YEAR = 2099 AND MONTH = 9 AND WEEK_SEQ = 1
  AND DELIVERY_METHOD = '按档位扩展投放';

-- 验证标签是否只有"优质数据共享客户"或NULL
SELECT DISTINCT TAG
FROM cigarette_distribution_info
WHERE YEAR = 2099 AND MONTH = 9 AND WEEK_SEQ = 1
  AND TAG IS NOT NULL;
```

## 七、注意事项

1. **按档位投放**：无论预投放量大小，`DELIVERY_AREA` 必须为"全市"，`DELIVERY_ETYPE` 必须为 `NULL`
2. **按价位段自选投放**：无论是否有扩展类型，`DELIVERY_AREA` 必须为"全市"
3. **按档位扩展投放**：`DELIVERY_ETYPE` 不能为 `NULL`，必须包含1-2个扩展类型
4. **标签**：最多1个，目前只有"优质数据共享客户"，标签过滤值为0
5. **区域名称**：确保与 `region_customer_statistics` 表中的区域名称一致

---

**总结**：测试用例生成器已根据业务规则修正，确保生成的用例符合编码规则表和业务约束。

