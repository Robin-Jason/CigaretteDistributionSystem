<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
  TemporaryCustomerTableMapper XML
  作用：动态临时表的创建、删除、查询。表名由调用方严格校验后传入。
-->
<mapper namespace="org.example.infrastructure.persistence.mapper.TemporaryCustomerTableMapper">

    <!-- 基于 base_customer_info 创建临时表 -->
    <update id="createTableFromBase">
        CREATE TABLE `${tableName}` AS
        SELECT * FROM `base_customer_info`
        <if test="whereClause != null and whereClause.trim() != ''">
            ${whereClause}
        </if>
    </update>

    <!-- 创建空表，结构同 base_customer_info -->
    <update id="createEmptyTable">
        CREATE TABLE `${tableName}` LIKE `base_customer_info`
    </update>

    <!-- 判断表是否存在 -->
    <select id="tableExists" resultType="long">
        SELECT COUNT(*) FROM information_schema.TABLES
        WHERE TABLE_SCHEMA = DATABASE()
          AND TABLE_NAME = #{tableName}
    </select>

    <!-- 删除临时表 -->
    <update id="dropTable">
        DROP TABLE IF EXISTS `${tableName}`
    </update>

    <!-- 统计临时表记录数 -->
    <select id="count" resultType="long">
        SELECT COUNT(*) FROM `${tableName}`
    </select>

    <!-- 设置表注释 -->
    <update id="setTableComment">
        ALTER TABLE `${tableName}` COMMENT = #{comment}
    </update>

    <!-- 获取表注释 -->
    <select id="getTableComment" resultType="string">
        SELECT TABLE_COMMENT FROM information_schema.TABLES
        WHERE TABLE_SCHEMA = DATABASE()
          AND TABLE_NAME = #{tableName}
    </select>

    <!-- 列出符合前缀的临时表 -->
    <select id="listTemporaryTables" resultType="string">
        SELECT TABLE_NAME FROM information_schema.TABLES
        WHERE TABLE_SCHEMA = DATABASE()
          AND TABLE_NAME LIKE CONCAT(#{prefix}, '%')
    </select>

    <!-- 查询临时表数据 -->
    <select id="query" resultType="map">
        SELECT
        <choose>
            <when test="columns != null and columns.size() > 0">
                <foreach collection="columns" item="col" separator=",">
                    `${col}`
                </foreach>
            </when>
            <otherwise>*</otherwise>
        </choose>
        FROM `${tableName}`
    </select>

    <!-- DISTINCT ORDER_CYCLE -->
    <select id="listOrderCycles" resultType="string">
        SELECT DISTINCT ORDER_CYCLE
        FROM `${tableName}`
        WHERE ORDER_CYCLE IS NOT NULL
    </select>

    <!-- 按指定列 DISTINCT 组合（忽略 NULL） -->
    <select id="listDistinctCombinations" resultType="map">
        SELECT DISTINCT
        <foreach collection="columns" item="col" separator=",">
            `${col}`
        </foreach>
        FROM `${tableName}`
        WHERE
        <foreach collection="columns" item="col" separator=" AND ">
            `${col}` IS NOT NULL
        </foreach>
    </select>

    <!-- 按条件统计 GRADE 分组客户数 -->
    <select id="statGrades" resultType="map">
        SELECT GRADE, COUNT(*) AS CUSTOMER_COUNT
        FROM `${tableName}`
        <where>
            <if test="filters != null">
                <foreach collection="filters.entrySet()" item="e">
                    AND `${e.key}` = #{e.value}
                </foreach>
            </if>
            <if test="tagColumn != null and tagOperator != null and tagValue != null">
                AND `${tagColumn}` ${tagOperator} #{tagValue}
            </if>
            <if test="orderCyclePattern != null and orderCyclePattern != ''">
                AND `ORDER_CYCLE` LIKE #{orderCyclePattern}
            </if>
        </where>
        GROUP BY GRADE
    </select>

</mapper>

