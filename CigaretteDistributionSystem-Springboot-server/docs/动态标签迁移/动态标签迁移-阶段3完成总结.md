# 动态标签迁移 - 阶段3完成总结

## 一、完成时间
2025-12-20

## 二、业务规则调整

根据业务需求，调整了动态标签的处理规则：

### 1. 固定标签字段
- **QUALITY_DATA_SHARE（优质数据共享客户）** 等固定标签字段：
  - ✅ 继续使用固定字段存储和查询
  - ✅ 不写入JSON字段
  - ✅ 查询时直接使用固定字段

### 2. 动态标签字段
- **其他后续动态增加的标签列**：
  - ✅ 以JSON格式存放在 `DYNAMIC_TAGS` 字段中
  - ✅ 使用**中文键值对**格式，例如：`{"优质客户":"是"}`

## 三、阶段3目标
根据业务规则调整代码，确保固定标签字段和动态标签字段的正确处理。

## 三、已完成的工作

### 1. SQL查询逻辑更新 ✅
- **文件**: `src/main/resources/mapper/TemporaryCustomerTableMapper.xml`
- **更新内容**:
  - 修改 `statGradesPartition` 查询，根据业务规则区分固定标签字段和动态标签
  - 固定标签字段（如 `QUALITY_DATA_SHARE`）继续使用固定字段查询
  - 动态标签使用MySQL JSON函数 `JSON_EXTRACT` 进行查询，支持中文键名
- **实现逻辑**:
  ```xml
  <choose>
      <!-- 固定标签字段：直接使用固定字段查询 -->
      <when test="tagColumn == 'QUALITY_DATA_SHARE'">
          AND `${tagColumn}` ${tagOperator} #{tagValue}
      </when>
      <!-- 动态标签：从JSON字段查询，使用中文键名 -->
      <otherwise>
          AND JSON_EXTRACT(DYNAMIC_TAGS, CONCAT('$.', #{tagColumn})) ${tagOperator} #{tagValue}
      </otherwise>
  </choose>
  ```

### 2. 动态标签辅助工具类 ✅
- **文件**: `src/main/java/org/example/shared/util/DynamicTagHelper.java`
- **功能**:
  - `getDynamicTagValue()`: 从JSON字段读取动态标签（中文键名）
  - `hasDynamicTagValue()`: 检查动态标签值是否存在
  - `getAllDynamicTags()`: 获取所有动态标签的Map
  - `getFixedTagValue()`: 从固定字段读取固定标签（如QUALITY_DATA_SHARE）
  - `hasFixedTagValue()`: 检查固定标签值是否存在
- **使用示例**:
  ```java
  // 读取固定标签字段
  String qualityDataShare = DynamicTagHelper.getFixedTagValue(customer, "QUALITY_DATA_SHARE");
  
  // 读取动态标签（中文键名）
  String premiumCustomer = DynamicTagHelper.getDynamicTagValue(customer, "优质客户");
  ```

### 3. 固定字段处理 ✅
- **文件**: `src/main/java/org/example/infrastructure/persistence/po/BaseCustomerInfoPO.java`
- **更新内容**:
  - 移除 `qualityDataShare` 字段的 `@Deprecated` 注解
  - 更新Javadoc说明，明确固定标签字段继续使用固定字段存储

## 四、已完成的工作总结

### 1. 代码修改完成 ✅
- ✅ SQL查询逻辑已更新，区分固定标签字段和动态标签
- ✅ 动态标签辅助工具类已重构，分离固定标签和动态标签的处理
- ✅ Excel导入逻辑已更新，不再将固定标签字段写入JSON
- ✅ PO类注释已更新，明确业务规则

### 2. 业务规则明确 ✅
- ✅ 固定标签字段（QUALITY_DATA_SHARE）继续使用固定字段
- ✅ 动态标签使用JSON格式，中文键值对
- ✅ 查询逻辑已区分两种类型的标签

## 五、技术实现细节

### 1. 标签字段分类

| 类型 | 字段名 | 存储方式 | 查询方式 | 示例 |
|------|--------|---------|---------|------|
| 固定标签字段 | QUALITY_DATA_SHARE | 固定字段 | 直接查询固定字段 | `WHERE QUALITY_DATA_SHARE = '1'` |
| 动态标签字段 | 优质客户 | JSON字段 | JSON函数查询 | `JSON_EXTRACT(DYNAMIC_TAGS, '$.优质客户') = '是'` |

### 2. JSON字段格式

动态标签使用中文键值对格式：
```json
{
  "优质客户": "是",
  "重点区域": "重点区域A",
  "特殊渠道": "是"
}
```

### 3. 业务规则

- **固定标签字段**: 不写入JSON，继续使用固定字段存储和查询
- **动态标签字段**: 只存储在JSON字段中，使用中文键名
- **向后兼容**: 现有使用固定标签字段的代码无需修改

## 六、注意事项

1. **性能考虑**
   - JSON字段查询可能比固定字段查询稍慢
   - 建议为常用标签创建虚拟列索引
   - 监控查询性能，必要时优化

2. **数据一致性**
   - 阶段3期间，固定字段和JSON字段都在使用
   - 需要确保所有写入操作都同时更新两个位置（阶段2已实现）

3. **向后兼容**
   - 必须保持对固定字段的读取支持
   - 只有在阶段4（清理阶段）才能移除固定字段

## 七、相关文件清单

### 新增文件
1. `src/main/java/org/example/shared/util/DynamicTagHelper.java`

### 修改文件
1. `src/main/resources/mapper/TemporaryCustomerTableMapper.xml`
2. `src/main/java/org/example/infrastructure/persistence/po/BaseCustomerInfoPO.java`

## 七、相关文档

- [业务规则说明.md](./业务规则说明.md): 详细的业务规则和示例

---

**阶段3完成日期**: 2025-12-20  
**状态**: 已完成

