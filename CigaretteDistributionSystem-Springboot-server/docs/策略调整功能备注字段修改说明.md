# 策略调整功能备注字段修改说明

## 修改日期
2025-12-23

## 修改内容

### 背景
策略调整与重算功能在写入预测分区表（`prediction` 或 `prediction_price`）新记录时，需要追加备注为"人工已确认投放组合与投放区域修改"，以便区分人工调整的记录和算法自动生成的记录。

### 修改文件
`src/main/java/org/example/application/service/adjust/impl/CigaretteStrategyAdjustServiceImpl.java`

### 具体修改

#### 1. 修改 `writeBackNewRecords` 方法
**修改前：**
```java
private void writeBackNewRecords(...) {
    String tagFilterConfig = buildTagFilterConfig(request);
    String remark = buildRemark(request);  // 使用 Info 表的备注格式
    
    if (isPriceBand) {
        priceBandWriteBackService.writeBackPriceBandAllocations(...);
    } else {
        standardWriteBackService.writeBackSingleCigarette(
            ..., remark, ...);  // 传入 Info 表格式的备注
    }
}
```

**修改后：**
```java
private void writeBackNewRecords(...) {
    String tagFilterConfig = buildTagFilterConfig(request);
    // 预测表记录的备注：人工已确认投放组合与投放区域修改
    String predictionRemark = "人工已确认投放组合与投放区域修改";
    
    if (isPriceBand) {
        priceBandWriteBackService.writeBackPriceBandAllocations(
            buildCandidatesFromResult(..., predictionRemark), ...);
    } else {
        standardWriteBackService.writeBackSingleCigarette(
            ..., predictionRemark, ...);  // 传入预测表专用备注
    }
}
```

#### 2. 修改 `buildCandidatesFromResult` 方法签名
**修改前：**
```java
private List<Map<String, Object>> buildCandidatesFromResult(
    AllocationAlgorithmSelector.AllocationResult calcResult,
    AdjustCigaretteStrategyRequestDto request,
    Map<String, Object> cigaretteInfo) {
    ...
    candidate.put("REMARK", buildRemark(request));  // 使用 Info 表格式
    ...
}
```

**修改后：**
```java
private List<Map<String, Object>> buildCandidatesFromResult(
    AllocationAlgorithmSelector.AllocationResult calcResult,
    AdjustCigaretteStrategyRequestDto request,
    Map<String, Object> cigaretteInfo,
    String predictionRemark) {  // 新增参数
    ...
    candidate.put("BZ", predictionRemark);  // 使用预测表专用备注
    ...
}
```

### 备注字段说明

策略调整功能现在会在两个地方写入不同的备注：

1. **Info 表（`cigarette_distribution_info`）的 `BZ` 字段**
   - 格式：`已人工调整策略{投放类型/扩展类型}（标签）`
   - 示例：`已人工调整策略按档位投放（优质数据共享客户）`
   - 用途：标识该卷烟的投放策略已被人工调整

2. **预测表（`prediction` 或 `prediction_price`）的 `BZ` 字段**
   - 固定值：`人工已确认投放组合与投放区域修改`
   - 用途：标识该分配记录是通过人工策略调整生成的，而非算法自动生成

### 数据流示例

当用户调整卷烟"红金龙(硬神州腾龙)"的投放策略时：

```json
{
  "cigCode": "42010020",
  "cigName": "红金龙(硬神州腾龙)",
  "newDeliveryMethod": "按档位投放",
  "newTag": "优质数据共享客户",
  "newTagFilterValue": "是",
  "newAdvAmount": 1000
}
```

**结果：**

1. `cigarette_distribution_info` 表更新：
   ```sql
   UPDATE cigarette_distribution_info 
   SET BZ = '已人工调整策略按档位投放（优质数据共享客户）'
   WHERE CIG_CODE = '42010020' AND CIG_NAME = '红金龙(硬神州腾龙)'
   ```

2. `cigarette_distribution_prediction` 表插入：
   ```sql
   INSERT INTO cigarette_distribution_prediction 
   (CIG_CODE, CIG_NAME, DELIVERY_AREA, BZ, ...)
   VALUES 
   ('42010020', '红金龙(硬神州腾龙)', '城区', '人工已确认投放组合与投放区域修改', ...),
   ('42010020', '红金龙(硬神州腾龙)', '郊区', '人工已确认投放组合与投放区域修改', ...),
   ...
   ```

### 影响范围

- **写回服务**：`StandardDistributionWriteBackService` 和 `PriceBandDistributionWriteBackService` 接收到的备注参数已更改
- **数据查询**：可以通过预测表的 `BZ` 字段筛选出所有人工调整的记录
- **向后兼容**：不影响现有的算法自动生成流程，只影响策略调整功能

### 测试建议

1. 测试标准投放类型的策略调整（写入 `prediction` 表）
2. 测试价位段投放类型的策略调整（写入 `prediction_price` 表）
3. 验证 Info 表和预测表的备注字段是否正确写入
4. 验证跨表调整（从标准投放改为价位段投放，或反之）

### 相关文件

- 服务实现：`CigaretteStrategyAdjustServiceImpl.java`
- 写回服务：`StandardDistributionWriteBackServiceImpl.java`
- 写回服务：`PriceBandDistributionWriteBackServiceImpl.java`
- 控制器：`DistributionCalculateController.java`
