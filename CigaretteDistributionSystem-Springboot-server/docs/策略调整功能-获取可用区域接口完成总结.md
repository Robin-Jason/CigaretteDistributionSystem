# 策略调整功能 - 获取可用区域接口完成总结

## 任务概述

为策略调整功能提供辅助接口，根据投放类型和扩展类型返回可选的区域列表。如果某些区域在 `region_customer_statistics` 表中不存在，系统会自动追加构建这些区域的客户数据。

## 完成内容

### 1. Service层实现

#### 接口定义
- **文件**：`src/main/java/org/example/application/service/region/GetAvailableRegionsService.java`
- **功能**：定义获取可用投放区域列表的服务接口

#### 实现类
- **文件**：`src/main/java/org/example/application/service/region/impl/GetAvailableRegionsServiceImpl.java`
- **核心逻辑**：
  1. 使用 `RegionRecordBuilder.buildRecordsForCombination()` 构建该投放组合的所有理论区域数据
  2. 查询 `region_customer_statistics` 表，找出已存在的区域
  3. 对比理论区域和已存在区域，找出缺失的区域
  4. 将缺失的区域数据批量插入到 `region_customer_statistics` 表
  5. 返回完整的区域列表和构建信息

### 2. DTO层

#### 请求DTO
- **文件**：`src/main/java/org/example/application/dto/allocation/GetAvailableRegionsRequestDto.java`
- **字段**：
  - `year`：年份（必填）
  - `month`：月份（必填）
  - `weekSeq`：周序号（必填）
  - `deliveryMethod`：投放类型（必填）
  - `deliveryEtype`：扩展类型（可选）

#### 响应DTO
- **文件**：`src/main/java/org/example/application/dto/allocation/GetAvailableRegionsResponseDto.java`
- **字段**：
  - `success`：是否成功
  - `message`：消息
  - `availableRegions`：可用区域列表
  - `hasBuiltNewData`：是否构建了新数据
  - `builtRegions`：构建的区域列表

### 3. Controller层

#### 新增端点
- **文件**：`src/main/java/org/example/api/web/controller/DistributionCalculateController.java`
- **端点**：`POST /api/calculate/available-regions`
- **功能**：接收前端请求，调用Service层，返回统一格式的API响应

### 4. VO层

#### 请求VO
- **文件**：`src/main/java/org/example/api/web/vo/request/GetAvailableRegionsRequestVo.java`
- **验证**：使用 `@NotNull`、`@Min`、`@Max` 等注解进行参数校验

#### 响应VO
- **文件**：`src/main/java/org/example/api/web/vo/response/GetAvailableRegionsResponseVo.java`
- **字段**：与DTO层对应

### 5. Converter层

- **文件**：`src/main/java/org/example/api/web/converter/GetAvailableRegionsConverter.java`
- **功能**：使用 MapStruct 实现 VO 和 DTO 之间的转换

### 6. 文档

- **文件**：`docs/获取可用投放区域列表功能说明.md`
- **内容**：
  - 功能概述
  - 业务场景
  - 接口定义（请求/响应参数、示例）
  - 实现逻辑
  - 投放类型与区域的对应关系
  - 使用示例
  - 注意事项
  - 相关文件
  - 测试建议

## 技术特性

### 1. 增量追加构建

- 只构建缺失的区域，不影响已存在的数据
- 避免重复构建，提高性能

### 2. 事务保证

- 使用 `@Transactional` 注解确保数据一致性
- 要么全部成功，要么全部失败

### 3. 自动补全

- 前端无需关心数据是否存在
- 接口自动检查并补全缺失的区域数据

### 4. 统一响应格式

- 使用 `ApiResponseVo` 统一封装响应
- 包含 `code`、`message`、`data` 字段

## 接口示例

### 请求示例

```json
POST /api/calculate/available-regions

{
  "year": 2025,
  "month": 9,
  "weekSeq": 3,
  "deliveryMethod": "按档位投放",
  "deliveryEtype": "区县公司+市场类型"
}
```

### 响应示例（追加构建场景）

```json
{
  "code": "SUCCESS",
  "message": "成功追加构建 2 个区域的客户数据",
  "data": {
    "success": true,
    "message": "成功追加构建 2 个区域的客户数据",
    "availableRegions": [
      "丹江（城网）",
      "丹江（农网）",
      "郧西（城网）",
      "郧西（农网）"
    ],
    "hasBuiltNewData": true,
    "builtRegions": [
      "郧西（城网）",
      "郧西（农网）"
    ]
  }
}
```

## 与策略调整功能的集成

### 前端调用流程

1. 用户在策略调整界面选择新的投放类型和扩展类型
2. 前端调用 `/api/calculate/available-regions` 接口获取可用区域列表
3. 前端展示区域列表供用户选择（下拉框或多选框）
4. 用户选择区域后，调用 `/api/calculate/adjust-strategy` 接口提交策略调整请求

### 数据流

```
用户选择投放类型/扩展类型
    ↓
调用 /api/calculate/available-regions
    ↓
GetAvailableRegionsService.getAvailableRegions()
    ↓
RegionRecordBuilder.buildRecordsForCombination()
    ↓
查询 region_customer_statistics 表
    ↓
找出缺失的区域
    ↓
批量插入缺失的区域数据
    ↓
返回完整的区域列表
    ↓
前端展示区域选项
    ↓
用户选择区域并提交策略调整
```

## 编译状态

✅ **编译成功**

```bash
mvn clean compile -DskipTests
```

- 所有文件编译通过
- 无错误，仅有一个 MapStruct 警告（可忽略）

## 测试建议

### 单元测试

1. **全市投放场景**
   - 投放类型：`按档位投放`
   - 扩展类型：`null`
   - 预期区域：`["全市"]`

2. **单扩展投放场景**
   - 投放类型：`按档位投放`
   - 扩展类型：`区县公司`
   - 预期区域：`["丹江", "郧西", "郧阳", ...]`

3. **双扩展投放场景**
   - 投放类型：`按档位投放`
   - 扩展类型：`区县公司+市场类型`
   - 预期区域：`["丹江（城网）", "丹江（农网）", ...]`

4. **所有区域已存在**
   - 预期：`hasBuiltNewData = false`，`builtRegions = []`

5. **部分区域缺失**
   - 预期：`hasBuiltNewData = true`，`builtRegions` 包含缺失的区域

6. **所有区域缺失**
   - 预期：`hasBuiltNewData = true`，`builtRegions` 包含所有理论区域

### 集成测试

1. 测试与策略调整功能的集成
2. 测试事务回滚场景
3. 测试并发调用场景

## 相关文件清单

### Service层
- `src/main/java/org/example/application/service/region/GetAvailableRegionsService.java`
- `src/main/java/org/example/application/service/region/impl/GetAvailableRegionsServiceImpl.java`

### DTO层
- `src/main/java/org/example/application/dto/allocation/GetAvailableRegionsRequestDto.java`
- `src/main/java/org/example/application/dto/allocation/GetAvailableRegionsResponseDto.java`

### Controller层
- `src/main/java/org/example/api/web/controller/DistributionCalculateController.java`（修改）

### VO层
- `src/main/java/org/example/api/web/vo/request/GetAvailableRegionsRequestVo.java`
- `src/main/java/org/example/api/web/vo/response/GetAvailableRegionsResponseVo.java`

### Converter层
- `src/main/java/org/example/api/web/converter/GetAvailableRegionsConverter.java`

### 文档
- `docs/获取可用投放区域列表功能说明.md`
- `docs/策略调整功能-获取可用区域接口完成总结.md`（本文件）

## 后续工作

### 可选优化

1. **缓存优化**
   - 对于相同的投放组合，可以缓存理论区域列表
   - 减少重复计算

2. **异步构建**
   - 如果缺失区域较多，可以考虑异步构建
   - 返回任务ID，前端轮询查询构建状态

3. **批量查询优化**
   - 如果前端需要查询多个投放组合的区域列表
   - 可以提供批量查询接口

### 测试工作

1. 编写单元测试
2. 编写集成测试
3. 进行性能测试

## 总结

本次任务完成了获取可用投放区域列表的辅助接口，为策略调整功能提供了完整的区域选择支持。接口实现了自动追加构建缺失区域数据的功能，确保前端始终能获取到完整的区域列表。

核心特性：
- ✅ 增量追加构建
- ✅ 事务保证
- ✅ 自动补全
- ✅ 统一响应格式
- ✅ 完整文档

代码质量：
- ✅ 编译通过
- ✅ 符合DDD分层架构
- ✅ 使用MapStruct进行VO/DTO转换
- ✅ 使用事务保证数据一致性
- ✅ 完善的日志记录

文档完整性：
- ✅ 功能说明文档
- ✅ 接口定义和示例
- ✅ 实现逻辑说明
- ✅ 使用示例
- ✅ 测试建议

## 版本历史

- **v1.0** (2025-12-23)
  - 初始版本
  - 完成获取可用投放区域列表接口
  - 支持自动追加构建缺失的区域数据
